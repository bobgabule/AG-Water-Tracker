---
phase: 08-subscription-gating
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/AddUserModal.tsx
autonomous: true

must_haves:
  truths:
    - "When admin seats are full, the Admin role button is disabled with a visual indicator"
    - "When meter_checker seats are full, the Meter Checker role button is disabled with a visual indicator"
    - "When ALL limited roles are full, a 'Contact us to upgrade' placeholder message appears"
    - "If the currently selected role becomes full, selection auto-switches to an available role (or disables submit)"
    - "Pending invites count toward the limit (submitting an invite for a full role is blocked)"
  artifacts:
    - path: "src/components/AddUserModal.tsx"
      provides: "Role blocking when seats full + upgrade placeholder"
      contains: "useSeatUsage"
  key_links:
    - from: "src/components/AddUserModal.tsx"
      to: "src/hooks/useSeatUsage.ts"
      via: "hook import and call"
      pattern: "import.*useSeatUsage.*from.*useSeatUsage"
    - from: "src/components/AddUserModal.tsx"
      to: "src/lib/subscription.ts"
      via: "optional import for type or constant"
      pattern: "import.*from.*subscription"
---

<objective>
Block invite form role selection when seats are full and show an upgrade placeholder.

Purpose: Satisfies SUBS-02 (invite blocked with message when seat limit reached) and SUBS-03 (no Stripe -- "Contact us to upgrade" placeholder). When a role is at capacity, its button in the invite form is disabled and annotated. When all roles are full, the entire form shows an upgrade placeholder.

Output: Modified AddUserModal.tsx with seat-aware role selection and upgrade placeholder
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-subscription-gating/08-01-SUMMARY.md
@src/components/AddUserModal.tsx
@src/hooks/useSeatUsage.ts
@src/lib/subscription.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add seat-aware role blocking to invite form</name>
  <files>src/components/AddUserModal.tsx</files>
  <action>
Modify `src/components/AddUserModal.tsx` to integrate seat usage checks into the role selection UI.

Changes:

1. Import `useSeatUsage` from `../hooks/useSeatUsage`.

2. Call `const seatUsage = useSeatUsage();` at the top of the component.

3. Derive seat-full booleans:
```typescript
const adminFull = seatUsage?.admin.isFull ?? false;
const meterCheckerFull = seatUsage?.meter_checker.isFull ?? false;
const allSeatsFull = adminFull && meterCheckerFull;
```

4. Auto-correct selected role: If the currently selected role is full but the other is not, auto-switch. Add a `useEffect` (import it) that runs when seatUsage changes:
```typescript
useEffect(() => {
  if (!seatUsage) return;
  if (role === 'admin' && adminFull && !meterCheckerFull) {
    setRole('meter_checker');
  } else if (role === 'meter_checker' && meterCheckerFull && !adminFull) {
    setRole('admin');
  }
}, [seatUsage, role, adminFull, meterCheckerFull]);
```
Note: The admin role auto-switch only matters when `canSelectAdmin` is true, but the setRole is harmless regardless since the UI will show the correct state.

5. Modify the role selection buttons. For the `canSelectAdmin` branch (the two-button toggle), disable each button when its role is full and add a "(Full)" label:

For the Meter Checker button:
- Add `disabled={meterCheckerFull}` attribute
- When `meterCheckerFull`, append text: " (Full)" after "Meter Checker"
- Add disabled styling: `disabled:opacity-50 disabled:cursor-not-allowed` to className

For the Admin button:
- Add `disabled={adminFull}` attribute
- When `adminFull`, append text: " (Full)" after "Admin"
- Add disabled styling: `disabled:opacity-50 disabled:cursor-not-allowed` to className

For the non-canSelectAdmin branch (admin sees only Meter Checker as read-only text), if meterCheckerFull, change the display text to "Meter Checker (Full)".

6. When `allSeatsFull` is true, show an upgrade placeholder INSTEAD of the form fields. Place this inside the body section, replacing the form content when all seats full:

```tsx
{allSeatsFull ? (
  <div className="py-8 text-center">
    <p className="text-white font-medium mb-2">All seats are filled</p>
    <p className="text-white/70 text-sm mb-4">
      Your plan allows {seatUsage?.admin.limit ?? 0} admin and {seatUsage?.meter_checker.limit ?? 0} meter checkers.
    </p>
    <p className="text-yellow-300 text-sm font-medium">
      Contact us to upgrade your plan
    </p>
  </div>
) : (
  // existing form content (name inputs, phone, role selection)
)}
```

7. Also disable the "Send Invite" button when `allSeatsFull` is true or when the currently selected role is full. Add to the existing disabled condition on the submit button:
```typescript
disabled={loading || !onboardingStatus?.farmId || (role === 'admin' ? adminFull : meterCheckerFull)}
```

Keep all existing AddUserModal functionality intact: phone formatting, validation, RPC call, SMS attempt, success state, error handling. Do NOT add Stripe links or payment processing per SUBS-03.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify the component still renders without crashing. Test scenarios: (1) when roles have available seats, form works normally; (2) when one role is full, that button is disabled; (3) when all roles full, upgrade placeholder shows.</verify>
  <done>Invite form disables full-role buttons with "(Full)" label, shows "Contact us to upgrade" when all seats full, auto-switches selected role away from full role, blocks submit for full roles</done>
</task>

</tasks>

<verification>
- `npx tsc -b --noEmit` passes
- AddUserModal imports and uses useSeatUsage
- Role buttons show "(Full)" and are disabled when at capacity
- All-seats-full state shows upgrade placeholder instead of form
- Submit button disabled when selected role is full
- No Stripe or payment integration (SUBS-03 compliance)
- Existing invite flow unchanged when seats are available
</verification>

<success_criteria>
- Admin role button disabled with "(Full)" when admin seat limit reached
- Meter Checker role button disabled with "(Full)" when meter_checker limit reached
- "Contact us to upgrade your plan" message shows when all roles full
- Selected role auto-corrects if current selection becomes full
- Send Invite button disabled when selected role is full
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-subscription-gating/08-03-SUMMARY.md`
</output>
