---
phase: 08-subscription-gating
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/subscription.ts
  - src/hooks/useSeatUsage.ts
autonomous: true

must_haves:
  truths:
    - "Subscription plan limits are defined as hardcoded constants (no DB table)"
    - "Default plan allows 1 admin + 3 meter checkers"
    - "Grower and super_admin are exempt from seat counting"
    - "Seat usage counts active (non-disabled) members AND pending invites per role"
    - "Disabled members do NOT count toward limits"
  artifacts:
    - path: "src/lib/subscription.ts"
      provides: "Plan definition constants and types"
      exports: ["PLAN_LIMITS", "PlanLimits", "RoleSeatInfo"]
    - path: "src/hooks/useSeatUsage.ts"
      provides: "Hook returning per-role seat usage with limit info"
      exports: ["useSeatUsage", "SeatUsage"]
  key_links:
    - from: "src/hooks/useSeatUsage.ts"
      to: "src/lib/subscription.ts"
      via: "imports PLAN_LIMITS"
      pattern: "import.*PLAN_LIMITS.*from.*subscription"
    - from: "src/hooks/useSeatUsage.ts"
      to: "farm_members + farm_invites"
      via: "PowerSync useQuery"
      pattern: "useQuery.*farm_members|useQuery.*farm_invites"
---

<objective>
Create the subscription plan constants and seat counting hook that all downstream UI depends on.

Purpose: Establishes the data layer for seat gating -- plan limits as hardcoded constants (per user decision: no DB table) and a reusable hook that counts active members + pending invites per role against those limits.

Output: Two new files -- src/lib/subscription.ts (constants/types) and src/hooks/useSeatUsage.ts (hook)
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/lib/permissions.ts
@src/hooks/useUserRole.ts
@src/pages/UsersPage.tsx
@src/components/PendingInvitesList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription plan constants and types</name>
  <files>src/lib/subscription.ts</files>
  <action>
Create `src/lib/subscription.ts` with hardcoded plan definition constants.

Per user decision: hardcoded constants, no DB table, no migration. Default plan: 1 admin + 3 meter checkers. Grower and super_admin are exempt from limits.

Define types and constants:

```typescript
// Types
export interface RoleSeatInfo {
  limit: number;       // max seats for this role
  label: string;       // display name (e.g., "Meter Checkers")
}

export interface PlanLimits {
  name: string;        // plan display name
  seats: Record<string, RoleSeatInfo>;  // keyed by role string
}

// Default plan constants
export const PLAN_LIMITS: PlanLimits = {
  name: 'Basic',
  seats: {
    admin: { limit: 1, label: 'Admins' },
    meter_checker: { limit: 3, label: 'Meter Checkers' },
  },
};

// Roles that are exempt from seat counting (not limited)
export const EXEMPT_ROLES = ['grower', 'super_admin'] as const;

// Helper: check if a role is seat-limited
export function isSeatLimited(role: string): boolean {
  return role in PLAN_LIMITS.seats;
}
```

Do NOT create a DB migration or table. Do NOT add Stripe or payment types. This is UI-only gating per SUBS-03.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify the file exports PLAN_LIMITS, PlanLimits, RoleSeatInfo, EXEMPT_ROLES, isSeatLimited.</verify>
  <done>subscription.ts exists with hardcoded plan (1 admin + 3 meter checkers), types exported, compiles clean</done>
</task>

<task type="auto">
  <name>Task 2: Create useSeatUsage hook</name>
  <files>src/hooks/useSeatUsage.ts</files>
  <action>
Create `src/hooks/useSeatUsage.ts` that queries farm_members and farm_invites via PowerSync to compute seat usage per role.

Follow existing hook patterns (see useUserRole.ts): useQuery + useMemo, guard empty queries with `'SELECT NULL WHERE 0'`.

The hook should:

1. Accept no arguments (gets farmId from useAuth().onboardingStatus.farmId)
2. Query active (non-disabled) farm_members grouped by role: `SELECT role, COUNT(*) as count FROM farm_members WHERE farm_id = ? AND is_disabled = 0 GROUP BY role`
3. Query pending invites (not expired, not used) grouped by role: `SELECT role, COUNT(*) as count FROM farm_invites WHERE farm_id = ? AND uses_count = 0 AND expires_at > ? GROUP BY role` -- pass `new Date().toISOString()` as the expiry param
4. Combine the two counts per role and compare against PLAN_LIMITS

Return type:

```typescript
export interface SeatUsage {
  admin: { used: number; limit: number; available: number; isFull: boolean };
  meter_checker: { used: number; limit: number; available: number; isFull: boolean };
}
```

Where `used` = active members with that role + pending invites for that role. `limit` comes from PLAN_LIMITS. `available` = max(0, limit - used). `isFull` = used >= limit.

IMPORTANT patterns:
- Use `useQuery<{role: string; count: number}>()` from `@powersync/react`
- Memoize the final SeatUsage object with `useMemo` depending on both query data arrays
- Guard with `'SELECT NULL WHERE 0'` when farmId is null
- Do NOT count disabled members (is_disabled = 1) -- they are excluded by the WHERE clause
- Do NOT count expired invites or used invites (uses_count >= 1)
- Grower and super_admin members are NOT counted (they are exempt per EXEMPT_ROLES)
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Import the hook in a temp file or check exports are correct.</verify>
  <done>useSeatUsage hook exists, queries both farm_members and farm_invites, returns SeatUsage with used/limit/available/isFull per role, compiles clean</done>
</task>

</tasks>

<verification>
- `npx tsc -b --noEmit` passes with zero errors
- src/lib/subscription.ts exports PLAN_LIMITS with admin.limit=1, meter_checker.limit=3
- src/hooks/useSeatUsage.ts exports useSeatUsage returning SeatUsage type
- Both files follow project conventions (no console.log, proper TypeScript types)
</verification>

<success_criteria>
- subscription.ts defines Basic plan: 1 admin + 3 meter checkers, grower/super_admin exempt
- useSeatUsage hook counts active members + pending invites per role against limits
- Disabled members excluded from counts
- Expired/used invites excluded from counts
- All types exported for downstream use by plans 08-02 and 08-03
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-subscription-gating/08-01-SUMMARY.md`
</output>
