---
phase: 26-service-worker-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - src/pages/auth/PhonePage.tsx
autonomous: true
requirements:
  - SW-01
  - SW-02
  - SW-03

must_haves:
  truths:
    - "Navigation preload is enabled so SW boot and navigation fetch happen in parallel"
    - "All lazy-loaded page chunks plus the WebP auth background are precached by the service worker after first visit"
    - "Opening the login page offline shows the full auth shell (background, logo, form) with an amber offline banner instead of a browser error page"
    - "Phone input and Send Code button are disabled while offline"
    - "Amber banner auto-dismisses with a fade when connectivity returns and form re-enables"
  artifacts:
    - path: "vite.config.ts"
      provides: "Workbox config with navigationPreload and webp in globPatterns"
      contains: "navigationPreload"
    - path: "src/pages/auth/PhonePage.tsx"
      provides: "Offline banner UI and disabled form state"
      contains: "offline"
  key_links:
    - from: "vite.config.ts"
      to: "service worker (generated)"
      via: "vite-plugin-pwa generateSW strategy"
      pattern: "navigationPreload.*true"
    - from: "src/pages/auth/PhonePage.tsx"
      to: "src/hooks/useOnlineStatus.ts"
      via: "useOnlineStatus hook drives banner visibility and input disabled state"
      pattern: "isOnline"
---

<objective>
Configure the service worker for intelligent caching and provide a usable offline auth experience.

Purpose: After this plan, the service worker precaches all app chunks (including the WebP auth background), enables navigation preload for faster page loads, and the login page gracefully handles offline state with an amber banner and disabled form instead of showing a browser error page.

Output: Updated vite.config.ts with Workbox configuration, updated PhonePage.tsx with offline banner UI.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-service-worker-intelligence/26-CONTEXT.md
@vite.config.ts
@src/pages/auth/PhonePage.tsx
@src/hooks/useOnlineStatus.ts
@src/components/auth/AuthLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Workbox for navigation preload and full precaching</name>
  <files>vite.config.ts</files>
  <action>
In the VitePWA `workbox` config object in vite.config.ts, make these two changes:

1. **Add `navigationPreload: true`** — this enables the Navigation Preload API so the service worker boot and navigation fetch happen in parallel, eliminating the cold-start delay.

2. **Add `webp` to the globPatterns** — change `'**/*.{js,css,html,ico,png,svg,woff2,wasm}'` to `'**/*.{js,css,html,ico,png,svg,woff2,wasm,webp}'`. This ensures the auth background image (bg-farm.webp, ~229KB) is precached by the service worker, so the login page looks identical when opened offline.

No other changes needed. The existing `generateSW` strategy with `autoUpdate` registration already handles:
- Precaching all lazy-loaded page chunks (SW-02)
- Serving cached assets on subsequent visits
- The 5MB maximumFileSizeToCacheInBytes limit
- Runtime caching for Mapbox tiles

Do NOT add a custom offline fallback page — the SPA shell (index.html) is already precached and React Router handles routing to the login page for unauthenticated offline users (per CONTEXT.md decision).
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Inspect vite.config.ts: workbox.navigationPreload is true, globPatterns includes webp</manual>
  </verify>
  <done>vite.config.ts has navigationPreload: true and webp in globPatterns. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add offline banner and disabled form state to PhonePage</name>
  <files>src/pages/auth/PhonePage.tsx</files>
  <action>
Add an amber offline banner to PhonePage.tsx and disable form controls when offline. The `useOnlineStatus` hook is already imported and used as `isOnline`.

**Banner placement:** Between the "Sign In" h1 heading and the `<form>` element. This matches the CONTEXT.md decision: "Banner placement: between logo and form card, within the normal AuthLayout content flow" (the h1 is inside the AuthLayout content card, so between h1 and form is correct).

**Banner markup:**
```tsx
{!isOnline && (
  <div
    className="bg-amber-600/80 border border-amber-400/50 text-amber-50 text-sm rounded-lg p-3 mb-4 text-center transition-all duration-500"
    role="alert"
  >
    You're offline — connect to sign in
  </div>
)}
```

Use `role="alert"` for accessibility (screen readers announce it). Use `transition-all duration-500` for the fade effect — when `isOnline` switches from false to true, React removes the element, and the CSS transition on opacity/max-height provides a smooth dismissal. However, since React conditional rendering unmounts immediately, wrap the banner in a more robust approach:

**Fade-out approach:** Use a local state `showBanner` that tracks offline with a delayed hide:
1. Add state: `const [showBanner, setShowBanner] = useState(!isOnline);`
2. Add effect that responds to `isOnline`:
   - When `!isOnline` -> `setShowBanner(true)` immediately
   - When `isOnline` && `showBanner` -> wait 500ms, then `setShowBanner(false)` (allows CSS fade to complete)
3. Render banner when `showBanner` is true, with opacity class: `isOnline ? 'opacity-0 max-h-0 mb-0 p-0 border-0 overflow-hidden' : 'opacity-100 max-h-20'`

This gives a smooth fade-out when connectivity returns, then unmounts after the transition.

**Disable input and button when offline:**
- Phone input: add `disabled={loading || !isOnline}` (currently only `disabled={loading}`)
- Submit button: add `disabled={loading || !isOnline}` (currently only `disabled={loading}`)
- The disabled styling is already handled by the existing `disabled:opacity-50 disabled:cursor-not-allowed` classes on the button

Do NOT modify AuthLayout.tsx — the banner goes inside PhonePage only.
Do NOT add an offline banner to VerifyPage — per CONTEXT.md: "Only PhonePage gets the offline banner — VerifyPage uses existing error handling for mid-OTP offline"
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>
1. Run `npx vite build` and verify service worker is generated
2. Serve the built app and verify login page works normally online
3. Go offline in DevTools Network tab, refresh the login page — should show full auth layout with amber "You're offline" banner and disabled input/button
4. Go back online — banner should fade out smoothly and form should re-enable
    </manual>
  </verify>
  <done>PhonePage shows an amber offline banner between the heading and form when offline, phone input and submit button are disabled, and the banner fades out smoothly when connectivity returns. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. `npx vite build` completes successfully and generates a service worker file in dist/
3. vite.config.ts contains `navigationPreload: true` in workbox config
4. vite.config.ts globPatterns includes `webp` extension
5. PhonePage.tsx shows amber offline banner when `isOnline` is false
6. PhonePage.tsx disables phone input and submit button when offline
7. Banner has role="alert" for accessibility
8. Banner fades out when connectivity returns (CSS transition + delayed unmount)
</verification>

<success_criteria>
- Navigation preload is enabled in the generated service worker
- All app chunks plus the WebP auth background are in the precache manifest
- Login page opened offline shows the full auth shell with amber "You're offline" banner
- Phone input and Send Code button are disabled while offline
- Reconnecting causes banner to fade out and form to re-enable
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-service-worker-intelligence/26-01-SUMMARY.md`
</output>
