---
phase: 31-simplify-invite-user-flow-with-seat-limits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/powersync-schema.ts
  - src/hooks/useSeatUsage.ts
  - supabase/functions/send-invite-sms/index.ts
  - src/pages/NoSubscriptionPage.tsx
  - src/components/AddUserModal.tsx
autonomous: true
requirements:
  - TIER-D1

must_haves:
  truths:
    - "PowerSync schema includes extra_admin_seats and extra_meter_checker_seats on farms table"
    - "Seat usage calculation adds extra seats from the farm to the tier limit"
    - "SMS invite message instructs user to sign in with their phone number at the app URL"
    - "No-subscription page shows 'No Farm Access' heading with helpful guidance text"
    - "Seat limit server error from RPC is displayed in the AddUserModal"
  artifacts:
    - path: "src/lib/powersync-schema.ts"
      provides: "Extra seat columns in farms TableV2"
      contains: "extra_admin_seats"
    - path: "src/hooks/useSeatUsage.ts"
      provides: "Updated calcRole accepting extraSeats"
      contains: "extraSeats"
    - path: "supabase/functions/send-invite-sms/index.ts"
      provides: "Updated SMS message with sign-in instruction"
      contains: "Sign in with this phone number"
    - path: "src/pages/NoSubscriptionPage.tsx"
      provides: "Updated heading and body text"
      contains: "No Farm Access"
    - path: "src/components/AddUserModal.tsx"
      provides: "Seat limit error handling"
      contains: "no available"
  key_links:
    - from: "src/hooks/useSeatUsage.ts"
      to: "src/lib/powersync-schema.ts"
      via: "farms query for extra seat columns"
      pattern: "extra_admin_seats|extra_meter_checker_seats"
    - from: "src/components/AddUserModal.tsx"
      to: "supabase RPC"
      via: "Error message parsing for seat limit"
      pattern: "no available"
---

<objective>
Update the frontend PowerSync schema, seat usage hook, SMS message, NoSubscriptionPage text, and AddUserModal error handling to support server-side seat limits and improve UX messaging.

Purpose: Ensures the client-side schema matches new DB columns, seat calculations include per-farm extra seats, SMS messages are instructive, the no-subscription page is welcoming, and server-side seat limit errors are surfaced to users.

Output: Updated schema, hook, edge function, and two UI components.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/powersync-schema.ts
@src/hooks/useSeatUsage.ts
@supabase/functions/send-invite-sms/index.ts
@src/pages/NoSubscriptionPage.tsx
@src/components/AddUserModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PowerSync schema and seat usage hook</name>
  <files>src/lib/powersync-schema.ts, src/hooks/useSeatUsage.ts</files>
  <action>
**PowerSync schema** (`src/lib/powersync-schema.ts`):

Add two columns to the `farms` TableV2 definition (after `zip_code` line, before `created_at`):
```typescript
extra_admin_seats: column.integer,
extra_meter_checker_seats: column.integer,
```

PowerSync uses INTEGER type (not BOOLEAN). These map to the new `farms.extra_admin_seats` and `farms.extra_meter_checker_seats` columns added in migration 039.

**Seat usage hook** (`src/hooks/useSeatUsage.ts`):

1. Add a PowerSync query to fetch the farm's extra seat columns. After the existing `useActiveFarm()` and `useSubscriptionTier()` calls, add:
   ```typescript
   const farmQuery = farmId
     ? 'SELECT extra_admin_seats, extra_meter_checker_seats FROM farms WHERE id = ?'
     : 'SELECT NULL WHERE 0';
   const farmParams = farmId ? [farmId] : [];
   const { data: farmData } = useQuery<{ extra_admin_seats: number; extra_meter_checker_seats: number }>(
     farmQuery,
     farmParams
   );
   ```

2. Inside the `useMemo`, extract extra seats from farmData:
   ```typescript
   const extraAdminSeats = farmData[0]?.extra_admin_seats ?? 0;
   const extraMeterCheckerSeats = farmData[0]?.extra_meter_checker_seats ?? 0;
   ```

3. Update the `calcRole` function to accept an `extraSeats` parameter:
   ```typescript
   function calcRole(role: string, tierLimit: number, extraSeats: number): RoleSeatUsage {
     const members = memberCounts.get(role) ?? 0;
     const invites = inviteCounts.get(role) ?? 0;
     const used = members + invites;
     const limit = tierLimit + extraSeats;
     const available = Math.max(0, limit - used);
     const isFull = used >= limit;
     return { used, limit, available, isFull };
   }
   ```

4. Update the return statement to pass extra seats:
   ```typescript
   return {
     admin: calcRole('admin', tier?.maxAdmins ?? 0, extraAdminSeats),
     meter_checker: calcRole('meter_checker', tier?.maxMeterCheckers ?? 0, extraMeterCheckerSeats),
   };
   ```

5. Add `farmData` to the useMemo dependency array: `[membersData, invitesData, tier, farmData]`
  </action>
  <verify>
    <automated>npx tsc -b --noEmit 2>&1 | findstr /C:"error" || echo "No type errors"</automated>
    <manual>Verify extra seat columns appear in powersync-schema.ts farms table and useSeatUsage uses them</manual>
  </verify>
  <done>PowerSync farms table has extra_admin_seats and extra_meter_checker_seats columns. useSeatUsage queries farm's extra seats and adds them to tier limits in calcRole.</done>
</task>

<task type="auto">
  <name>Task 2: Update SMS message, NoSubscriptionPage, and AddUserModal error handling</name>
  <files>supabase/functions/send-invite-sms/index.ts, src/pages/NoSubscriptionPage.tsx, src/components/AddUserModal.tsx</files>
  <action>
**SMS message** (`supabase/functions/send-invite-sms/index.ts`):

Update the message construction (lines 37-39) to include a sign-in instruction:
```typescript
const message = farmName
  ? `You've been invited to join "${farmName}" on AG Water Tracker. Sign in with this phone number at: ${APP_URL}`
  : `You've been invited to AG Water Tracker. Sign in with this phone number at: ${APP_URL}`;
```

The key change: replace "Tap here to get started" with "Sign in with this phone number at" -- this clearly instructs the user what to do.

**NoSubscriptionPage** (`src/pages/NoSubscriptionPage.tsx`):

1. Change the heading (line 74-75) from:
   ```
   No Active Subscription
   ```
   to:
   ```
   No Farm Access
   ```

2. Change the body text (lines 78-80) from:
   ```
   Your account has no active farm subscription.
   ```
   to:
   ```
   Your phone number is not associated with any farm. Ask your farm administrator to add you, or subscribe to create your own farm.
   ```

Keep the phone display, subscription link, and sign-out button unchanged.

**AddUserModal error handling** (`src/components/AddUserModal.tsx`):

In the catch block (lines 125-137), add a new case for seat limit errors. After the `msg.includes('already exists')` check and before the `else` fallback, add:
```typescript
} else if (msg.includes('no available')) {
  message = err.message;
}
```

This catches the server's "No available X seats. Your plan allows Y (Z active, W pending)." message from migration 039 and displays it directly, since it's already user-friendly and descriptive.

The full error handling block should be:
```typescript
if (msg.includes('already a member')) {
  message = 'This person is already a member of your farm';
} else if (msg.includes('already exists')) {
  message = 'An invite for this phone number already exists';
} else if (msg.includes('no available')) {
  message = err.message;
} else {
  message = err.message;
}
```
  </action>
  <verify>
    <automated>npx tsc -b --noEmit 2>&1 | findstr /C:"error" || echo "No type errors"</automated>
    <manual>Check SMS message includes "Sign in with this phone number", NoSubscriptionPage heading says "No Farm Access", AddUserModal catches seat limit errors</manual>
  </verify>
  <done>SMS message instructs user to sign in with their phone number. NoSubscriptionPage heading is "No Farm Access" with descriptive body text. AddUserModal displays server seat limit error messages directly.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. `src/lib/powersync-schema.ts` farms table has `extra_admin_seats: column.integer` and `extra_meter_checker_seats: column.integer`
3. `src/hooks/useSeatUsage.ts` queries farm extra seats and passes them to calcRole
4. `supabase/functions/send-invite-sms/index.ts` message contains "Sign in with this phone number at"
5. `src/pages/NoSubscriptionPage.tsx` heading is "No Farm Access"
6. `src/components/AddUserModal.tsx` catch block handles `'no available'` substring
</verification>

<success_criteria>
- TypeScript compilation passes with zero errors
- PowerSync schema declares both extra seat columns as integer type
- Seat usage hook fetches farm's extra seats and adds them to tier limits
- SMS message clearly instructs the recipient to sign in with their phone number
- NoSubscriptionPage heading says "No Farm Access" with guidance to contact farm admin or subscribe
- AddUserModal surfaces server-side seat limit error messages to the user
</success_criteria>

<output>
After completion, create `.planning/phases/31-simplify-invite-user-flow-with-seat-limits/31-02-SUMMARY.md`
</output>
