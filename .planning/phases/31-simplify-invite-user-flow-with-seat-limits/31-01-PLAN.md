---
phase: 31-simplify-invite-user-flow-with-seat-limits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/039_seat_limit_enforcement.sql
autonomous: true
requirements:
  - TIER-D1

must_haves:
  truths:
    - "Inviting a user when the role's seat limit is reached returns a descriptive server error"
    - "Phone format mismatch no longer causes duplicate member check to miss existing members"
    - "Farms have extra_admin_seats and extra_meter_checker_seats columns defaulting to 0"
    - "Effective seat limit is tier max + farm's extra seats for each role"
  artifacts:
    - path: "supabase/migrations/039_seat_limit_enforcement.sql"
      provides: "Schema columns + seat enforcement in invite RPC"
      contains: "extra_admin_seats"
  key_links:
    - from: "private.invite_user_by_phone_impl"
      to: "public.subscription_tiers"
      via: "JOIN to get tier max limits"
      pattern: "JOIN public\\.subscription_tiers"
    - from: "private.invite_user_by_phone_impl"
      to: "public.farms"
      via: "JOIN to get extra seat columns"
      pattern: "extra_admin_seats|extra_meter_checker_seats"
    - from: "private.invite_user_by_phone_impl"
      to: "auth.users"
      via: "Phone normalization with '+' prefix"
      pattern: "'\\+' \\|\\| au\\.phone"
---

<objective>
Add server-side seat limit enforcement to the invite_user_by_phone RPC, add per-farm extra seat columns, and fix the phone format bug in the duplicate member check.

Purpose: Prevents invites from exceeding tier seat limits at the database level (defense in depth beyond client-side checks), enables future per-farm add-on seats, and fixes a bug where auth.users.phone without '+' prefix could bypass the duplicate member check.

Output: Migration 039 with schema changes, updated RPC, public wrapper, grants, and schema reload.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@supabase/migrations/038_restrict_admin_invite_role.sql
@supabase/migrations/037_fix_phone_format_matching.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extra seat columns and enforce seat limits in invite RPC</name>
  <files>supabase/migrations/039_seat_limit_enforcement.sql</files>
  <action>
Create migration `supabase/migrations/039_seat_limit_enforcement.sql` with these sections:

**Section 1 — Schema changes:**
Add two columns to `public.farms`:
- `extra_admin_seats INTEGER NOT NULL DEFAULT 0`
- `extra_meter_checker_seats INTEGER NOT NULL DEFAULT 0`

**Section 2 — Update `private.invite_user_by_phone_impl`:**
Copy the full function from migration 038 as the base. Make these modifications:

1. **Fix phone format bug** in the duplicate member check (around line 76-84 in 038). The current code compares `au.phone = v_normalized_phone` but `auth.users.phone` stores WITHOUT '+' prefix. Change the JOIN condition to:
   ```sql
   WHERE '+' || au.phone = v_normalized_phone
   ```
   This matches the fix pattern from migration 037 (lines 49-51).

2. **Add seat limit check** — Insert a new block AFTER the admin role escalation check (after line 73 in 038, the `IF v_user_role = 'admin' AND p_role <> 'meter_checker'` block) and BEFORE the duplicate member check. The block must:

   a. Declare new variables at the top of the DECLARE section:
      - `v_active_count INTEGER`
      - `v_pending_count INTEGER`
      - `v_tier_limit INTEGER`
      - `v_extra_seats INTEGER`
      - `v_effective_limit INTEGER`

   b. Count active members for the requested role:
      ```sql
      SELECT COUNT(*) INTO v_active_count
      FROM public.farm_members
      WHERE farm_id = p_farm_id AND role = p_role;
      ```
      Note: `is_disabled` column was dropped in migration 030. All members are active.

   c. Count pending invites for the requested role:
      ```sql
      SELECT COUNT(*) INTO v_pending_count
      FROM public.farm_invites
      WHERE farm_id = p_farm_id AND role = p_role
        AND expires_at > now()
        AND (max_uses IS NULL OR uses_count < max_uses);
      ```

   d. Get tier limit and extra seats via JOIN:
      ```sql
      SELECT
        CASE WHEN p_role = 'admin' THEN st.max_admins ELSE st.max_meter_checkers END,
        CASE WHEN p_role = 'admin' THEN f.extra_admin_seats ELSE f.extra_meter_checker_seats END
      INTO v_tier_limit, v_extra_seats
      FROM public.farms f
      JOIN public.subscription_tiers st ON st.slug = f.subscription_tier
      WHERE f.id = p_farm_id;
      ```

   e. Calculate effective limit and check:
      ```sql
      v_effective_limit := COALESCE(v_tier_limit, 0) + COALESCE(v_extra_seats, 0);

      IF (v_active_count + v_pending_count) >= v_effective_limit THEN
        RAISE EXCEPTION 'No available % seats. Your plan allows % (% active, % pending).',
          p_role, v_effective_limit, v_active_count, v_pending_count;
      END IF;
      ```

   IMPORTANT: All table references must be fully qualified (`public.farms`, `public.farm_members`, etc.) because the function uses `SET search_path = ''`.

**Section 3 — Recreate public SQL wrapper** (required pattern per migration 035):
```sql
CREATE OR REPLACE FUNCTION public.invite_user_by_phone(
    p_farm_id UUID, p_phone TEXT, p_first_name TEXT, p_last_name TEXT, p_role TEXT DEFAULT 'meter_checker'
) RETURNS TEXT LANGUAGE sql SECURITY DEFINER SET search_path = '' AS $$
    SELECT private.invite_user_by_phone_impl(p_farm_id, p_phone, p_first_name, p_last_name, p_role);
$$;
```

Add COMMENT ON FUNCTION describing the seat enforcement.

**Section 4 — Grants and schema reload:**
```sql
GRANT EXECUTE ON FUNCTION public.invite_user_by_phone(uuid,text,text,text,text)
    TO authenticated, anon, public;
NOTIFY pgrst, 'reload schema';
```

Follow the exact migration header comment style from 038 (section separators with `-- ===...===`).
  </action>
  <verify>
    <automated>npx supabase migration list 2>&1 | findstr "039"</automated>
    <manual>Review the migration SQL for correct phone normalization and seat limit logic</manual>
  </verify>
  <done>Migration 039 exists with: extra seat columns on farms, phone format fix using '+' || au.phone, seat limit enforcement counting active members + pending invites against tier max + extra seats, public wrapper recreated, grants applied</done>
</task>

</tasks>

<verification>
1. Migration file exists at `supabase/migrations/039_seat_limit_enforcement.sql`
2. File contains `ALTER TABLE public.farms ADD COLUMN extra_admin_seats`
3. File contains `'+' || au.phone` for phone normalization fix
4. File contains seat limit check with RAISE EXCEPTION message
5. File contains recreated public wrapper
6. File contains GRANT EXECUTE and NOTIFY pgrst
</verification>

<success_criteria>
- Migration 039 adds extra_admin_seats and extra_meter_checker_seats columns to farms
- invite_user_by_phone_impl normalizes auth.users.phone with '+' prefix before comparison
- Seat limit check counts active members + pending invites, compares against tier limit + extra seats
- Descriptive error message includes role name, effective limit, active count, and pending count
- Public SQL wrapper recreated with same signature
- Permissions granted and PostgREST schema reload notified
</success_criteria>

<output>
After completion, create `.planning/phases/31-simplify-invite-user-flow-with-seat-limits/31-01-SUMMARY.md`
</output>
