---
phase: 14-record-meter-reading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/toastStore.ts
  - src/components/Toast.tsx
  - src/components/AppLayout.tsx
  - src/components/NewReadingSheet.tsx
autonomous: true
requirements: [READ-01, READ-02, READ-03, READ-04, PROX-02]

must_haves:
  truths:
    - "User can enter a positive numeric meter value and save it to the local PowerSync database"
    - "The reading form displays the well's measurement unit and multiplier inline beside the input"
    - "GPS location is captured on submit and stored with the reading, with is_in_range flag"
    - "A warning appears inside the sheet when the entered value is within 5 units of the last reading"
    - "User can continue past the similar-reading warning and save anyway"
    - "Out-of-range submission shows a warning inside the sheet, but user can continue"
    - "A success toast appears after saving a reading"
  artifacts:
    - path: "src/stores/toastStore.ts"
      provides: "Toast notification state management"
      contains: "useToastStore"
    - path: "src/components/Toast.tsx"
      provides: "Toast notification UI component"
      min_lines: 20
    - path: "src/components/NewReadingSheet.tsx"
      provides: "Bottom sheet with Reading tab, validation, warnings, GPS capture, PowerSync INSERT"
      min_lines: 100
  key_links:
    - from: "src/components/NewReadingSheet.tsx"
      to: "PowerSync readings table"
      via: "db.execute INSERT INTO readings"
      pattern: "INSERT INTO readings"
    - from: "src/components/NewReadingSheet.tsx"
      to: "src/hooks/useWellReadings.ts"
      via: "import for similar-reading comparison"
      pattern: "useWellReadings"
    - from: "src/components/NewReadingSheet.tsx"
      to: "src/lib/gps-proximity.ts"
      via: "getDistanceToWell + isInRange for proximity check"
      pattern: "getDistanceToWell|isInRange"
    - from: "src/components/NewReadingSheet.tsx"
      to: "src/stores/toastStore.ts"
      via: "show toast on successful save"
      pattern: "useToastStore"
    - from: "src/components/AppLayout.tsx"
      to: "src/components/Toast.tsx"
      via: "Toast component mounted globally"
      pattern: "Toast"
---

<objective>
Create the toast notification system and the NewReadingSheet component with the full Reading tab -- numeric input with unit/multiplier display, positive number validation, similar-reading warning, out-of-range GPS warning, GPS location capture on submit, and PowerSync INSERT into readings table.

Purpose: This is the core data-capture feature that allows field agents to record meter readings offline. The reading form is the primary tab of the NewReadingSheet bottom sheet.
Output: toastStore.ts, Toast.tsx (global notification system), NewReadingSheet.tsx (bottom sheet with complete Reading tab functionality)
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-record-meter-reading/14-RESEARCH.md
@.planning/phases/12-data-foundation/12-02-SUMMARY.md
@.planning/phases/13-well-detail-page/13-02-SUMMARY.md

@src/components/WellDetailSheet.tsx
@src/components/AddWellFormBottomSheet.tsx
@src/hooks/useWellReadings.ts
@src/hooks/useGeolocation.ts
@src/lib/gps-proximity.ts
@src/lib/powersync-schema.ts
@src/hooks/useWells.ts
@src/lib/AuthProvider.tsx
@src/stores/activeFarmStore.ts
@src/components/AppLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create toast notification system (store + component + mount)</name>
  <files>
    src/stores/toastStore.ts
    src/components/Toast.tsx
    src/components/AppLayout.tsx
  </files>
  <action>
**1. Create `src/stores/toastStore.ts`** -- Zustand store for toast notifications:
- Interface: `{ message: string | null; type: 'success' | 'error'; show: (message, type?) => void; hide: () => void }`
- `show()` sets message and type (default 'success'), auto-dismisses after 3 seconds via `setTimeout`
- `hide()` clears message to null
- Follow the exact Zustand pattern from `activeFarmStore.ts` (use `create` from 'zustand')

**2. Create `src/components/Toast.tsx`** -- Renders toast from store:
- Subscribe to `useToastStore()` for message and type
- When `message` is non-null, render a fixed-position toast at the bottom of the screen
- Position: `fixed bottom-6 left-4 right-4 z-[100]` (above all sheets)
- Green background for success (`bg-green-600`), red for error (`bg-red-600`)
- Text: white, centered, rounded-lg, `px-4 py-3`
- Include a CheckCircleIcon (success) or ExclamationTriangleIcon (error) from @heroicons/react/24/outline
- Tap to dismiss (onClick calls `hide()`)
- Simple opacity transition: `transition-opacity duration-300`
- Wrap in `React.memo` for performance

**3. Mount Toast in `src/components/AppLayout.tsx`**:
- Import Toast component
- Add `<Toast />` as the last child inside the outermost `<div>` in `AppLayoutContent`, after `<main>` -- this ensures it renders above all page content
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- zero type errors.
Verify `src/stores/toastStore.ts` exports `useToastStore`.
Verify `src/components/Toast.tsx` exists and imports from toastStore.
Verify `src/components/AppLayout.tsx` includes `<Toast />`.
  </verify>
  <done>
Toast store exists with show/hide methods. Toast component renders fixed-position notification. AppLayout mounts Toast globally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NewReadingSheet with complete Reading tab</name>
  <files>
    src/components/NewReadingSheet.tsx
  </files>
  <action>
Create `src/components/NewReadingSheet.tsx` -- a bottom sheet with two tabs (Reading and Meter Problem), implementing the full Reading tab. The Meter Problem tab will be a placeholder for now ("Coming in next plan").

**Component props:**
```typescript
interface NewReadingSheetProps {
  open: boolean;
  onClose: () => void;
  well: WellWithReading;  // from useWells.ts
  farmId: string;
  userId: string;
}
```

**Bottom sheet structure** (copy Dialog pattern from AddWellFormBottomSheet):
- `Dialog open={open} onClose={onClose} className="relative z-[60]"` -- z-[60] to layer above WellDetailSheet's z-50
- DialogBackdrop with transition opacity
- DialogPanel with `bg-[#5f7248]` background, rounded-t-2xl, max-h-[90vh], flex col, slide-up transition via `data-[closed]:translate-y-full`

**Header area:**
- Top: well name from `well.name` in small text
- Title: "NEW READING" in bold white, tracking-wide (matches existing header pattern)
- Top-right: Real-time proximity indicator -- use `useGeolocation({ autoRequest: false })` to get cached GPS, then compute proximity with `getDistanceToWell()` and `isInRange()` from gps-proximity.ts. Show:
  - "In Range" (green text + MapPinIcon) when in range
  - "Out of Range" (yellow text + MapPinIcon) when out of range
  - Nothing when GPS is unavailable (no location data)

**Tab bar** (below header, above content):
- Two buttons: "Reading" (default active) and "Meter Problem"
- State: `activeTab: 'reading' | 'problem'`
- Active tab: `bg-white/20 font-semibold text-white rounded-lg px-4 py-2`
- Inactive tab: `text-white/60 px-4 py-2`
- Container: `flex gap-1 px-4 pb-3`

**Reading tab content** -- controlled by a state machine `view: 'form' | 'similar-warning' | 'range-warning' | 'submitting'`:

**View: 'form'** -- the input form:
- Big numeric input: `<input type="text" inputMode="decimal" ...>` -- large text (`text-3xl font-bold`), centered, bg-white/10 rounded-xl, padding, full width
  - Placeholder: "0"
  - Value: controlled by `readingValue` state (string)
- Unit + multiplier display: inline to the right of the input, same line. Format: `{well.units} x {well.multiplier}` (e.g., "GAL x 10.0"). Style: `text-lg text-white/70`
  - Layout: flex row with input taking flex-1 and unit text beside it
- Inline validation error: below the input, red text (`text-red-400 text-sm`), shown when:
  - Empty on submit attempt: "Reading value is required"
  - Non-numeric: "Please enter a valid number"
  - Zero or negative: "Reading must be a positive number"
- Use `validateReadingValue(input: string): string | null` helper function (inline or separate)

**Footer (in 'form' view):**
- Cancel button (left): `text-white font-medium` -- calls `onClose()`
- Save button (right): `bg-[#bdefda] text-[#506741] rounded-lg font-medium` with CheckIcon -- triggers submit flow
- Layout: flex justify-between, px-4 py-4, flex-shrink-0, safe-area bottom padding

**Submit flow** (when Save tapped):
1. Validate input -- if invalid, set inline error message and stay in 'form' view
2. Get existing readings via `useWellReadings(well.id)` -- check if value is within 5 units of `readings[0].value` (the most recent). Guard empty array.
3. If similar: set `view = 'similar-warning'` (do NOT save yet)
4. If not similar: proceed to GPS capture -> `view = 'submitting'`

**View: 'similar-warning'**:
- ExclamationTriangleIcon (yellow, large `w-12 h-12`)
- "Similar Reading" header (white, text-xl, font-bold)
- Bullet: "This reading is within 5 {well.units} of the last recorded reading" (white/70)
- Bullet: "Double check the meter" (white/70)
- "Go Back" button: white text, returns to 'form' view
- "Continue" button: `bg-[#bdefda] text-[#506741]` -- proceeds to GPS capture

**GPS capture + proximity check** (triggered after similar-warning Continue or directly if not similar):
1. Set `view = 'submitting'` -- show a spinner with "Saving..." text
2. Capture GPS: use `navigator.geolocation.getCurrentPosition()` with 5s timeout, wrapped in a Promise. If GPS unavailable or times out, resolve null.
3. If GPS captured AND well has location: compute proximity with `getDistanceToWell()` + `isInRange()`
4. If out of range: set `view = 'range-warning'`, store the captured GPS coords in state
5. If in range OR GPS null: proceed to save

**View: 'range-warning'**:
- ExclamationTriangleIcon (yellow, large `w-12 h-12`)
- "GPS Coordinates Incorrect" header (white, text-xl, font-bold)
- Bullet: "Are you at the right well?" (white/70)
- Bullet: "Check your device GPS" (white/70)
- "Go Back" button: white text, returns to 'form' view
- "Continue" button: `bg-[#bdefda] text-[#506741]` -- saves with `is_in_range = 0`

**Save to PowerSync:**
```typescript
const db = usePowerSync();
const readingId = crypto.randomUUID();
const now = new Date().toISOString();

// Calculate is_in_range
let inRange = 0;
if (gpsResult && well.location) {
  const dist = getDistanceToWell(
    { lat: gpsResult.lat, lng: gpsResult.lng },
    { latitude: well.location.latitude, longitude: well.location.longitude },
  );
  inRange = isInRange(dist) ? 1 : 0;
}

await db.execute(
  `INSERT INTO readings (id, well_id, farm_id, value, recorded_by, recorded_at,
    gps_latitude, gps_longitude, is_in_range, notes, created_at, updated_at)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
  [readingId, well.id, farmId, readingValue, userId, now,
   gpsResult?.lat ?? null, gpsResult?.lng ?? null, inRange, null, now, now]
);
```

- After save: call `useToastStore.getState().show('Reading saved')`, then call `onClose()`
- Wrap in try/catch: on error, show error toast and return to 'form' view

**View: 'submitting'**:
- Centered spinner (animated `border-2 border-white border-t-transparent rounded-full w-8 h-8 animate-spin`)
- "Saving..." text below spinner

**Meter Problem tab** (placeholder for now):
- Simple centered text: "Meter Problem reporting will be available soon" in `text-white/50`
- This is completed in Plan 02

**Important implementation details:**
- Use `useCallback` for all handlers passed as props or used in effects
- Use `usePowerSync()` from `@powersync/react` for db access
- Import `WellWithReading` from `../hooks/useWells`
- Import `useWellReadings` from `../hooks/useWellReadings`
- Import `getDistanceToWell, isInRange` from `../lib/gps-proximity`
- Import `useToastStore` from `../stores/toastStore`
- Import `useGeolocation` from `../hooks/useGeolocation`
- Do NOT use `type="number"` -- use `type="text" inputMode="decimal"` for numeric keypad
- Store reading value as TEXT (string) -- the `value` column is TEXT in PowerSync
- Use INTEGER 0/1 for `is_in_range` (not boolean) -- PowerSync has no BOOLEAN type
- Always include `farm_id` in the INSERT -- omitting it breaks sync rules
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- zero type errors.
Verify `src/components/NewReadingSheet.tsx` exists.
Grep for `INSERT INTO readings` in the file to confirm PowerSync write.
Grep for `useWellReadings` to confirm similar-reading check.
Grep for `getDistanceToWell` to confirm GPS proximity integration.
Grep for `useToastStore` to confirm toast integration.
Grep for `inputMode="decimal"` to confirm numeric keypad.
  </verify>
  <done>
NewReadingSheet renders as a bottom sheet at z-[60]. Reading tab shows big numeric input with unit/multiplier. Validation rejects non-positive values. Similar reading warning triggers within 5 units. Out-of-range GPS warning appears when applicable. GPS captured on submit. Reading saved to PowerSync with all required fields including farm_id and is_in_range. Success toast shown after save.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` -- zero TypeScript errors
2. Grep for `useToastStore` in both toastStore.ts and NewReadingSheet.tsx
3. Grep for `INSERT INTO readings` in NewReadingSheet.tsx
4. Grep for `inputMode="decimal"` in NewReadingSheet.tsx
5. Grep for `similar-warning` or `range-warning` in NewReadingSheet.tsx
6. Verify Toast is mounted in AppLayout.tsx
</verification>

<success_criteria>
- Toast notification system works globally (store + component + mounted)
- NewReadingSheet opens as a bottom sheet with Reading and Meter Problem tabs
- Reading tab validates input (positive numbers only), shows inline errors
- Similar reading warning appears when value is within 5 units of last reading
- GPS is captured on submit; out-of-range warning shown when applicable
- Reading is saved to PowerSync readings table with all columns including farm_id, GPS coords, and is_in_range
- Success toast appears after saving
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-record-meter-reading/14-01-SUMMARY.md`
</output>
