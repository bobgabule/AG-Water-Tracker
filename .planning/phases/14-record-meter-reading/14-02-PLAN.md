---
phase: 14-record-meter-reading
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified:
  - src/components/NewReadingSheet.tsx
  - src/components/WellDetailSheet.tsx
  - src/pages/WellDetailPage.tsx
autonomous: false
requirements: [PROB-01, PROB-02, READ-01]

must_haves:
  truths:
    - "User can switch to Meter Problem tab and select multiple problem checkboxes"
    - "Submitting meter problems updates the well's pump_state, battery_state, and meter_status fields"
    - "User taps '+ New Reading' button on the well detail page to open the reading sheet"
    - "Both reading and meter problem submissions close the sheet and show a success toast"
    - "Well detail page updates to reflect new reading or status change after submission"
  artifacts:
    - path: "src/components/NewReadingSheet.tsx"
      provides: "Complete bottom sheet with both Reading and Meter Problem tabs"
      contains: "MeterProblemForm"
    - path: "src/components/WellDetailSheet.tsx"
      provides: "Well detail sheet with '+ New Reading' button"
      contains: "New Reading"
    - path: "src/pages/WellDetailPage.tsx"
      provides: "Page managing NewReadingSheet open/close state"
      contains: "NewReadingSheet"
  key_links:
    - from: "src/components/NewReadingSheet.tsx"
      to: "PowerSync wells table"
      via: "db.execute UPDATE wells for meter problem"
      pattern: "UPDATE wells SET"
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/components/NewReadingSheet.tsx"
      via: "onNewReading callback prop opens the sheet"
      pattern: "onNewReading"
    - from: "src/pages/WellDetailPage.tsx"
      to: "src/components/NewReadingSheet.tsx"
      via: "state management for sheet open/close"
      pattern: "NewReadingSheet"
---

<objective>
Implement the Meter Problem tab in NewReadingSheet, add the "+ New Reading" button to WellDetailSheet, and wire everything together in WellDetailPage so users can open the reading form from the well detail view.

Purpose: Completes the meter problem reporting feature and integrates the reading form into the user flow. Without this plan, users have no way to open the NewReadingSheet.
Output: Complete NewReadingSheet with both tabs, WellDetailSheet with action button, WellDetailPage managing sheet state
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-record-meter-reading/14-RESEARCH.md
@.planning/phases/14-record-meter-reading/14-01-SUMMARY.md

@src/components/NewReadingSheet.tsx
@src/components/WellDetailSheet.tsx
@src/pages/WellDetailPage.tsx
@src/lib/powersync-schema.ts
@src/hooks/useWells.ts
@src/stores/toastStore.ts
@src/components/WellStatusIndicators.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Meter Problem tab and wire "+ New Reading" button</name>
  <files>
    src/components/NewReadingSheet.tsx
    src/components/WellDetailSheet.tsx
    src/pages/WellDetailPage.tsx
  </files>
  <action>
**1. Replace the Meter Problem placeholder in `src/components/NewReadingSheet.tsx`:**

Add the meter problem form content inside the Meter Problem tab area (where the placeholder text currently is):

**Meter Problem state:**
```typescript
interface MeterProblems {
  notWorking: boolean;
  batteryDead: boolean;
  pumpOff: boolean;
  deadPump: boolean;
}
```
Initialize all to `false`. Use a single state object.

**Checkbox UI:**
- 4 checkboxes in a vertical list with spacing (`space-y-3 p-4`):
  - "Not Working" (maps to `meter_status: 'Dead'`)
  - "Battery Dead" (maps to `battery_state: 'Dead'`)
  - "Pump Off" (maps to `pump_state: 'Critical'`)
  - "Dead Pump" (maps to `pump_state: 'Dead'`)
- Each checkbox: `<label className="flex items-center gap-3 cursor-pointer">` with `<input type="checkbox" className="w-5 h-5 rounded border-white/30 text-[#506741] focus:ring-white bg-white/10">` and `<span className="text-white text-base">`
- Note: If both "Pump Off" and "Dead Pump" are checked, "Dead Pump" wins (it's the more severe state). Apply in order so `deadPump` overwrites `pumpOff`.

**Footer (Meter Problem tab):**
- Same layout as Reading tab footer: Cancel (left) + Submit (right)
- Submit button disabled when no checkboxes selected
- Submit button: `bg-[#bdefda] text-[#506741] rounded-lg font-medium` with CheckIcon

**Submit logic for Meter Problem:**
```typescript
const updates: Record<string, string> = {};
if (problems.notWorking) updates.meter_status = 'Dead';
if (problems.batteryDead) updates.battery_state = 'Dead';
if (problems.pumpOff) updates.pump_state = 'Critical';
if (problems.deadPump) updates.pump_state = 'Dead'; // overwrites pumpOff

const setClauses = Object.keys(updates).map(k => `${k} = ?`).join(', ');
const values = [...Object.values(updates), new Date().toISOString(), well.id];

await db.execute(
  `UPDATE wells SET ${setClauses}, updated_at = ? WHERE id = ?`,
  values,
);
```
- After save: `useToastStore.getState().show('Problem reported')`, then `onClose()`
- Wrap in try/catch: on error, show error toast
- Show a submitting spinner state while saving

**2. Add `onNewReading` prop to `src/components/WellDetailSheet.tsx`:**

- Add `onNewReading: () => void` to the `WellDetailSheetProps` interface
- Add a "+ New Reading" button as a fixed footer at the bottom of the sheet (inside DialogPanel, after the scrollable content div, before the closing `</DialogPanel>`)
- Button style: full-width, `bg-[#bdefda] text-[#506741] rounded-lg font-bold text-base py-3 mx-4 mb-[max(1rem,env(safe-area-inset-bottom))]` with a PlusIcon from @heroicons/react/24/solid
- Button text: "+ New Reading"
- onClick: `onNewReading()`
- The button should be `flex-shrink-0` so it stays at the bottom while content scrolls above

**3. Wire NewReadingSheet in `src/pages/WellDetailPage.tsx`:**

- Add `const [readingSheetOpen, setReadingSheetOpen] = useState(false)` state
- Import `NewReadingSheet` from `../components/NewReadingSheet`
- Import `usePowerSync` is NOT needed here (NewReadingSheet handles its own db access)
- Get `user` from `useAuth()` alongside existing `onboardingStatus`
- Get `farmId` from `onboardingStatus?.farmId ?? ''`
- Get current well: `const currentWell = wells.find(w => w.id === id) ?? null`
- Add `handleNewReading` callback: `() => setReadingSheetOpen(true)`
- Add `handleReadingClose` callback: `() => setReadingSheetOpen(false)`
- Pass `onNewReading={handleNewReading}` to `WellDetailSheet`
- Render `<NewReadingSheet>` conditionally: only when `readingSheetOpen && currentWell && user`:
  ```tsx
  {readingSheetOpen && currentWell && user && (
    <NewReadingSheet
      open={readingSheetOpen}
      onClose={handleReadingClose}
      well={currentWell}
      farmId={farmId}
      userId={user.id}
    />
  )}
  ```
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- zero type errors.
Grep for `UPDATE wells SET` in NewReadingSheet.tsx.
Grep for `onNewReading` in WellDetailSheet.tsx.
Grep for `NewReadingSheet` in WellDetailPage.tsx.
Grep for `notWorking.*batteryDead.*pumpOff.*deadPump` in NewReadingSheet.tsx.
  </verify>
  <done>
Meter Problem tab has 4 checkboxes that map to well status fields. Submit updates the wells table via PowerSync. WellDetailSheet has a "+ New Reading" button. WellDetailPage manages the NewReadingSheet open/close state and passes required props.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete reading flow</name>
  <files>src/components/NewReadingSheet.tsx, src/components/WellDetailSheet.tsx, src/pages/WellDetailPage.tsx</files>
  <action>
Human verification of the complete meter reading flow built in Plans 14-01 and 14-02. No code changes -- visual and functional testing only.

What was built:
- Toast notification system (toastStore + Toast component)
- NewReadingSheet with Reading tab (numeric input, unit/multiplier, validation, similar-reading warning, GPS capture, out-of-range warning, PowerSync save)
- Meter Problem tab (4 checkboxes updating well status)
- "+ New Reading" button on well detail page

Verification steps:
1. Open the app and navigate to a well detail page (tap a well marker on the map)
2. Verify the "+ New Reading" button appears at the bottom of the well detail sheet
3. Tap "+ New Reading" -- verify the bottom sheet slides up with "NEW READING" header and the well name
4. Verify two tabs are visible: "Reading" (active) and "Meter Problem"
5. Verify the proximity indicator appears in the header area (if GPS was previously granted)
6. Verify the big numeric input is visible with the well's unit and multiplier displayed beside it (e.g., "GAL x 10.0")
7. Tap Save with empty input -- verify "Reading value is required" inline error
8. Enter "abc" -- verify "Please enter a valid number" error
9. Enter "-5" -- verify "Reading must be a positive number" error
10. Enter a valid positive number and tap Save -- verify the reading saves and a green "Reading saved" toast appears
11. If there's an existing reading, enter a value within 5 units of it -- verify the "Similar Reading" warning screen appears with yellow icon, bullet points, and Continue/Go Back buttons
12. Switch to the "Meter Problem" tab -- verify 4 checkboxes are shown: Not Working, Battery Dead, Pump Off, Dead Pump
13. Check one or more boxes and tap Submit -- verify a "Problem reported" toast appears and the sheet closes
14. Return to the well detail page -- verify the reading history and/or status indicators reflect the new data
  </action>
  <verify>All 14 verification steps pass visual inspection.</verify>
  <done>Complete reading and meter problem flow verified working end-to-end.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` -- zero TypeScript errors
2. Grep for `UPDATE wells SET` in NewReadingSheet.tsx (meter problem save)
3. Grep for `onNewReading` in WellDetailSheet.tsx (button callback)
4. Grep for `NewReadingSheet` in WellDetailPage.tsx (sheet integration)
5. Visual verification of end-to-end flow (checkpoint task)
</verification>

<success_criteria>
- Meter Problem tab has 4 checkboxes mapped to well status fields
- Problem submission updates wells table via PowerSync
- "+ New Reading" button visible on well detail page
- Tapping button opens the NewReadingSheet
- Both tabs functional: reading saves to readings table, problem updates wells table
- Success toast appears after both reading and problem submissions
- Sheet closes after successful submission
- Well detail page reflects changes on return
- TypeScript compiles with zero errors
- Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-record-meter-reading/14-02-SUMMARY.md`
</output>
