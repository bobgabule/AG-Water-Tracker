---
phase: 16-reading-management-map-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/WellReadingsList.tsx
  - src/components/WellDetailSheet.tsx
  - src/components/EditReadingSheet.tsx
  - src/components/ConfirmDeleteReadingDialog.tsx
autonomous: true
requirements:
  - READ-05
  - READ-06

must_haves:
  truths:
    - "All authenticated users can edit a reading's value and save the correction"
    - "All authenticated users can delete a reading with a confirmation prompt"
    - "Reading rows in the well detail sheet are tappable and open an edit sheet"
    - "Deleting a reading removes it from the readings list reactively via PowerSync"
    - "Toast notifications confirm success or report errors for edit and delete"
  artifacts:
    - path: "src/components/EditReadingSheet.tsx"
      provides: "Bottom sheet for editing a reading value with delete option"
      exports: ["EditReadingSheet"]
    - path: "src/components/ConfirmDeleteReadingDialog.tsx"
      provides: "Confirmation dialog for reading deletion"
      exports: ["ConfirmDeleteReadingDialog"]
    - path: "src/components/WellReadingsList.tsx"
      provides: "Updated readings list with tappable rows"
      exports: ["default"]
    - path: "src/components/WellDetailSheet.tsx"
      provides: "Well detail sheet wired to edit reading flow"
      exports: ["default"]
  key_links:
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/components/EditReadingSheet.tsx"
      via: "onReadingClick handler opens EditReadingSheet"
      pattern: "selectedReading state"
    - from: "src/components/EditReadingSheet.tsx"
      to: "src/components/ConfirmDeleteReadingDialog.tsx"
      via: "Delete button inside edit sheet opens confirm dialog"
      pattern: "showDeleteConfirm state"
---

<objective>
Enable all users to edit and delete meter readings from the well detail page.

Purpose: Field agents and managers need to correct mistakes in recorded readings. Currently readings are display-only with no way to fix errors. This plan adds tap-to-edit on reading rows, an edit sheet for changing the value, and a delete flow with confirmation dialog.

Output: Updated WellReadingsList with tappable rows, EditReadingSheet component, ConfirmDeleteReadingDialog component, and WellDetailSheet wiring.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/WellReadingsList.tsx
@src/components/WellDetailSheet.tsx
@src/components/WellDetailPage.tsx
@src/components/NewReadingSheet.tsx
@src/components/ConfirmDeleteWellDialog.tsx
@src/stores/toastStore.ts
@src/hooks/useWellReadingsWithNames.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfirmDeleteReadingDialog and EditReadingSheet components</name>
  <files>src/components/ConfirmDeleteReadingDialog.tsx, src/components/EditReadingSheet.tsx</files>
  <action>
**1. Create `src/components/ConfirmDeleteReadingDialog.tsx`:**

Follow the exact pattern from `ConfirmDeleteWellDialog.tsx` (same structure, different text):

```typescript
interface ConfirmDeleteReadingDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: () => void;
  readingValue: string;
  readingDate: string;
  loading: boolean;
}
```

- Headless UI `Dialog` at `z-50` with dark backdrop (`bg-black/50`)
- `bg-gray-800 rounded-2xl` panel with `data-[closed]:scale-95 data-[closed]:opacity-0` transitions
- Red `ExclamationTriangleIcon` in `bg-red-500/20` circle
- Title: "Delete Reading"
- Body: `Delete the reading **{readingValue}** from **{readingDate}**? This cannot be undone.`
- Cancel (gray `bg-gray-700`) and Delete (red `bg-red-600` with loading spinner) buttons
- Same disabled states and loading spinner pattern as ConfirmDeleteWellDialog

**2. Create `src/components/EditReadingSheet.tsx`:**

Bottom sheet dialog for editing a single reading's value with option to delete.

```typescript
interface EditReadingSheetProps {
  open: boolean;
  onClose: () => void;
  reading: ReadingWithName;
  wellUnits: string;
  wellMultiplier: string;
}
```

Structure (follow NewReadingSheet dialog pattern):
- Headless UI `Dialog` at `z-[60]` (above WellDetailSheet's z-50)
- `DialogBackdrop` with `bg-black/40`
- `DialogPanel` as a centered card: `bg-[#5f7248] rounded-2xl max-w-sm mx-auto p-5`
- Header: "Edit Reading" title (white, bold) + reading date/time in subtitle (white/60)
- Input section:
  - Label "Meter Value"
  - Text input pre-filled with `reading.value`, `inputMode="decimal"`, pattern `[0-9]*\.?[0-9]*`
  - Unit + multiplier badge: `{wellUnits} x {wellMultiplier}` (match NewReadingSheet style)
  - Validation error text (red) below input
- Footer buttons:
  - "Delete" text button on the left (red-400 text, no background)
  - "Cancel" button (white/20 bg)
  - "Save" button (green `bg-[#bdefda] text-[#506741]` with loading spinner when saving)
- States: `editValue: string`, `saving: boolean`, `deleting: boolean`, `showDeleteConfirm: boolean`, `validationError: string | null`

Save logic:
```typescript
const db = usePowerSync();
// Validate: non-empty, valid number, positive
const trimmed = editValue.trim();
if (!trimmed || isNaN(Number(trimmed)) || Number(trimmed) < 0) {
  setValidationError('Enter a valid meter reading');
  return;
}
await db.execute(
  'UPDATE readings SET value = ?, updated_at = ? WHERE id = ?',
  [trimmed, new Date().toISOString(), reading.id]
);
useToastStore.getState().show('Reading updated');
onClose();
```

Delete logic (triggered by ConfirmDeleteReadingDialog's onConfirm):
```typescript
await db.execute('DELETE FROM readings WHERE id = ?', [reading.id]);
useToastStore.getState().show('Reading deleted');
onClose();
```

Error handling: wrap both in try/catch, show error toast on failure. Set saving/deleting to false in finally block.

Render `ConfirmDeleteReadingDialog` inside the component, controlled by `showDeleteConfirm` state.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify EditReadingSheet imports Dialog from @headlessui/react and usePowerSync from @powersync/react. Verify ConfirmDeleteReadingDialog matches ConfirmDeleteWellDialog structure.</verify>
  <done>EditReadingSheet renders a centered card with pre-filled value input, Save/Cancel/Delete buttons, and validation. ConfirmDeleteReadingDialog shows confirmation with loading state before executing delete.</done>
</task>

<task type="auto">
  <name>Task 2: Make reading rows tappable and wire into WellDetailSheet</name>
  <files>src/components/WellReadingsList.tsx, src/components/WellDetailSheet.tsx</files>
  <action>
**1. Update `src/components/WellReadingsList.tsx`:**

Add new prop to the interface:
```typescript
interface WellReadingsListProps {
  readings: ReadingWithName[];
  onReadingClick?: (reading: ReadingWithName) => void;
}
```

When `onReadingClick` is provided, change each reading row from `<div>` to `<button>`:
- Add `type="button"` and `onClick={() => onReadingClick(reading)}`
- Add tap affordance classes: `cursor-pointer hover:bg-white/5 active:bg-white/10 rounded-lg -mx-1 px-1 transition-colors`
- Keep all existing content layout unchanged

When `onReadingClick` is not provided, keep the rows as `<div>` elements (backwards compatible, no visual change).

Use a conditional wrapper approach:
```tsx
const Row = onReadingClick ? 'button' : 'div';
const rowProps = onReadingClick
  ? { type: 'button' as const, onClick: () => onReadingClick(reading) }
  : {};
```

Maintain `React.memo` wrapping. Add `onReadingClick` to the component props.

**2. Update `src/components/WellDetailSheet.tsx`:**

Add imports:
```typescript
import EditReadingSheet from './EditReadingSheet';
import type { ReadingWithName } from '../hooks/useWellReadingsWithNames';
```

Add state inside the component:
```typescript
const [selectedReading, setSelectedReading] = useState<ReadingWithName | null>(null);
const [editSheetOpen, setEditSheetOpen] = useState(false);
```

Create handler (wrap in useCallback):
```typescript
const handleReadingClick = useCallback((reading: ReadingWithName) => {
  setSelectedReading(reading);
  setEditSheetOpen(true);
}, []);

const handleEditClose = useCallback(() => {
  setEditSheetOpen(false);
  setSelectedReading(null);
}, []);
```

Pass to WellReadingsList (replace existing line 174):
```tsx
<WellReadingsList
  readings={readings}
  onReadingClick={handleReadingClick}
/>
```

Render EditReadingSheet after WellReadingsList (inside the content area):
```tsx
{editSheetOpen && selectedReading && currentWell && (
  <EditReadingSheet
    open={editSheetOpen}
    onClose={handleEditClose}
    reading={selectedReading}
    wellUnits={currentWell.units}
    wellMultiplier={currentWell.multiplier}
  />
)}
```
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify WellReadingsList renders button elements when onReadingClick is provided. Verify WellDetailSheet imports and renders EditReadingSheet with correct props.</verify>
  <done>Reading rows are tappable buttons that open EditReadingSheet. Users can edit the value, save changes (PowerSync UPDATE + toast), or delete the reading (confirmation dialog + PowerSync DELETE + toast). All roles have access.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Tapping a reading row in the well detail sheet opens EditReadingSheet with the reading's value pre-filled
3. Editing the value and tapping Save executes a PowerSync UPDATE and shows "Reading updated" toast
4. Tapping Delete opens ConfirmDeleteReadingDialog with the reading value and date
5. Confirming delete executes a PowerSync DELETE and shows "Reading deleted" toast
6. The readings list updates reactively after edit or delete (PowerSync reactive queries)
7. Invalid input (empty, non-numeric, negative) shows validation error
8. Cancel button closes the sheet without changes
</verification>

<success_criteria>
- All authenticated users can tap a reading to edit its value
- All authenticated users can delete a reading with confirmation
- EditReadingSheet shows pre-filled value with unit/multiplier context
- ConfirmDeleteReadingDialog follows the established delete dialog pattern
- Toast notifications confirm success or report errors
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-reading-management-map-integration/16-01-SUMMARY.md`
</output>
