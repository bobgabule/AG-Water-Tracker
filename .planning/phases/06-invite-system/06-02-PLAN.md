# Plan 06-02: End-to-End Verification

## Goal
Verify the complete invite flow works end-to-end against the Phase 6 success criteria.

## Prerequisites
- Migration 026 applied to Supabase
- PowerSync dashboard sync rules updated with new column names
- Twilio environment variables configured on Supabase Edge Functions (or accept SMS warning)

## Tasks

### Task 1: Apply Migration
- Run migration 026 against Supabase database
- Verify schema changes via Supabase dashboard (farm_invites table columns)
- Confirm PostgREST schema reload (`NOTIFY pgrst, 'reload schema'`)

### Task 2: Update PowerSync Sync Rules
- Log into PowerSync dashboard
- Update farm_invites sync rules: replace `invited_name` with `invited_first_name, invited_last_name`
- Also update user_profile sync rules to include `first_name, last_name, email`
- Deploy updated rules

### Task 3: E2E Test Scenarios

**Scenario 1: Invite Creation (SC #1)**
1. Log in as grower/admin
2. Navigate to Settings
3. Click "Add User"
4. Fill: first name, last name, phone (10 digits), select role
5. Click "Send Invite"
6. Verify: success message shown, invite appears in PendingInvitesList as "Pending"

**Scenario 2: SMS Delivery (SC #2)**
1. After creating invite, check if SMS was sent (or warning shown)
2. If Twilio configured: verify SMS contains farm name and app link
3. If not configured: verify yellow warning "SMS could not be sent"

**Scenario 3: Invited User Onboarding (SC #3, #4, #5)**
1. Open app in incognito/new device
2. Enter the invited phone number
3. Enter OTP code
4. Verify: user lands directly on dashboard (no profile/farm creation pages)
5. Verify: user's profile has correct first_name, last_name, display_name
6. Verify: user is in correct farm with correct role

**Scenario 4: Invite Status Update**
1. After invited user joins, check PendingInvitesList
2. Verify: invite status changed from "Pending" to "Joined"

**Scenario 5: Edge Cases**
- Duplicate invite attempt → "An invite for this phone number already exists"
- Already-member phone → "This person is already a member of your farm"
- Revoke pending invite → invite disappears from list
- Expired invite → not matched during onboarding (user enters grower flow)

## Success Criteria Verification

| # | Criteria | How to Verify |
|---|----------|---------------|
| 1 | Grower fills form (first name, last name, phone, role) → record created | Scenario 1 |
| 2 | SMS with farm name and link | Scenario 2 |
| 3 | Invited user OTP → dashboard directly | Scenario 3 |
| 4 | Profile auto-created with first/last name | Scenario 3, step 5 |
| 5 | Correct farm + role assigned | Scenario 3, step 6 |
