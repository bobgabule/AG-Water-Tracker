---
phase: 20-subscription-limits-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/subscriptionUrls.ts
  - src/hooks/useWellCount.ts
  - src/components/WellLimitModal.tsx
  - src/pages/DashboardPage.tsx
  - src/pages/WellListPage.tsx
autonomous: true
requirements: [TIER-06]

must_haves:
  truths:
    - "Tapping 'New Well' when at tier well limit shows a 'Well Limit Reached' modal instead of starting location picker"
    - "Modal appears in both DashboardPage and WellListPage"
    - "Growers see an 'Upgrade Plan' button in the modal that opens external subscription URL with farm_id and tier params"
    - "Admins see the modal with dismiss only (no upgrade CTA)"
    - "If tier data hasn't loaded yet (offline edge case), well creation is allowed (no enforcement)"
    - "When a well is deleted and count drops below limit, 'New Well' works again immediately"
  artifacts:
    - path: "src/lib/subscriptionUrls.ts"
      provides: "Shared URL builder for external subscription links"
      exports: ["buildSubscriptionUrl"]
    - path: "src/hooks/useWellCount.ts"
      provides: "Well count query from local PowerSync data"
      exports: ["useWellCount"]
    - path: "src/components/WellLimitModal.tsx"
      provides: "Well limit reached modal dialog"
      exports: ["default"]
    - path: "src/pages/DashboardPage.tsx"
      provides: "New Well button with limit check"
      contains: "useWellCount"
    - path: "src/pages/WellListPage.tsx"
      provides: "New Well button with limit check and inline modal"
      contains: "useWellCount"
  key_links:
    - from: "src/pages/DashboardPage.tsx"
      to: "src/hooks/useWellCount.ts"
      via: "useWellCount hook call in handleNewWell guard"
      pattern: "useWellCount"
    - from: "src/pages/WellListPage.tsx"
      to: "src/hooks/useWellCount.ts"
      via: "useWellCount hook call in handleNewWell guard"
      pattern: "useWellCount"
    - from: "src/components/WellLimitModal.tsx"
      to: "src/lib/subscriptionUrls.ts"
      via: "buildSubscriptionUrl for upgrade link"
      pattern: "buildSubscriptionUrl"
---

<objective>
Create well limit enforcement that intercepts the "New Well" button on both DashboardPage and WellListPage, showing a lightweight modal when the farm has reached its tier well limit.

Purpose: TIER-06 requires preventing well creation beyond tier limits. The enforcement is client-side using local PowerSync data, with a friendly modal explaining the limit and offering upgrade links to growers.

Output: `subscriptionUrls.ts` utility, `useWellCount` hook, `WellLimitModal` component, and wired-up limit checks in DashboardPage and WellListPage.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-subscription-limits-page/20-CONTEXT.md
@.planning/phases/20-subscription-limits-page/20-RESEARCH.md
@.planning/phases/18-tier-sync-hooks/18-02-SUMMARY.md

@src/hooks/useSubscriptionTier.ts
@src/components/ConfirmDeleteWellDialog.tsx
@src/pages/DashboardPage.tsx
@src/pages/WellListPage.tsx
@src/lib/permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared subscription URL builder and useWellCount hook</name>
  <files>src/lib/subscriptionUrls.ts, src/hooks/useWellCount.ts</files>
  <action>
**1. Create `src/lib/subscriptionUrls.ts`:**
- Export `buildSubscriptionUrl(baseUrl: string, farmId: string, tierSlug: string): string`
- Check if `baseUrl` already contains `?` -- if so use `&` separator, otherwise use `?`
- Append `farm_id=${farmId}&tier=${tierSlug}`
- This will be reused by WellLimitModal, AddUserModal, SubscriptionPage, and SettingsPage

**2. Create `src/hooks/useWellCount.ts`:**
- Export `useWellCount(): number`
- Get `farmId` from `useAuth().onboardingStatus?.farmId`
- Query: `SELECT COUNT(*) as count FROM wells WHERE farm_id = ?` (NO status filter -- per user decision, count includes all non-deleted wells; wells are hard-deleted so no additional filter needed)
- Guard empty query: `'SELECT NULL WHERE 0'` when farmId is null
- Use `useQuery<{ count: number }>` from `@powersync/react`
- Memoize result with `useMemo(() => data?.[0]?.count ?? 0, [data])`

Anti-patterns to avoid:
- Do NOT filter by `status = 'active'` -- user explicitly decided all non-deleted wells count
- Do NOT use `useWells().wells.length` -- that loads all well data unnecessarily
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors in new files. Verify `useWellCount` returns a number type and `buildSubscriptionUrl` handles both `?` and `&` separators.</verify>
  <done>Both files exist with correct exports. `useWellCount` queries all wells for the farm (no status filter). `buildSubscriptionUrl` correctly handles URL separator logic.</done>
</task>

<task type="auto">
  <name>Task 2: Create WellLimitModal and wire limit checks into DashboardPage and WellListPage</name>
  <files>src/components/WellLimitModal.tsx, src/pages/DashboardPage.tsx, src/pages/WellListPage.tsx</files>
  <action>
**1. Create `src/components/WellLimitModal.tsx`:**

Follow the exact Headless UI v2 Dialog pattern from `ConfirmDeleteWellDialog.tsx`. Props:
```typescript
interface WellLimitModalProps {
  open: boolean;
  onClose: () => void;
  upgradeUrl: string | null;  // null when subscription_website_url not configured
  isGrower: boolean;          // true for grower/super_admin, false for admin
}
```

Structure:
- `Dialog` + `DialogBackdrop` with transition (same classes as ConfirmDeleteWellDialog)
- `DialogPanel` centered with `max-w-sm`, dark theme (`bg-gray-800`)
- Close button (XMarkIcon) at top-right, closes via `onClose`
- `DialogTitle`: "Well Limit Reached"
- Body text: "You've reached your well limit. Upgrade your plan for more wells."
- If `isGrower` is true: render an `<a>` button "Upgrade Plan" with `ArrowTopRightOnSquareIcon`, opens `upgradeUrl` in new tab (`target="_blank"`, `rel="noopener noreferrer"`). If `upgradeUrl` is null, render disabled (opacity-50, pointer-events-none).
- If `isGrower` is false (admin): do NOT render the upgrade button -- modal is dismiss-only
- Close via X button or tap outside (Dialog's `onClose` handles backdrop click)
- Simple design: text + button only, no icon or illustration per user decision
- Use project color `bg-[#5f7248]` for the upgrade button to match existing "Manage Plan" button style

**2. Modify `src/pages/DashboardPage.tsx`:**

Add imports:
- `useSubscriptionTier` from `../hooks/useSubscriptionTier`
- `useWellCount` from `../hooks/useWellCount`
- `useAppSetting` from `../hooks/useAppSetting`
- `buildSubscriptionUrl` from `../lib/subscriptionUrls`
- `WellLimitModal` from `../components/WellLimitModal`

Inside component:
- Call `const tier = useSubscriptionTier();`
- Call `const wellCount = useWellCount();`
- Call `const subscriptionUrl = useAppSetting('subscription_website_url');`
- Add state: `const [showLimitModal, setShowLimitModal] = useState(false);`
- Determine `isGrower`: `role === 'grower' || role === 'super_admin'`
- Compute `upgradeUrl`: if `subscriptionUrl && farmId && tier`, call `buildSubscriptionUrl(subscriptionUrl, farmId, tier.slug)`, else `null`

Update `handleNewWell`:
```typescript
const handleNewWell = useCallback(() => {
  // Allow creation if tier data hasn't loaded (offline edge case per user decision)
  if (tier && wellCount >= tier.maxWells) {
    setShowLimitModal(true);
    return;
  }
  setCurrentStep('location');
}, [tier, wellCount]);
```

Add `handleLimitModalClose`:
```typescript
const handleLimitModalClose = useCallback(() => {
  setShowLimitModal(false);
}, []);
```

Render `WellLimitModal` at bottom of JSX (before closing fragment):
```tsx
<WellLimitModal
  open={showLimitModal}
  onClose={handleLimitModalClose}
  upgradeUrl={upgradeUrl}
  isGrower={isGrower}
/>
```

**3. Modify `src/pages/WellListPage.tsx`:**

WellListPage currently navigates to `/wells/new` which doesn't exist as a standalone route. Change it to show the limit modal inline.

Add imports:
- `useSubscriptionTier` from `../hooks/useSubscriptionTier`
- `useWellCount` from `../hooks/useWellCount`
- `useAppSetting` from `../hooks/useAppSetting`
- `buildSubscriptionUrl` from `../lib/subscriptionUrls`
- `WellLimitModal` from `../components/WellLimitModal`
- `useUserRole` is already imported

Inside component:
- Call `const tier = useSubscriptionTier();`
- Call `const wellCount = useWellCount();`
- Call `const subscriptionUrl = useAppSetting('subscription_website_url');`
- Add state: `const [showLimitModal, setShowLimitModal] = useState(false);`
- Determine `isGrower`: `role === 'grower' || role === 'super_admin'`
- Compute `upgradeUrl`: same pattern as DashboardPage

Update `handleNewWell`:
```typescript
const handleNewWell = useCallback(() => {
  // Allow creation if tier data hasn't loaded (offline edge case)
  if (tier && wellCount >= tier.maxWells) {
    setShowLimitModal(true);
    return;
  }
  navigate('/wells/new');
}, [tier, wellCount, navigate]);
```

Note: Keep the `navigate('/wells/new')` fallback for non-limit case since WellListPage redirects to DashboardPage flow via routing.

Add `handleLimitModalClose`:
```typescript
const handleLimitModalClose = useCallback(() => {
  setShowLimitModal(false);
}, []);
```

Render `WellLimitModal` inside the component JSX (before or after the bottom action buttons div):
```tsx
<WellLimitModal
  open={showLimitModal}
  onClose={handleLimitModalClose}
  upgradeUrl={upgradeUrl}
  isGrower={isGrower}
/>
```
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify WellLimitModal renders with Dialog/DialogBackdrop/DialogPanel pattern. Verify DashboardPage and WellListPage both import useWellCount and useSubscriptionTier and check limits before proceeding.</verify>
  <done>WellLimitModal component exists with role-based upgrade CTA. Both DashboardPage and WellListPage intercept "New Well" tap at tier limit and show the modal. Null tier allows creation (offline edge case). Button stays tappable (not disabled).</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. `WellLimitModal.tsx` uses Headless UI v2 Dialog pattern (Dialog, DialogBackdrop, DialogPanel, DialogTitle)
3. `useWellCount.ts` queries `COUNT(*) FROM wells WHERE farm_id = ?` with NO status filter
4. `buildSubscriptionUrl` appends `?farm_id=X&tier=slug` (or `&` if `?` already exists)
5. DashboardPage `handleNewWell` checks `tier && wellCount >= tier.maxWells` before `setCurrentStep('location')`
6. WellListPage `handleNewWell` checks `tier && wellCount >= tier.maxWells` before `navigate('/wells/new')`
7. Modal shows "Upgrade Plan" button only when `isGrower` is true
8. Modal shows disabled "Upgrade Plan" when `upgradeUrl` is null
</verification>

<success_criteria>
- Tapping "New Well" at tier limit shows the WellLimitModal on both DashboardPage and WellListPage
- Growers see "Upgrade Plan" linking to external URL with `?farm_id=X&tier=slug` params
- Admins see dismiss-only modal (no upgrade CTA)
- Well creation allowed when tier data is null (offline grace)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-subscription-limits-page/20-01-SUMMARY.md`
</output>
