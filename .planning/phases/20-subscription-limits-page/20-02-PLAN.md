---
phase: 20-subscription-limits-page
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - src/components/AddUserModal.tsx
  - src/pages/SubscriptionPage.tsx
  - src/pages/SettingsPage.tsx
autonomous: true
requirements: [TIER-07, TIER-08]

must_haves:
  truths:
    - "AddUserModal 'All seats are filled' state shows an 'Upgrade Plan' link for growers that opens external subscription URL with farm_id and tier params"
    - "AddUserModal 'All seats are filled' state does NOT show upgrade link for admin callers"
    - "SubscriptionPage well count includes all non-deleted wells (no status='active' filter)"
    - "SubscriptionPage 'Manage Plan' button URL includes ?farm_id=X&tier=slug params"
    - "Settings page shows 'Manage Subscription' link for growers only"
    - "All external subscription URLs use the shared buildSubscriptionUrl utility with consistent params"
  artifacts:
    - path: "src/components/AddUserModal.tsx"
      provides: "Upgrade Plan link in allSeatsFull state"
      contains: "buildSubscriptionUrl"
    - path: "src/pages/SubscriptionPage.tsx"
      provides: "Fixed well count query and tier-parameterized Manage Plan URL"
      contains: "buildSubscriptionUrl"
    - path: "src/pages/SettingsPage.tsx"
      provides: "Manage Subscription navigation link for growers"
      contains: "Manage Subscription"
  key_links:
    - from: "src/components/AddUserModal.tsx"
      to: "src/lib/subscriptionUrls.ts"
      via: "buildSubscriptionUrl for upgrade link URL"
      pattern: "buildSubscriptionUrl"
    - from: "src/pages/SubscriptionPage.tsx"
      to: "src/lib/subscriptionUrls.ts"
      via: "buildSubscriptionUrl for Manage Plan URL"
      pattern: "buildSubscriptionUrl"
    - from: "src/pages/SubscriptionPage.tsx"
      to: "src/hooks/useWellCount.ts"
      via: "useWellCount replacing inline well count query"
      pattern: "useWellCount"
    - from: "src/pages/SettingsPage.tsx"
      to: "/subscription"
      via: "navigate('/subscription') on link click"
      pattern: "navigate.*subscription"
---

<objective>
Add upgrade path links to seat limit UI, fix subscription page well count query to match enforcement logic, add tier params to all external URLs, and add a "Manage Subscription" link on the Settings page for growers.

Purpose: TIER-07 requires an upgrade path when seats are full (the DB-driven enforcement already works from Phase 18). TIER-08 requires the subscription page to show consistent well counts and properly parameterized external links. Together these complete the subscription limits user experience.

Output: Updated AddUserModal with upgrade link, updated SubscriptionPage with consistent well count and URL params, updated SettingsPage with subscription navigation link.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-subscription-limits-page/20-CONTEXT.md
@.planning/phases/20-subscription-limits-page/20-RESEARCH.md
@.planning/phases/20-subscription-limits-page/20-01-SUMMARY.md

@src/components/AddUserModal.tsx
@src/pages/SubscriptionPage.tsx
@src/pages/SettingsPage.tsx
@src/lib/subscriptionUrls.ts
@src/hooks/useWellCount.ts
@src/hooks/useSubscriptionTier.ts
@src/hooks/useAppSetting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add upgrade link to AddUserModal and fix SubscriptionPage well count and URL</name>
  <files>src/components/AddUserModal.tsx, src/pages/SubscriptionPage.tsx</files>
  <action>
**1. Modify `src/components/AddUserModal.tsx`:**

Add imports:
- `import { ArrowTopRightOnSquareIcon } from '@heroicons/react/24/outline';`
- `import { useAppSetting } from '../hooks/useAppSetting';`
- `import { buildSubscriptionUrl } from '../lib/subscriptionUrls';`

Inside the component, after existing `const tier = useSubscriptionTier();`:
- Add: `const subscriptionUrl = useAppSetting('subscription_website_url');`
- Compute `upgradeUrl`: `const upgradeUrl = subscriptionUrl && onboardingStatus?.farmId && tier ? buildSubscriptionUrl(subscriptionUrl, onboardingStatus.farmId, tier.slug) : null;`

In the `allSeatsFull` block (the `<div className="py-8 text-center">` after the `!tier` loading guard), replace the existing static "Contact us to upgrade your plan" `<p>` tag with:
```tsx
{(callerRole === 'grower' || callerRole === 'super_admin') && upgradeUrl ? (
  <a
    href={upgradeUrl}
    target="_blank"
    rel="noopener noreferrer"
    className="inline-flex items-center gap-1.5 text-sm text-[#bdefda] font-medium mt-2 hover:text-white transition-colors"
  >
    Upgrade Plan
    <ArrowTopRightOnSquareIcon className="h-4 w-4" />
  </a>
) : (callerRole === 'grower' || callerRole === 'super_admin') && !upgradeUrl ? (
  <span className="inline-flex items-center gap-1.5 text-sm text-[#bdefda]/50 font-medium mt-2">
    Upgrade Plan
    <ArrowTopRightOnSquareIcon className="h-4 w-4" />
  </span>
) : (
  <p className="text-yellow-300 text-sm font-medium">
    Contact your farm owner to upgrade
  </p>
)}
```

Key behaviors:
- Grower/super_admin with valid URL: clickable "Upgrade Plan" link opening external URL
- Grower/super_admin without URL: disabled-looking "Upgrade Plan" (50% opacity, not clickable)
- Admin caller: "Contact your farm owner to upgrade" (they cannot manage subscriptions)
- Upgrade link visible to growers only per user decision

**2. Modify `src/pages/SubscriptionPage.tsx`:**

Add imports:
- `import { useWellCount } from '../hooks/useWellCount';` (from plan 20-01)
- `import { buildSubscriptionUrl } from '../lib/subscriptionUrls';` (from plan 20-01)
- `import { useSubscriptionTier } from '../hooks/useSubscriptionTier';` (already imported)

Replace the inline well count query with the shared `useWellCount` hook:
- Remove the `wellCountQuery` const, the `useQuery<{ count: number }>` call, and the `useMemo` for `wellCount`
- Remove the `useQuery` import from `@powersync/react` (no longer needed)
- Remove the `useMemo` import from `react` (no longer needed)
- Replace with: `const wellCount = useWellCount();`

This ensures the well count logic matches enforcement: all non-deleted wells, no `status = 'active'` filter. The `useWellCount` hook (created in plan 20-01) already uses `COUNT(*) FROM wells WHERE farm_id = ?`.

Update the "Manage Plan" button URL to use `buildSubscriptionUrl`:
- Replace the inline URL construction `${subscriptionUrl}${subscriptionUrl.includes('?') ? '&' : '?'}farm_id=${farmId}` with:
  ```tsx
  {subscriptionUrl && subscriptionUrl.trim() !== '' && farmId && tier && (
    <a
      href={buildSubscriptionUrl(subscriptionUrl, farmId, tier.slug)}
      target="_blank"
      rel="noopener noreferrer"
      className="mt-4 inline-flex items-center justify-center gap-2 w-full bg-[#5f7248] text-white rounded-lg px-4 py-3 font-medium text-sm hover:bg-[#4e6339] transition-colors"
    >
      Manage Plan
      <ArrowTopRightOnSquareIcon className="h-4 w-4" />
    </a>
  )}
  ```
- Add `tier` to the conditional guard so the tier slug is available for the URL
- This appends `?farm_id=X&tier=slug` to the URL per user decision

Anti-patterns to avoid:
- Do NOT keep the inline well count query -- use the shared `useWellCount` hook
- Do NOT construct URLs differently than other components -- use `buildSubscriptionUrl`
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify AddUserModal imports buildSubscriptionUrl and useAppSetting. Verify SubscriptionPage no longer has inline well count query. Verify SubscriptionPage Manage Plan URL uses buildSubscriptionUrl with tier.slug.</verify>
  <done>AddUserModal shows "Upgrade Plan" link for growers in allSeatsFull state with farm_id+tier URL params. SubscriptionPage well count uses shared useWellCount hook (no status filter). SubscriptionPage Manage Plan URL includes tier param via buildSubscriptionUrl.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Manage Subscription" link on Settings page for growers</name>
  <files>src/pages/SettingsPage.tsx</files>
  <action>
**Modify `src/pages/SettingsPage.tsx`:**

Add imports:
- `import { CreditCardIcon, ChevronRightIcon } from '@heroicons/react/24/outline';` (add to existing icon imports)

The `canManageFarm` variable already exists (from Phase 19: `const canManageFarm = hasPermission(userRole, 'manage_farm');`). This maps to grower + super_admin only per the permission matrix -- verified in research.

Add a new "Subscription" section to the page. Place it AFTER the "Farm" section (Farm ID setting) and BEFORE the "Account" section (profile editing). The section should be visible only when `canManageFarm` is true:

```tsx
{canManageFarm && (
  <section className="mb-6">
    <h2 className="text-sm font-semibold text-[#5f7248]/70 uppercase tracking-wider mb-2 px-1">
      Subscription
    </h2>
    <div className="bg-[#dfe4d4] rounded-lg overflow-hidden">
      <button
        onClick={() => navigate('/subscription')}
        className="w-full flex items-center gap-3 p-4 text-[#5f7248] hover:bg-[#c5cdb4]/50 transition-colors text-left"
      >
        <CreditCardIcon className="h-5 w-5 text-[#5f7248]/70 flex-shrink-0" />
        <span className="text-sm font-medium flex-1">Manage Subscription</span>
        <ChevronRightIcon className="h-4 w-4 text-[#5f7248]/50" />
      </button>
    </div>
  </section>
)}
```

Style notes:
- Match the existing SettingsPage design language: light green theme (`bg-[#dfe4d4]`, `text-[#5f7248]`)
- Section heading matches the existing "Farm" and "Account" section heading style
- Button uses full-width row with icon, label, and chevron (standard settings navigation pattern)
- `navigate('/subscription')` goes to the existing SubscriptionPage route (already guarded by `RequireRole action="manage_farm"`)

Note: Look at the existing page structure to find the exact right insertion point. The SettingsPage has distinct sections -- Farm ID at top (hidden for meter_checker per Phase 19), then profile/account section, then sign out button. Insert the Subscription section between the Farm section and the Account/profile section.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify SettingsPage imports CreditCardIcon and ChevronRightIcon. Verify Subscription section is wrapped in `canManageFarm` conditional. Verify the button navigates to `/subscription`.</verify>
  <done>"Manage Subscription" link appears on Settings page for growers/super_admin only. Tapping it navigates to /subscription. Link is hidden for admin and meter_checker roles.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. AddUserModal: "All seats are filled" state shows "Upgrade Plan" link for grower callers, "Contact your farm owner to upgrade" for admin callers
3. AddUserModal: Upgrade link URL includes `?farm_id=X&tier=slug` params via `buildSubscriptionUrl`
4. SubscriptionPage: Well count uses `useWellCount` hook (no `status = 'active'` filter)
5. SubscriptionPage: "Manage Plan" URL includes `&tier=slug` param via `buildSubscriptionUrl`
6. SettingsPage: "Manage Subscription" row visible only when `canManageFarm` is true
7. SettingsPage: Tapping "Manage Subscription" navigates to `/subscription`
8. All external subscription URLs constructed via shared `buildSubscriptionUrl` utility
</verification>

<success_criteria>
- AddUserModal upgrade path works for growers (link to external URL with params) and shows appropriate messaging for admins
- SubscriptionPage well count matches enforcement logic (all non-deleted wells, no status filter)
- SubscriptionPage Manage Plan URL has farm_id and tier params
- Settings page has persistent "Manage Subscription" link for growers
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-subscription-limits-page/20-02-SUMMARY.md`
</output>
