---
phase: 15-well-editing-allocation-management
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - src/pages/WellAllocationsPage.tsx
  - src/components/MonthYearPicker.tsx
  - src/components/ConfirmDeleteAllocationDialog.tsx
  - src/App.tsx
autonomous: true
requirements:
  - ALLOC-01
  - ALLOC-02
  - ALLOC-03
  - ALLOC-04
  - ALLOC-05
  - ALLOC-06

must_haves:
  truths:
    - "User can view all allocation periods in a table"
    - "User can create a new allocation with start date, end date, allocated AF, and starting reading"
    - "User can edit an existing allocation by tapping its table row"
    - "User can delete an allocation with confirmation"
    - "Overlapping allocation periods are blocked with validation error"
    - "Usage is auto-calculated from readings using (latest - starting_reading) x multiplier converted to AF"
    - "User can manually override the Used value"
    - "Manually overridden allocations show 'M' indicator in the table"
    - "Date picker uses month/year scroll wheel (not calendar)"
  artifacts:
    - path: "src/pages/WellAllocationsPage.tsx"
      provides: "Full-page allocation management with inline form and table"
      min_lines: 250
    - path: "src/components/MonthYearPicker.tsx"
      provides: "iOS-style month/year scroll wheel picker"
      min_lines: 30
    - path: "src/components/ConfirmDeleteAllocationDialog.tsx"
      provides: "Delete allocation confirmation dialog"
      min_lines: 30
    - path: "src/App.tsx"
      provides: "Route for /wells/:id/allocations"
      contains: "WellAllocationsPage"
  key_links:
    - from: "src/pages/WellAllocationsPage.tsx"
      to: "src/lib/usage-calculation.ts"
      via: "calculateUsageAf for auto-calculation"
      pattern: "calculateUsageAf"
    - from: "src/pages/WellAllocationsPage.tsx"
      to: "PowerSync allocations table"
      via: "INSERT, UPDATE, DELETE for allocation CRUD"
      pattern: "INSERT INTO allocations|UPDATE allocations|DELETE FROM allocations"
    - from: "src/pages/WellAllocationsPage.tsx"
      to: "src/hooks/useWellAllocations.ts"
      via: "Reactive allocation list query"
      pattern: "useWellAllocations"
    - from: "src/pages/WellAllocationsPage.tsx"
      to: "src/components/MonthYearPicker.tsx"
      via: "Date picker for allocation start/end dates"
      pattern: "MonthYearPicker"
---

<objective>
Build the allocation management page with inline CRUD form, month/year date picker, usage auto-calculation, and manual override support.

Purpose: Enable users to create, view, edit, and delete allocation periods for a well. Each allocation tracks a time period, allocated amount in AF, a starting reading baseline, and used amount (auto-calculated from readings or manually overridden).

Output: WellAllocationsPage with inline form and table, MonthYearPicker component, ConfirmDeleteAllocationDialog, and route registration.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-well-editing-allocation-management/15-RESEARCH.md
@.planning/phases/15-well-editing-allocation-management/15-CONTEXT.md
@.planning/phases/15-well-editing-allocation-management/15-01-SUMMARY.md
@.planning/phases/15-well-editing-allocation-management/15-02-SUMMARY.md
@src/hooks/useWellAllocations.ts
@src/hooks/useWellReadings.ts
@src/hooks/useWells.ts
@src/lib/usage-calculation.ts
@src/lib/powersync-schema.ts
@src/components/ConfirmDeleteMemberDialog.tsx
@src/stores/toastStore.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: MonthYearPicker component, WellAllocationsPage with inline form, and create/edit allocation</name>
  <files>src/components/MonthYearPicker.tsx, src/pages/WellAllocationsPage.tsx, src/App.tsx</files>
  <action>
**Install react-mobile-picker:**
```bash
npm install react-mobile-picker
```
If TypeScript types are missing, create a minimal declaration file `src/types/react-mobile-picker.d.ts`. If the library has types, skip the declaration file.

**Create `src/components/MonthYearPicker.tsx`:**

A reusable month/year scroll wheel picker using `react-mobile-picker`.

Props:
```typescript
interface MonthYearPickerProps {
  month: string; // '01' through '12'
  year: string;  // e.g., '2026'
  onChange: (month: string, year: string) => void;
}
```

Implementation:
- `MONTHS` array: `['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']`
- `YEARS` array: 2020 through 2040 as strings
- Use `Picker` from `react-mobile-picker` with `Picker.Column` for month and year
- `wheelMode="natural"` prop for natural scroll direction
- Convert month name back to zero-padded number on change: `String(MONTHS.indexOf(newValue.month) + 1).padStart(2, '0')`
- Style with a container that has rounded borders and a reasonable height (~200px)

**Create `src/pages/WellAllocationsPage.tsx`:**

Full-page route at `/wells/:id/allocations`.

**Page header:**
- Green background (`bg-[#5f7248]`) matching edit page
- Back button (ArrowLeftIcon) navigating to `/wells/${id}/edit`
- Farm name subtitle (from `useAuth().onboardingStatus.farmName`)
- Well name + "Updated" timestamp
- "EDIT WELL ALLOCATIONS" title text

**Data hooks:**
- `useParams<{ id: string }>()` for well ID
- `useWells()` to get well data (for name, units, multiplier)
- `useWellAllocations(id)` for reactive allocation list
- `useWellReadings(id)` for readings data (needed for usage auto-calculation)
- `usePowerSync()` for database mutations
- `useAuth()` for farm name and farm ID

**Inline form (collapsed by default):**
- State: `formVisible: boolean`, `selectedId: string | null` (null = creating new)
- When visible, render a card/section at top with:
  - **Start Date** field: shows formatted month/year (e.g., "Jan 2026"). Tapping opens MonthYearPicker. Day auto-set to 1st of selected month. Store as ISO date string `YYYY-MM-01`.
  - **End Date** field: same MonthYearPicker. Day auto-set to last day of selected month. Use `new Date(year, monthIndex + 1, 0).getDate()` to find last day. Store as `YYYY-MM-DD`.
  - **Allocated (AF)** field: numeric text input (`inputMode="decimal"`) for the allocated water amount in acre-feet.
  - **Starting Reading** field: numeric text input for the baseline meter value.
  - **Used (AF)** field: numeric text input. Pre-filled with auto-calculated value (see usage calculation below). User can type to override. When user types a value, this constitutes a manual override.
  - Date picker visibility: use separate state `showStartPicker: boolean` and `showEndPicker: boolean`. When a date field is tapped, toggle its picker open. The picker appears inline below the field.
  - "Close" button: hides the form, resets `selectedId` to null
  - "Save" button: validates and persists (see save logic below)
  - If editing (selectedId !== null): also show "Delete" button (red text)

**Form state management:**
- `formStartMonth`, `formStartYear`, `formEndMonth`, `formEndYear`: string state for pickers
- `formAllocatedAf`: string state for allocated amount
- `formStartingReading`: string state for starting reading
- `formUsedAf`: string state for used amount
- `isManualOverride`: boolean — set to `true` when user types in the Used field. When creating new or loading existing auto-calculated allocation, set to `false` and pre-compute used value.

**Usage auto-calculation:**
- Import `calculateUsageAf` from `src/lib/usage-calculation.ts`
- For a given allocation period, find the latest reading within `[period_start, period_end]` from the readings array:
  ```typescript
  const readingsInPeriod = readings.filter(r =>
    r.recordedAt >= periodStart && r.recordedAt <= periodEnd
  );
  const latestReading = readingsInPeriod.length > 0 ? readingsInPeriod[0] : null; // already sorted DESC
  ```
- If a latest reading exists and starting reading is set:
  ```typescript
  const autoUsed = calculateUsageAf(latestReading.value, startingReading, well.multiplier, well.units);
  ```
- Pre-fill `formUsedAf` with `autoUsed.toFixed(2)` when loading a non-override allocation or creating new.
- When user modifies the Used (AF) field directly, set `isManualOverride = true`.

**Tapping a table row (edit mode):**
- `handleRowClick(allocation)`: Set `selectedId = allocation.id`, open form, populate fields from allocation data:
  - Parse `periodStart` to extract month/year for MonthYearPicker
  - Parse `periodEnd` to extract month/year
  - Set `formAllocatedAf` from `allocation.allocatedAf`
  - Set `formStartingReading` from allocation's starting_reading (need to query this — see note below)
  - Set `formUsedAf` from `allocation.usedAf`
  - Set `isManualOverride` from `allocation.isManualOverride`

**Note on starting_reading:** The `useWellAllocations` hook does not currently include `starting_reading` in its query or `Allocation` interface. The executor must update `src/hooks/useWellAllocations.ts`:
- Add `starting_reading` to the SQL SELECT
- Add `startingReading: string` to the `Allocation` interface
- Map `row.starting_reading ?? ''` in the mapper

**"+ Add Allocation" button:**
- Rendered at bottom of page (after the table)
- On tap: reset all form fields to defaults (current month/year for start, empty allocated/starting reading), set `selectedId = null`, set `formVisible = true`

**Overlapping period validation (before save):**
- Build start/end ISO strings from picker values
- Check against all existing allocations (from `useWellAllocations`), excluding the current one if editing:
  ```typescript
  const hasOverlap = allocations
    .filter(a => a.id !== selectedId)
    .some(a => a.periodStart < formEnd && a.periodEnd > formStart);
  ```
- If overlap detected, show inline error message: "This period overlaps with an existing allocation" and block save.

**Save logic:**
- Validate: allocated AF must be > 0, start date < end date (should always be true from picker), no overlap
- If creating new (selectedId === null):
  ```typescript
  const allocationId = crypto.randomUUID();
  const now = new Date().toISOString();
  await db.execute(
    `INSERT INTO allocations (id, well_id, farm_id, period_start, period_end, allocated_af, used_af, is_manual_override, starting_reading, notes, created_at, updated_at)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [allocationId, id, farmId, formStart, formEnd, formAllocatedAf, formUsedAf, isManualOverride ? 1 : 0, formStartingReading, null, now, now]
  );
  ```
- If editing (selectedId !== null):
  ```typescript
  await db.execute(
    `UPDATE allocations SET period_start = ?, period_end = ?, allocated_af = ?, used_af = ?, is_manual_override = ?, starting_reading = ?, updated_at = ? WHERE id = ?`,
    [formStart, formEnd, formAllocatedAf, formUsedAf, isManualOverride ? 1 : 0, formStartingReading, now, selectedId]
  );
  ```
- After save: show success toast ("Allocation saved"), keep form visible (user decision), update selectedId if was creating (so form now shows edit mode for the newly created allocation).

**Add route to `src/App.tsx`:**
- Import `WellAllocationsPage` from `../pages/WellAllocationsPage`
- Add `<Route path="/wells/:id/allocations" element={<WellAllocationsPage />} />` inside the AppLayout route group, after the `/wells/:id/edit` route.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify MonthYearPicker renders with month and year columns. Verify WellAllocationsPage route exists in App.tsx. Verify inline form toggles visibility correctly.</verify>
  <done>MonthYearPicker renders iOS-style scroll wheel for month/year selection. WellAllocationsPage shows allocation management with inline form, can create and edit allocations with start/end dates, allocated AF, starting reading, and used AF. Overlapping periods are validated. Route registered at /wells/:id/allocations.</done>
</task>

<task type="auto">
  <name>Task 2: Allocation table display, delete with confirmation, and usage override indicator</name>
  <files>src/components/ConfirmDeleteAllocationDialog.tsx, src/pages/WellAllocationsPage.tsx, src/hooks/useWellAllocations.ts</files>
  <action>
**Update `src/hooks/useWellAllocations.ts`:**
(This change may have been done in Task 1 if the executor noticed it; if so, skip this part.)
- Add `starting_reading` to the SQL SELECT statement
- Add `startingReading: string` to the `Allocation` interface
- Add mapping: `startingReading: row.starting_reading ?? ''` in the row mapper

**Create `src/components/ConfirmDeleteAllocationDialog.tsx`:**

Follow the `ConfirmDeleteMemberDialog.tsx` pattern. Props:
```typescript
interface ConfirmDeleteAllocationDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: () => void;
  periodLabel: string; // e.g., "Jan 2026 - Dec 2026"
  loading: boolean;
}
```

Dialog content:
- Red exclamation triangle icon
- Title: "Delete Allocation"
- Message: `Delete the allocation period **{periodLabel}**? This cannot be undone.`
- "Cancel" button (gray) and "Delete" button (red, with loading spinner)
- Same styling pattern as ConfirmDeleteMemberDialog

**Add allocation table to WellAllocationsPage.tsx:**

Render the table below the inline form (or in the main content area when form is hidden).

Table structure:
- Header row: Start | End | Used (AF) | Allocated (AF)
- Styled with dark background (gray-800 or similar matching the app theme)
- Each row renders an allocation from `useWellAllocations`:
  - Start: formatted as "MMM YYYY" (e.g., "Jan 2026")
  - End: formatted as "Dec 2026"
  - Used (AF): formatted to 2 decimal places. **If `allocation.isManualOverride` is true, prefix with "M "** to show the manual override indicator (user locked decision: "M" indicator shown in allocation table row).
  - Allocated (AF): formatted to 2 decimal places
- Each row is tappable (onClick calls `handleRowClick(allocation)`)
- Selected row (matching `selectedId`) has a highlight/border indicator

**Instruction text:**
- When no allocation is selected and form is hidden: show "Select or Add an Allocation Below" instruction text above the table.

**Delete allocation handler:**

State: `showDeleteConfirm: boolean`, `deleteLoading: boolean`

The delete button appears in the inline form when editing (selectedId !== null). On tap, show `ConfirmDeleteAllocationDialog`.

Delete handler:
```typescript
const handleDeleteAllocation = useCallback(async () => {
  if (!selectedId) return;
  setDeleteLoading(true);
  try {
    await db.execute('DELETE FROM allocations WHERE id = ?', [selectedId]);
    useToastStore.getState().show('Allocation deleted');
    setFormVisible(false);
    setSelectedId(null);
  } catch {
    useToastStore.getState().show('Failed to delete allocation', 'error');
  } finally {
    setDeleteLoading(false);
    setShowDeleteConfirm(false);
  }
}, [db, selectedId]);
```

Build the `periodLabel` for the dialog from the selected allocation's formatted dates.

**Empty state:**
- When `allocations.length === 0` and form is not visible: show an empty state message "No allocations yet. Tap '+ Add Allocation' to create one."

**Usage auto-recalculation on readings change:**
- When the form is open and `isManualOverride` is false, recalculate `formUsedAf` whenever readings data changes. Use a `useEffect` that watches readings, formStartingReading, formStart, formEnd, and well data. Only update if not manually overridden.

**Table date formatting helper:**
```typescript
function formatPeriodDate(dateStr: string): string {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}
```

Render `ConfirmDeleteAllocationDialog`:
```jsx
<ConfirmDeleteAllocationDialog
  open={showDeleteConfirm}
  onClose={() => setShowDeleteConfirm(false)}
  onConfirm={handleDeleteAllocation}
  periodLabel={selectedAllocation ? `${formatPeriodDate(selectedAllocation.periodStart)} - ${formatPeriodDate(selectedAllocation.periodEnd)}` : ''}
  loading={deleteLoading}
/>
```
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify allocation table renders with correct columns. Verify "M" indicator appears for manually overridden allocations. Verify delete shows confirmation and removes allocation. Verify useWellAllocations includes starting_reading in query and interface.</verify>
  <done>Allocation table displays all periods with Start, End, Used (AF), Allocated (AF) columns. Manually overridden rows show "M" indicator. Tapping a row loads it into the inline form for editing. Delete button in form opens confirmation dialog, deleting the allocation via PowerSync on confirm. Usage auto-calculation updates reactively when readings change. useWellAllocations hook updated with starting_reading field.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Navigate to `/wells/:id/allocations` shows page with well header and empty state
3. "+ Add Allocation" shows inline form with MonthYearPicker for start/end dates
4. Saving a new allocation adds it to the table with correct dates and amounts
5. Tapping a table row loads that allocation into the inline form for editing
6. Overlapping periods show validation error and block save
7. Delete shows confirmation dialog; confirming removes the allocation
8. "M" indicator shows on rows where `is_manual_override = true`
9. Used (AF) auto-calculates from readings when not manually overridden
10. "Back to Well" navigates to `/wells/:id/edit`
11. `useWellAllocations` hook includes `startingReading` field
</verification>

<success_criteria>
- WellAllocationsPage renders at /wells/:id/allocations with well header and allocation table
- MonthYearPicker provides iOS-style scroll wheel for month/year selection
- Create allocation: inline form with start date, end date, allocated AF, starting reading, used AF
- Edit allocation: tap table row to load into inline form, modify, save
- Delete allocation: confirmation dialog, then PowerSync DELETE
- Overlapping periods blocked by validation
- Usage auto-calculated: (latest reading in period - starting reading) x multiplier, converted to AF
- Manual override: user types Used value, isManualOverride set to true, "M" indicator in table
- useWellAllocations hook includes startingReading in query and interface
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-well-editing-allocation-management/15-03-SUMMARY.md`
</output>
