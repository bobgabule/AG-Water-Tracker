---
phase: 15-well-editing-allocation-management
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/pages/WellEditPage.tsx
  - src/components/ConfirmDeleteWellDialog.tsx
  - src/App.tsx
autonomous: true
requirements:
  - EDIT-01
  - EDIT-02
  - EDIT-03

must_haves:
  truths:
    - "User can navigate from well detail sheet to edit form via Edit button"
    - "Edit form pre-fills all well fields from existing data"
    - "User can save well edits and return to well detail with success toast"
    - "User can delete well with cascade and return to map with success toast"
    - "Unsaved changes trigger discard confirmation on back navigation"
    - "Allocation count with link to allocation page is visible in edit form"
    - "Equipment status dropdowns (battery, pump, meter) are editable"
    - "Name and WMIS uniqueness validated before save"
  artifacts:
    - path: "src/pages/WellEditPage.tsx"
      provides: "Full-page well edit form with pre-fill, save, delete, useBlocker"
      min_lines: 200
    - path: "src/components/ConfirmDeleteWellDialog.tsx"
      provides: "Delete well confirmation dialog"
      min_lines: 30
    - path: "src/App.tsx"
      provides: "Route for /wells/:id/edit"
      contains: "WellEditPage"
  key_links:
    - from: "src/pages/WellEditPage.tsx"
      to: "src/stores/wellEditDraftStore.ts"
      via: "Zustand store for draft persistence"
      pattern: "useWellEditDraftStore"
    - from: "src/pages/WellEditPage.tsx"
      to: "src/lib/validation.ts"
      via: "Well name/WMIS uniqueness validation"
      pattern: "isWellNameUnique|isWmisUnique"
    - from: "src/pages/WellEditPage.tsx"
      to: "PowerSync wells table"
      via: "UPDATE and DELETE via db.execute / db.writeTransaction"
      pattern: "UPDATE wells SET|DELETE FROM"
    - from: "src/App.tsx"
      to: "src/pages/WellEditPage.tsx"
      via: "Route definition"
      pattern: "wells/:id/edit"
---

<objective>
Build the well edit form page where users can modify all well properties, delete wells with cascade, and navigate to the allocation management page.

Purpose: Enable editing of existing well data (name, serial, WMIS, coordinates, units, multiplier, equipment status, monthly report) with unsaved changes protection, well deletion, and allocation count display linking to the allocation page.

Output: WellEditPage component, ConfirmDeleteWellDialog component, and route registration.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-well-editing-allocation-management/15-RESEARCH.md
@.planning/phases/15-well-editing-allocation-management/15-CONTEXT.md
@.planning/phases/15-well-editing-allocation-management/15-01-SUMMARY.md
@src/components/AddWellFormBottomSheet.tsx
@src/pages/WellDetailPage.tsx
@src/hooks/useWells.ts
@src/hooks/useWellAllocations.ts
@src/components/ConfirmDeleteMemberDialog.tsx
@src/components/SegmentedControl.tsx
@src/lib/validation.ts
@src/stores/wellEditDraftStore.ts
@src/stores/toastStore.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: WellEditPage with full form, save, GPS, allocation link, and route</name>
  <files>src/pages/WellEditPage.tsx, src/App.tsx</files>
  <action>
**Create `src/pages/WellEditPage.tsx`:**

A full-page form route at `/wells/:id/edit`. The layout MUST match the field order and structure of `AddWellFormBottomSheet.tsx` exactly (user locked decision), but rendered as a full page (not a Dialog bottom sheet).

**Page structure:**
- Green header bar (`bg-[#5f7248]`) with farm name subtitle and "EDIT WELL" title, plus a back button (ArrowLeftIcon) that triggers unsaved changes check
- Scrollable form body with the exact same field order as AddWellFormBottomSheet:
  1. Well Name (text input, required)
  2. Meter Serial Number + WMIS Number (side by side, WMIS required)
  3. Latitude + Longitude + GPS "Use my location" button (same handler pattern as AddWellFormBottomSheet)
  4. **"Allocations -- N Periods" tappable row** (new, not in create form): displays allocation count from `useWellAllocations(id)`. Styled as a card/row with a right chevron arrow. Always tappable. On tap: save form state to `useWellEditDraftStore`, then `navigate(\`/wells/${id}/allocations\`)`.
  5. Units segmented control (AF/GAL/CF) using `SegmentedControl` component
  6. Multiplier segmented control (0.01/1/10/1000/MG) using `SegmentedControl` component
  7. "Send monthly meter reading report" checkbox
  8. Battery State dropdown (select with options: Ok, Low, Critical, Dead, Unknown)
  9. Pump State dropdown (same options)
  10. Meter Status dropdown (same options)
- Footer: Cancel button (left) and Save button (right, with CheckIcon, green bg same as AddWellFormBottomSheet)
- Below footer or at bottom of scrollable area: "Delete Well" button (red, with TrashIcon)

**Form pre-fill logic:**
- Use `useParams` to get `id`, `useWells` to find well data, `useWellAllocations` for count
- On mount: check `useWellEditDraftStore` for a saved draft with matching wellId. If exists, initialize form from draft (user is returning from allocations page). If no draft, initialize from well data.
- Use a `useRef<boolean>(false)` to track whether initialization has occurred, preventing re-initialization on subsequent well data updates (Pitfall 1 from research).
- Use `useEffect` that runs once when well data is first available to set initial state.

**Form state:** Individual `useState` hooks for each field (matching AddWellFormBottomSheet pattern): `name`, `meterSerialNumber`, `wmisNumber`, `latitude`, `longitude`, `units`, `multiplier`, `sendMonthlyReport`, `batteryState`, `pumpState`, `meterStatus`.

**Dirty tracking:**
- `isDirty` computed via `useMemo`: compare each form field against the original well data (or draft if initialized from draft). Any difference = dirty.
- `useBlocker(isDirty)` from react-router to block in-app navigation
- `useEffect` to add/remove `beforeunload` event listener when `isDirty` changes (for browser refresh/tab close)

**Discard changes dialog (inline, not separate component):**
- When `blocker.state === 'blocked'`, render a Headless UI Dialog matching the `ConfirmDeleteMemberDialog` pattern.
- Title: "Discard changes?", message: "You have unsaved changes. Are you sure you want to leave?"
- "Keep Editing" button calls `blocker.reset()`, "Discard" button calls `blocker.proceed()`

**Allocations navigation exception:**
- When user taps the "Allocations" link, save current form state to `useWellEditDraftStore.getState().setDraft(...)` BEFORE navigating. This means the blocker won't fire because we handle it explicitly: set `isDirty` to false (or use a ref flag to bypass blocker) before calling `navigate`.
- Implementation: use a `navigatingToAllocations` ref. Before navigating, set ref to true, save draft, then navigate. In the `useBlocker` condition: `isDirty && !navigatingToAllocations.current`.

**Save handler:**
- Validate: name required, WMIS required, coordinate validation via `getCoordinateValidationError`
- Uniqueness: call `isWellNameUnique(name, wells, id)` and `isWmisUnique(wmisNumber, wells, id)` — pass the wells array from `useWells()`. Show inline error messages if not unique.
- On valid: `await db.execute('UPDATE wells SET name = ?, meter_serial_number = ?, wmis_number = ?, latitude = ?, longitude = ?, units = ?, multiplier = ?, send_monthly_report = ?, battery_state = ?, pump_state = ?, meter_status = ?, updated_at = ? WHERE id = ?', [...values, now, id])`
- After save: `useWellEditDraftStore.getState().clearDraft()`, then `useToastStore.getState().show('Well updated')`, then `navigate(\`/wells/${id}\`)`.

**GPS handler:** Copy the `handleGetLocation` pattern from AddWellFormBottomSheet exactly: navigator.geolocation check, getCurrentPosition with enableHighAccuracy/10s timeout, error handling for denied/timeout/generic.

**Coordinate input handlers:** Copy `handleLatitudeChange` and `handleLongitudeChange` from AddWellFormBottomSheet (parseFloat with range guard).

**Imports:**
- `useParams`, `useNavigate`, `useBlocker` from `react-router`
- `useState`, `useCallback`, `useMemo`, `useEffect`, `useRef` from `react`
- `usePowerSync` from `@powersync/react`
- `ArrowLeftIcon`, `CheckIcon`, `TrashIcon`, `MapPinIcon`, `ChevronRightIcon` from `@heroicons/react/24/outline`
- `Dialog`, `DialogBackdrop`, `DialogPanel` from `@headlessui/react`
- `SegmentedControl` from components
- `useWells` from hooks
- `useWellAllocations` from hooks
- `getCoordinateValidationError`, `isWellNameUnique`, `isWmisUnique` from lib/validation
- `useToastStore` from stores
- `useWellEditDraftStore` from stores
- `useAuth` from lib/AuthProvider

**Styling:** Use the same Tailwind classes as AddWellFormBottomSheet for form inputs, labels, segmented controls, and buttons. The page background should be `bg-[#5f7248]` matching the create form. The header uses white text. Input fields use `bg-gray-50 border border-gray-200 rounded-lg`.

**Add route to `src/App.tsx`:**
- Import `WellEditPage` from `../pages/WellEditPage`
- Add `<Route path="/wells/:id/edit" element={<WellEditPage />} />` inside the AppLayout route group, after the `/wells/:id` route.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify the route exists in App.tsx. Verify WellEditPage imports all necessary dependencies.</verify>
  <done>WellEditPage renders at /wells/:id/edit with all form fields pre-filled from well data, segmented controls for units/multiplier, GPS button, equipment status dropdowns, allocation count link, save with uniqueness validation and PowerSync UPDATE, unsaved changes protection via useBlocker, and draft store integration for allocations round-trip.</done>
</task>

<task type="auto">
  <name>Task 2: Delete well with cascade and confirmation dialog</name>
  <files>src/components/ConfirmDeleteWellDialog.tsx, src/pages/WellEditPage.tsx</files>
  <action>
**Create `src/components/ConfirmDeleteWellDialog.tsx`:**

Follow the `ConfirmDeleteMemberDialog.tsx` pattern exactly. Props:
```typescript
interface ConfirmDeleteWellDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: () => void;
  wellName: string;
  loading: boolean;
}
```

Dialog content:
- Red exclamation triangle icon in red/20 circle
- Title: "Delete Well"
- Message: `Delete **{wellName}** and all its readings and allocations? This cannot be undone.`
- "Cancel" button (gray) and "Delete" button (red, with loading spinner when `loading` is true)
- Same transitions/styling as ConfirmDeleteMemberDialog (gray-800 bg, rounded-2xl, scale-95 data-[closed])

**Wire into WellEditPage.tsx:**

Add state: `const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);` and `const [deleteLoading, setDeleteLoading] = useState(false);`

Add delete handler:
```typescript
const handleDeleteWell = useCallback(async () => {
  setDeleteLoading(true);
  try {
    await db.writeTransaction(async (tx) => {
      await tx.execute('DELETE FROM readings WHERE well_id = ?', [id]);
      await tx.execute('DELETE FROM allocations WHERE well_id = ?', [id]);
      await tx.execute('DELETE FROM wells WHERE id = ?', [id]);
    });
    useWellEditDraftStore.getState().clearDraft();
    useToastStore.getState().show('Well deleted');
    navigate('/');
  } catch {
    useToastStore.getState().show('Failed to delete well', 'error');
  } finally {
    setDeleteLoading(false);
    setShowDeleteConfirm(false);
  }
}, [db, id, navigate]);
```

Key points:
- Use `db.writeTransaction` to delete children first (readings, allocations) then the well — PowerSync local SQLite does NOT enforce FK cascades (Pitfall 2 from research).
- Clear draft store after delete.
- Navigate to `/` (map) after successful delete with success toast.
- Error toast on failure.

Add the "Delete Well" button at the bottom of the form (below the footer save/cancel buttons, or at the end of the scrollable form body):
```jsx
<button
  type="button"
  onClick={() => setShowDeleteConfirm(true)}
  className="w-full py-3 text-red-400 font-medium flex items-center justify-center gap-2 mt-6"
>
  <TrashIcon className="w-5 h-5" />
  Delete Well
</button>
```

Render the dialog:
```jsx
<ConfirmDeleteWellDialog
  open={showDeleteConfirm}
  onClose={() => setShowDeleteConfirm(false)}
  onConfirm={handleDeleteWell}
  wellName={well?.name ?? ''}
  loading={deleteLoading}
/>
```

**Handle edge case:** If the well is not found (user navigated directly to edit URL for nonexistent well), show a brief loading state and then redirect to `/` if well remains null after data loads.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify ConfirmDeleteWellDialog renders with correct structure. Verify delete handler uses writeTransaction with child deletion before parent.</verify>
  <done>Delete Well button at bottom of edit form opens confirmation dialog. Confirming deletes readings, allocations, and well in a single transaction, clears draft, shows success toast, and navigates to map. Cancel dismisses dialog without action.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Navigate to `/wells/:id/edit` shows pre-filled form with all well fields
3. Changing a field and pressing back triggers "Discard changes?" dialog
4. Save validates name/WMIS uniqueness, updates well via PowerSync, shows toast, navigates to well detail
5. "Allocations -- N Periods" link saves draft to store and navigates to allocation page
6. Delete Well shows confirmation dialog, cascade deletes, navigates to map with toast
7. GPS "Use my location" button captures coordinates
8. Equipment status dropdowns (battery, pump, meter) are editable with Ok/Low/Critical/Dead/Unknown options
</verification>

<success_criteria>
- WellEditPage pre-fills all fields from existing well data or draft store
- Save updates well via PowerSync UPDATE and navigates back with success toast
- Delete cascade removes readings + allocations + well in writeTransaction
- useBlocker shows "Discard changes?" when navigating away with unsaved changes
- Allocations link persists form state to draft store before navigating
- Name and WMIS uniqueness validated against farm wells (excluding current well)
- Route /wells/:id/edit registered in App.tsx
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-well-editing-allocation-management/15-02-SUMMARY.md`
</output>
