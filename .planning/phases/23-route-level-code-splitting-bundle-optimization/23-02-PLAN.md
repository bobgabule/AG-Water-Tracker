---
phase: 23-route-level-code-splitting-bundle-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/routePrefetch.ts
  - src/components/SideMenu.tsx
autonomous: true
requirements:
  - SPLIT-05

must_haves:
  truths:
    - "Hovering a side menu link on desktop triggers a prefetch of that page's chunk"
    - "Opening the side menu on mobile prefetches Dashboard and Well List chunks sequentially"
    - "Prefetch is skipped when navigator.connection.saveData is true or navigator.onLine is false"
    - "Each chunk is only prefetched once per session (no duplicate fetches)"
    - "Prefetch on hover is debounced at 100ms to avoid rapid-fire fetches"
  artifacts:
    - path: "src/lib/routePrefetch.ts"
      provides: "Prefetch system with debounce, dedup, save-data awareness, and mobile sequential prefetch"
      contains: "prefetchRoute"
    - path: "src/components/SideMenu.tsx"
      provides: "Side menu with hover prefetch on desktop and sequential prefetch on mobile menu open"
      contains: "prefetchRoute"
  key_links:
    - from: "src/components/SideMenu.tsx"
      to: "src/lib/routePrefetch.ts"
      via: "calls prefetchRoute on hover/touch, calls prefetchOnMenuOpen on menu open"
      pattern: "prefetchRoute|prefetchOnMenuOpen"
    - from: "src/lib/routePrefetch.ts"
      to: "lazy page imports"
      via: "dynamic import() triggers chunk download"
      pattern: "import\\("
---

<objective>
Enhance the prefetch system to debounce hover prefetches, deduplicate fetches, respect data-saver and offline modes, and add mobile-specific sequential prefetch on menu open.

Purpose: Users should experience near-instant navigation by preloading page chunks before they tap. Mobile users get Dashboard and Well List prefetched when they open the menu. Desktop users get hover-triggered prefetch with debounce.

Output: Enhanced routePrefetch.ts with full prefetch logic, updated SideMenu.tsx with mobile menu-open prefetch.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-route-level-code-splitting-bundle-optimization/23-CONTEXT.md
@src/lib/routePrefetch.ts
@src/components/SideMenu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance routePrefetch.ts with debounce, dedup, and network awareness</name>
  <files>
    src/lib/routePrefetch.ts
  </files>
  <action>
Enhance the existing `routePrefetch.ts` in-place. Keep the existing `routeMap` record. Add:

1. **Fetch-once deduplication:**
   - Module-level `Set<string>` called `prefetched` tracking which routes have been fetched
   - Before calling `import()`, check if route is already in the set; if so, return immediately
   - Add to set BEFORE the import call (not after) so concurrent calls don't duplicate

2. **Network awareness (guard at top of prefetchRoute):**
   - If `navigator.onLine === false`, return early (don't prefetch offline)
   - If `(navigator as any).connection?.saveData === true`, return early (respect data-saver mode)
   - Use `(navigator as any)` cast since `NetworkInformation` types aren't standard

3. **Debounced prefetch for hover:**
   - Export `prefetchRouteDebounced(path: string): void` function
   - Uses a module-level `setTimeout` handle; each call clears previous and sets new 100ms timer
   - After 100ms, calls `prefetchRoute(path)`
   - This prevents rapid prefetches when mouse moves across multiple menu items quickly

4. **Sequential prefetch for mobile menu open:**
   - Export `prefetchOnMenuOpen(): void` function
   - Calls `prefetchRoute('/')` (Dashboard), then on completion calls `prefetchRoute('/wells')` (Well List)
   - Use `.then()` chaining: `routeMap['/']?.().then(() => routeMap['/wells']?.()).catch(() => {})`
   - Also guard with network checks (same saveData/onLine checks)
   - Do NOT prefetch if both are already in the `prefetched` set

5. **Login transition prefetch:**
   - Export `prefetchDashboard(): void` function
   - Simply calls `prefetchRoute('/')` — thin wrapper for semantic clarity at call site
   - Will be called from PhonePage/VerifyPage after successful auth (the call site integration in auth pages is a simple one-liner addition)

6. Keep existing `prefetchRoute` export signature unchanged (backward compatible).

7. Add the `/app/dashboard` alias to routeMap pointing to same DashboardPage import (since both `/` and `/app/dashboard` route to it).
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Inspect routePrefetch.ts for dedup set, debounce timer, saveData check, onLine check, prefetchOnMenuOpen with sequential loading</manual>
  </verify>
  <done>routePrefetch.ts exports prefetchRoute (with dedup + network guards), prefetchRouteDebounced (100ms debounce), prefetchOnMenuOpen (sequential Dashboard then Well List), and prefetchDashboard (login transition helper).</done>
</task>

<task type="auto">
  <name>Task 2: Wire prefetch enhancements into SideMenu and auth pages</name>
  <files>
    src/components/SideMenu.tsx
    src/pages/auth/VerifyPage.tsx
  </files>
  <action>
**SideMenu.tsx** — Update prefetch wiring:

1. Replace `onMouseEnter={() => prefetchRoute(item.path)}` with `onMouseEnter={() => prefetchRouteDebounced(item.path)}` on nav buttons (debounced for desktop hover).
2. Keep `onTouchStart={() => prefetchRoute(item.path)}` as-is (touch should be immediate, no debounce — user has committed to interacting).
3. Add mobile sequential prefetch on menu open:
   - Import `prefetchOnMenuOpen` from `routePrefetch.ts`
   - Add a `useEffect` that fires when `open` transitions to `true`:
     ```tsx
     useEffect(() => {
       if (open) prefetchOnMenuOpen();
     }, [open]);
     ```
   - This prefetches Dashboard + Well List when the menu opens on any device. On desktop where chunks may already be prefetched via hover, the dedup set prevents re-fetching.

4. Update the import from `routePrefetch.ts` to include `prefetchRouteDebounced` and `prefetchOnMenuOpen`.

**VerifyPage.tsx** — Add dashboard prefetch on successful auth:

1. Import `prefetchDashboard` from `../../lib/routePrefetch`
2. After successful OTP verification (where navigation to dashboard happens), call `prefetchDashboard()` just before or alongside the navigation call
3. Find the success handler where `navigate('/')` or similar is called, add `prefetchDashboard()` before it
4. This is a single line addition — do NOT restructure the auth flow

Note: Read VerifyPage.tsx first to find the exact location of the success handler. The prefetch call should go right before the navigate call in the OTP success handler.
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>SideMenu uses debounced prefetch on hover, immediate on touch, and calls prefetchOnMenuOpen when opened. VerifyPage calls prefetchDashboard on auth success.</manual>
  </verify>
  <done>SideMenu prefetches with debounce on hover, immediate on touch, and sequential prefetch on menu open. VerifyPage prefetches dashboard chunk during auth transition.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. `routePrefetch.ts` exports: `prefetchRoute`, `prefetchRouteDebounced`, `prefetchOnMenuOpen`, `prefetchDashboard`
3. SideMenu uses `prefetchRouteDebounced` for `onMouseEnter` and `prefetchRoute` for `onTouchStart`
4. SideMenu calls `prefetchOnMenuOpen()` in a `useEffect` triggered by `open` prop
5. VerifyPage calls `prefetchDashboard()` before navigation on auth success
6. Prefetch system respects `saveData` and `onLine` checks
</verification>

<success_criteria>
- Hovering menu links triggers debounced (100ms) chunk prefetch
- Opening the menu prefetches Dashboard then Well List sequentially
- Duplicate prefetches are prevented by dedup set
- Prefetch is skipped when data saver is on or device is offline
- Successful OTP verification pre-fetches the dashboard chunk
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/23-route-level-code-splitting-bundle-optimization/23-02-SUMMARY.md`
</output>
