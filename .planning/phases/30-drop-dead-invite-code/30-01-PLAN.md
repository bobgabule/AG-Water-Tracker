---
phase: 30-drop-dead-invite-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260225180000_039_drop_dead_invite_rpcs.sql
  - docs/implementation_plan.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "public.create_invite_code function no longer exists in the database after migration runs"
    - "public.join_farm_with_code function no longer exists in the database after migration runs"
    - "private.create_invite_code_impl and private.join_farm_with_code_impl no longer exist after migration runs"
    - "Phone-based invite flow (invite_user_by_phone, get_onboarding_status, revoke_farm_invite) is untouched"
    - "docs/implementation_plan.md no longer lists join_farm_with_code or create_invite_code as active RPCs"
  artifacts:
    - path: "supabase/migrations/20260225180000_039_drop_dead_invite_rpcs.sql"
      provides: "Migration to drop 4 dead invite code functions"
      contains: "DROP FUNCTION IF EXISTS"
    - path: "docs/implementation_plan.md"
      provides: "Updated documentation without dead RPC references"
  key_links: []
---

<objective>
Remove the unused generic invite code RPCs (create_invite_code, join_farm_with_code) and their private implementations from the database via a new Supabase migration, and update documentation to reflect the removal.

Purpose: These 4 functions are dead code -- no client references them after the phone-based invite system replaced them. Removing them reduces unnecessary API surface and avoids confusion.
Output: One SQL migration file and updated implementation_plan.md
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/implementation_plan.md
@supabase/migrations/038_restrict_admin_invite_role.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to drop dead invite code RPCs</name>
  <files>supabase/migrations/20260225180000_039_drop_dead_invite_rpcs.sql</files>
  <action>
Create a new Supabase migration file that drops the 4 dead invite code functions. Use DROP FUNCTION IF EXISTS with full argument signatures to avoid ambiguity:

```sql
-- Migration 039: Drop dead invite code RPCs
-- These functions are unused after the phone-based invite system (invite_user_by_phone)
-- replaced the generic invite code flow. No client code references them.

DROP FUNCTION IF EXISTS public.create_invite_code(uuid, text, integer, integer);
DROP FUNCTION IF EXISTS private.create_invite_code_impl(uuid, text, integer, integer);
DROP FUNCTION IF EXISTS public.join_farm_with_code(text);
DROP FUNCTION IF EXISTS private.join_farm_with_code_impl(text);
```

DO NOT touch any other functions, tables, or schemas. Specifically do NOT modify:
- farm_invites table (used by phone invite system)
- invite_user_by_phone / get_onboarding_status / revoke_farm_invite RPCs
- Any existing migrations (historical, never edit)

Use the timestamp prefix format matching existing migrations in supabase/migrations/.
  </action>
  <verify>
    <automated>npx supabase migration list 2>&1 | tail -5</automated>
    <manual>Verify migration file exists and contains exactly 4 DROP FUNCTION statements targeting the correct functions. No other DDL statements present.</manual>
  </verify>
  <done>Migration file 039 exists with 4 DROP FUNCTION IF EXISTS statements for public.create_invite_code, private.create_invite_code_impl, public.join_farm_with_code, and private.join_farm_with_code_impl. No other DDL changes.</done>
</task>

<task type="auto">
  <name>Task 2: Remove dead RPC references from documentation</name>
  <files>docs/implementation_plan.md</files>
  <action>
In docs/implementation_plan.md, find the "Atomic RPCs" section (around lines 148-153) which lists:

```
- `join_farm_with_code(code)` → UUID
- `create_invite_code(farm_id, role, expires_days, max_uses)` → TEXT
```

Remove these two bullet points entirely. Keep the remaining RPCs in the list (create_farm_and_membership, get_onboarding_status) intact.

Do NOT modify any other sections of the file. The farm_invites table schema above the RPCs section stays as-is (it is still used by the phone invite system).
  </action>
  <verify>
    <automated>npx tsc -b --noEmit 2>&1 | head -5</automated>
    <manual>Verify docs/implementation_plan.md no longer contains the strings "join_farm_with_code" or "create_invite_code" in the Atomic RPCs list.</manual>
  </verify>
  <done>docs/implementation_plan.md Atomic RPCs section no longer lists join_farm_with_code or create_invite_code. Remaining RPCs (create_farm_and_membership, get_onboarding_status) unchanged.</done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260225180000_039_drop_dead_invite_rpcs.sql
2. Migration contains exactly 4 DROP FUNCTION IF EXISTS statements
3. No references to create_invite_code or join_farm_with_code remain in docs/implementation_plan.md Atomic RPCs section
4. Phone-based invite RPCs (invite_user_by_phone, get_onboarding_status, revoke_farm_invite) are NOT mentioned in the migration
5. TypeScript compilation still passes (npx tsc -b --noEmit)
</verification>

<success_criteria>
- Migration 039 drops all 4 dead functions using IF EXISTS (safe to re-run)
- Documentation accurately reflects only the active RPCs
- Zero changes to any source code, existing migrations, or live invite system
</success_criteria>

<output>
After completion, create `.planning/phases/30-drop-dead-invite-code/30-01-SUMMARY.md`
</output>
