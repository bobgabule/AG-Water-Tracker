---
phase: 37-add-multi-language-support-english-espa-ol-with-persistent-language-preference
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/i18n/en.ts
  - src/i18n/es.ts
  - src/i18n/index.ts
  - src/stores/languageStore.ts
  - src/hooks/useTranslation.ts
  - src/pages/LanguagePage.tsx
  - src/lib/permissions.ts
autonomous: true
requirements:
  - I18N-INFRA

must_haves:
  truths:
    - "Language store persists selected locale ('en' or 'es') across page reloads via localStorage key 'ag-language'"
    - "useTranslation() hook returns { t, locale } where t() resolves flat dot-prefixed keys to locale-appropriate strings"
    - "t() supports {{variable}} interpolation and {{count}}-based singular/plural selection"
    - "LanguagePage reads from and writes to the language store, switching the entire app instantly"
    - "English and Spanish translation files contain all ~250 app strings with identical key sets"
    - "getRoleDisplayName(role, locale) returns translated role labels"
  artifacts:
    - path: "src/i18n/en.ts"
      provides: "English translation object with ~250 flat keys"
      contains: "nav.map"
    - path: "src/i18n/es.ts"
      provides: "Spanish translation object with same keys as en.ts"
      contains: "nav.map"
    - path: "src/i18n/index.ts"
      provides: "Type exports, translation registry, Locale type"
      exports: ["Locale", "TranslationKey", "translations"]
    - path: "src/stores/languageStore.ts"
      provides: "Zustand persist store for language preference"
      contains: "ag-language"
    - path: "src/hooks/useTranslation.ts"
      provides: "useTranslation hook returning { t, locale }"
      exports: ["useTranslation"]
    - path: "src/pages/LanguagePage.tsx"
      provides: "Language selection page using store + translations"
      contains: "useTranslation"
    - path: "src/lib/permissions.ts"
      provides: "getRoleDisplayName function for locale-aware role labels"
      exports: ["getRoleDisplayName"]
  key_links:
    - from: "src/hooks/useTranslation.ts"
      to: "src/stores/languageStore.ts"
      via: "reads locale from Zustand store"
      pattern: "useLanguageStore"
    - from: "src/hooks/useTranslation.ts"
      to: "src/i18n/index.ts"
      via: "imports translations registry"
      pattern: "translations\\[locale\\]"
    - from: "src/pages/LanguagePage.tsx"
      to: "src/stores/languageStore.ts"
      via: "writes locale on selection"
      pattern: "setLocale"
---

<objective>
Build the complete i18n infrastructure: language store, English + Spanish translation files (~250 keys), useTranslation() hook with interpolation and plural support, rewrite LanguagePage to use the store, and add locale-aware role display names.

Purpose: This is the foundation that all other plans depend on. No component can be translated without these artifacts.
Output: 7 files (5 new, 2 modified) providing the full translation system.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-add-multi-language-support-english-espa-ol-with-persistent-language-preference/37-CONTEXT.md

# Key patterns to follow:
@src/stores/activeFarmStore.ts          # Zustand persist pattern
@src/lib/permissions.ts                 # ROLE_DISPLAY_NAMES to extend
@src/pages/LanguagePage.tsx             # Existing stub to rewrite
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create language store, translation files, and useTranslation hook</name>
  <files>
    src/stores/languageStore.ts
    src/i18n/en.ts
    src/i18n/es.ts
    src/i18n/index.ts
    src/hooks/useTranslation.ts
  </files>
  <action>
**1. Create `src/stores/languageStore.ts`** — Zustand persist store following `activeFarmStore.ts` pattern:
- Interface: `{ locale: Locale; setLocale: (l: Locale) => void }`
- Default locale: `'en'`
- Persist key: `'ag-language'`
- Export: `useLanguageStore`

**2. Create `src/i18n/en.ts`** — Default export a flat `Record<string, string>` object with ALL app strings (~250 keys). Use dot-prefix grouping:

Key categories and examples (executor MUST extract ALL strings from the ~31 files listed in the approved design — read each file, find every user-facing string):

- `nav.*` — Map, Well List, Reports, Users, Subscription, Language, Settings, Logout, Menu, Close menu
- `auth.*` — Phone number, Enter your phone number, Send Code, Verify, Enter the code sent to, Verify Code, Resend Code, Didn't receive a code?, Sign in to AG Water Tracker, etc.
- `auth.noSubscription.*` — No Farm Access, Your phone number is not associated with any farm, Contact your farm administrator, etc.
- `well.*` — Well List, Add Well, Serial Number, Well Name, Permit Number, State, County, Township, Range, Section, Quarter, Unit Type, Status, Latitude, Longitude, Save, Cancel, Delete, No wells found, etc.
- `well.status.*` — Active, Inactive, Abandoned, Unknown
- `well.unitType.*` — Gallons, Cubic Feet, Acre-Feet
- `well.equipment.*` — Ok, Dead, Low, Off (pump states and equipment status labels)
- `dashboard.*` — Dashboard title strings, map-related text
- `reading.*` — New Reading, Edit Reading, Current Reading, Meter Problem, Pump Off, Dead Pump, Low Battery, Save Reading, GPS capturing, Similar reading warning, Delete Reading, No readings yet, etc.
- `allocation.*` — Allocations, New Allocation, Edit Allocation, Start Date, End Date, Allocated Amount, Used, Remaining, Override, No allocations, Delete Allocation, etc.
- `user.*` — Users, Add User, First Name, Last Name, Phone Number, Role, Active, Disabled, Enable, Disable, No users found, Pending Invites, Revoke, Send Invite, etc.
- `settings.*` — Settings page strings (Profile, Farm Settings, etc.)
- `subscription.*` — Subscription, Current Plan, Wells, Seats, Upgrade, Free, Starter, Professional, etc.
- `reports.*` — Reports page strings
- `confirm.*` — Are you sure?, This action cannot be undone, Cancel, Confirm, Delete
- `error.*` — Something went wrong, Try again, Reload, An error occurred, Failed to save, Network error, etc.
- `location.*` — Enable Location, Location helps verify readings, Allow, Not Now, Location unavailable, etc.
- `sync.*` — Syncing, Offline, Last synced, Sync error
- `time.*` — Today, Yesterday, days ago, weeks ago, months ago, just now (with `_one` and `_other` suffixes for plurals: `time.daysAgo_one` = "{{count}} day ago", `time.daysAgo_other` = "{{count}} days ago")
- `common.*` — Save, Cancel, Delete, Edit, Back, Close, Loading, OK, Yes, No, Done, Search, Filter, None, Required, Optional
- `toast.*` — Well created, Well updated, Well deleted, Reading saved, Reading deleted, Allocation saved, etc.
- `map.*` — Map offline text, Offline - cached tiles only, etc.
- `limit.*` — Well limit reached, Seat limit reached, Upgrade your plan, etc.
- `role.*` — Super Admin, Owner, Admin, Meter Checker (kept for non-function usage)

**Interpolation convention:** Use `{{variableName}}` for dynamic values. Examples:
- `"auth.codeSentTo": "Enter the code sent to {{phone}}"`
- `"well.deleteConfirm": "Delete well {{name}}? This cannot be undone."`

**Plural convention:** Use `_one` and `_other` suffixes. The `t()` function picks based on `count` param:
- `"time.daysAgo_one": "{{count}} day ago"`
- `"time.daysAgo_other": "{{count}} days ago"`
- `"time.weeksAgo_one": "{{count}} week ago"`
- `"time.weeksAgo_other": "{{count}} weeks ago"`

**3. Create `src/i18n/es.ts`** — Same structure as en.ts with Spanish translations. Key rules:
- Agricultural terminology: Gallons = Galones, Acre-Feet = Acres-Pie, Cubic Feet = Pies Cubicos
- Roles: Admin = Administrador, Meter Checker = Lector de Medidores, Owner = Propietario, Super Admin = Super Administrador
- Equipment: Ok = Bueno, Dead = Muerta, Low = Bajo, Off = Apagada
- Well status: Active = Activo, Inactive = Inactivo, Abandoned = Abandonado
- Common UI: Save = Guardar, Cancel = Cancelar, Delete = Eliminar, Edit = Editar, Back = Volver, Close = Cerrar
- Time: Today = Hoy, Yesterday = Ayer, just now = ahora mismo
- Plural forms: `"time.daysAgo_one": "hace {{count}} dia"`, `"time.daysAgo_other": "hace {{count}} dias"`

**4. Create `src/i18n/index.ts`** — Central exports:
- `export type Locale = 'en' | 'es'`
- `export type TranslationKey = keyof typeof en` (TypeScript will infer all keys)
- `export const translations: Record<Locale, Record<string, string>> = { en, es }`
- Import en from './en' and es from './es'

**5. Create `src/hooks/useTranslation.ts`** — Custom hook:
```typescript
export function useTranslation() {
  const locale = useLanguageStore((s) => s.locale);
  const t = useCallback((key: string, params?: Record<string, string | number>): string => {
    // 1. If params.count exists, try key_one / key_other based on count === 1
    // 2. Look up key in translations[locale], fallback to translations['en'], fallback to key itself
    // 3. Replace all {{paramName}} with params[paramName]
    return resolved;
  }, [locale]);
  return { t, locale };
}
```

Key implementation details:
- Plural selection: if `params?.count !== undefined`, append `_one` when `count === 1`, `_other` otherwise, and look up that suffixed key first. Fall back to base key if suffixed key missing.
- Interpolation: replace `/\{\{(\w+)\}\}/g` with `String(params[match])`.
- English fallback: if key not found in current locale, try `translations['en'][key]` before returning raw key.
- Wrap the `t` function in `useCallback` with `[locale]` dependency.
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Verify en.ts and es.ts have the same number of keys. Check that useTranslation hook compiles without errors.</manual>
  </verify>
  <done>
    - languageStore persists locale to localStorage under 'ag-language'
    - en.ts and es.ts have identical key sets with ~250 strings each
    - useTranslation() returns { t, locale } where t() handles interpolation and plurals
    - All 5 new files compile without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite LanguagePage and add getRoleDisplayName to permissions</name>
  <files>
    src/pages/LanguagePage.tsx
    src/lib/permissions.ts
  </files>
  <action>
**1. Rewrite `src/pages/LanguagePage.tsx`** — Replace the existing stub entirely:
- Import `useTranslation` from `../hooks/useTranslation`
- Import `useLanguageStore` from `../stores/languageStore`
- Get `{ t, locale }` from `useTranslation()`
- Get `setLocale` from `useLanguageStore`
- Language options array: `[{ code: 'en', label: 'English' }, { code: 'es', label: 'Español' }]` — labels are ALWAYS native names (never translated)
- Page title: `t('language.title')` which renders "LANGUAGE" in English, "IDIOMA" in Spanish
- Subtitle: `t('language.subtitle')` which renders "Set your preferred language" / "Establece tu idioma preferido"
- On button click: call `setLocale(code)` — this triggers instant re-render via Zustand subscription
- Selected state: highlight the active locale's button with `bg-surface-header text-white`
- Unselected state: `bg-white text-text-heading border border-text-heading/30 hover:bg-[#f5f5f0]`
- Keep existing Tailwind classes and layout structure from the stub

**2. Update `src/lib/permissions.ts`** — Add locale-aware role display:
- Import `Locale` type from `../i18n/index`
- Add a new exported function:
```typescript
const ROLE_DISPLAY_NAMES_I18N: Record<Locale, Record<Role, string>> = {
  en: { super_admin: 'Super Admin', owner: 'Owner', admin: 'Admin', meter_checker: 'Meter Checker' },
  es: { super_admin: 'Super Administrador', owner: 'Propietario', admin: 'Administrador', meter_checker: 'Lector de Medidores' },
};

export function getRoleDisplayName(role: Role, locale: Locale): string {
  return ROLE_DISPLAY_NAMES_I18N[locale]?.[role] ?? ROLE_DISPLAY_NAMES[role] ?? role;
}
```
- Keep the existing `ROLE_DISPLAY_NAMES` constant unchanged (backward compatible)
- Do NOT remove any existing exports
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Open the app, navigate to /language, tap Espanol, verify page title changes to IDIOMA instantly. Tap English, verify it reverts. Refresh the page and confirm the selection persists.</manual>
  </verify>
  <done>
    - LanguagePage reads/writes locale from Zustand store
    - Tapping a language option instantly re-renders the page title and subtitle
    - Language selection persists across page reloads
    - getRoleDisplayName(role, locale) returns correct translated role names
    - Existing ROLE_DISPLAY_NAMES export unchanged (backward compatible)
    - npx tsc -b --noEmit passes
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Language store defaults to 'en' on fresh install, persists selection to localStorage
3. en.ts and es.ts have identical key sets (grep for key count)
4. useTranslation() t() function handles interpolation: `t('auth.codeSentTo', { phone: '+1234' })` returns "Enter the code sent to +1234"
5. useTranslation() t() function handles plurals: `t('time.daysAgo', { count: 1 })` returns "1 day ago", `t('time.daysAgo', { count: 3 })` returns "3 days ago"
6. LanguagePage renders translated title and allows instant language switching
</verification>

<success_criteria>
- All 7 files exist and compile (5 new + 2 modified)
- Language selection at /language persists and changes all translated strings on that page immediately
- Translation infrastructure ready for Plans 02 and 03 to wire into remaining components
</success_criteria>

<output>
After completion, create `.planning/phases/37-add-multi-language-support-english-espa-ol-with-persistent-language-preference/37-01-SUMMARY.md`
</output>
