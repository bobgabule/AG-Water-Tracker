---
phase: 04-permission-enforcement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/DashboardPage.tsx
  - src/pages/WellListPage.tsx
autonomous: true

must_haves:
  truths:
    - "Meter checker cannot see the New Well button on the dashboard map view"
    - "Meter checker cannot see the New Well button on the well list page"
    - "Meter checker long-pressing the map does NOT open the well creation form"
    - "Admin, grower, and super_admin can see New Well buttons and create wells on both pages"
    - "A permission check prevents well creation writes even if UI gating is bypassed"
  artifacts:
    - path: "src/pages/DashboardPage.tsx"
      provides: "Dashboard with role-gated New Well button, long-press guard, and write guard"
      contains: "hasPermission"
    - path: "src/pages/WellListPage.tsx"
      provides: "Well list with role-gated New Well button"
      contains: "hasPermission"
  key_links:
    - from: "src/pages/DashboardPage.tsx"
      to: "src/lib/permissions.ts"
      via: "hasPermission(role, 'create_well') check"
      pattern: "hasPermission\\(.*create_well"
    - from: "src/pages/WellListPage.tsx"
      to: "src/lib/permissions.ts"
      via: "hasPermission(role, 'create_well') check"
      pattern: "hasPermission\\(.*create_well"
    - from: "src/pages/DashboardPage.tsx"
      to: "src/hooks/useUserRole.ts"
      via: "useUserRole() hook call"
      pattern: "useUserRole\\(\\)"
---

<objective>
Gate well creation UI elements and write operations by the `create_well` permission in DashboardPage and WellListPage.

Purpose: Meter checkers can view wells and record readings but cannot create new wells. This plan ensures the "New Well" buttons, long-press well creation, and the underlying write operation are all gated.

Output: Updated DashboardPage.tsx and WellListPage.tsx with role-based conditional rendering and write guards.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/DashboardPage.tsx
@src/pages/WellListPage.tsx
@src/lib/permissions.ts
@src/hooks/useUserRole.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate well creation UI and writes in DashboardPage</name>
  <files>src/pages/DashboardPage.tsx</files>
  <action>
Update `src/pages/DashboardPage.tsx` to gate well creation behind the `create_well` permission:

1. Add imports: `useUserRole` from `../hooks/useUserRole`, `hasPermission` from `../lib/permissions`.

2. Inside the component, derive the permission flag:
```typescript
const role = useUserRole();
const canCreateWell = hasPermission(role, 'create_well');
```

3. **Gate the "New Well" floating action button** (lines 186-195): Wrap with conditional rendering:
```tsx
{canCreateWell && (
  <button onClick={handleNewWell} className="...">
    <PlusIcon className="w-5 h-5" />
    New Well
  </button>
)}
```

4. **Gate the long-press handler** (lines 70-73): The `handleMapLongPress` callback should early-return if the user lacks permission. This prevents the well form from opening on long-press for unauthorized users:
```typescript
const handleMapLongPress = useCallback((lngLat: { lng: number; lat: number }) => {
  if (!canCreateWell) return;
  setPickedLocation({ latitude: lngLat.lat, longitude: lngLat.lng });
  setCurrentStep('form');
}, [canCreateWell]);
```
Add `canCreateWell` to the dependency array.

5. **Add write guard to handleSaveWell** (lines 75-128): Add a permission check at the top of the function as defense-in-depth. This catches edge cases where a role downgrade happened between opening the form and saving:
```typescript
const handleSaveWell = useCallback(async (wellData: WellFormData) => {
  if (isSaving) return;
  if (!hasPermission(role, 'create_well')) {
    debugError('Dashboard', 'Attempted well creation without permission');
    return;
  }
  // ... rest of existing save logic unchanged
}, [db, isSaving, onboardingStatus?.farmId, user, role]);
```
Add `role` to the dependency array. Import `hasPermission` directly (already imported above) and use `role` (already in scope).

6. **Do NOT gate the map click handler** (handleMapClick). Map clicks when in location picker mode are part of the location selection flow and are already gated by `currentStep`. The long-press guard prevents the form from opening.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero type errors. Search DashboardPage.tsx for `canCreateWell` -- should appear in conditional render around New Well button and in handleMapLongPress guard. Search for `hasPermission(role, 'create_well')` -- should appear in handleSaveWell as write guard.</verify>
  <done>DashboardPage conditionally renders New Well button based on create_well permission. Long-press well creation is gated. handleSaveWell has defense-in-depth permission check. Meter checker sees only the Well List button on the dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Gate well creation UI in WellListPage</name>
  <files>src/pages/WellListPage.tsx</files>
  <action>
Update `src/pages/WellListPage.tsx` to gate the "New Well" button behind the `create_well` permission:

1. Add imports: `useUserRole` from `../hooks/useUserRole`, `hasPermission` from `../lib/permissions`.

2. Inside the component, derive the permission flag:
```typescript
const role = useUserRole();
const canCreateWell = hasPermission(role, 'create_well');
```

3. **Gate the "New Well" button** (lines 181-188): Wrap with conditional rendering:
```tsx
{canCreateWell && (
  <button onClick={handleNewWell} className="...">
    <PlusIcon className="w-5 h-5" />
    New Well
  </button>
)}
```

4. The "Well Map" button (lines 174-179) remains visible to all roles -- all users can view the map.

5. **Adjust the bottom bar layout**: When the New Well button is hidden, the Well Map button should still be positioned correctly. The current `justify-between` with `gap-4` on the flex container will work fine -- with only one child, the Well Map button will align to the start. No layout change needed.

6. The `handleNewWell` callback navigates to `/wells/new` which doesn't have a page yet (it's a future Phase 7 concern). For now, gating the button is sufficient -- there's no route to guard since it doesn't exist.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero type errors. Search WellListPage.tsx for `canCreateWell` -- should appear wrapping the New Well button. Confirm the Well Map button is NOT wrapped in any permission check.</verify>
  <done>WellListPage conditionally renders New Well button based on create_well permission. Meter checker sees only the Well Map button in the bottom action bar. Well list viewing remains available to all roles.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. DashboardPage.tsx has three permission gates: New Well button (conditional render), long-press handler (early return), handleSaveWell (write guard)
3. WellListPage.tsx has one permission gate: New Well button (conditional render)
4. Both files use `hasPermission(role, 'create_well')` -- same action string, consistent
5. Both files call `useUserRole()` to get the role
6. No UI elements are hidden with CSS -- all gating uses conditional rendering (no DOM exposure)
</verification>

<success_criteria>
- Meter checker cannot see New Well button on dashboard or well list
- Meter checker long-pressing map does NOT trigger well creation flow
- Write guard in handleSaveWell prevents well creation even if UI gating is bypassed
- Admin, grower, super_admin see all New Well buttons and can create wells normally
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-permission-enforcement/04-02-SUMMARY.md`
</output>
