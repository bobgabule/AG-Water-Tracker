---
phase: 04-permission-enforcement
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/stores/activeFarmStore.ts
  - src/hooks/useActiveFarm.ts
  - src/components/FarmSelector.tsx
  - src/components/Header.tsx
autonomous: false
user_setup:
  - service: powersync
    why: "Super admin needs sync rules that sync ALL farms data, not just their own"
    dashboard_config:
      - task: "Add a new sync rule bucket for super_admin role that syncs all farms, wells, farm_members, and farm_invites data. Key on JWT claim: token_parameters.user_id where user has user_role = 'super_admin' in app_metadata. See docs/powersync-sync-rules.yaml for current rules."
        location: "PowerSync Dashboard -> Sync Rules"

must_haves:
  truths:
    - "Super admin can see a farm selector in the header showing available farms"
    - "Super admin can switch to a different farm and see that farm's data"
    - "Non-super_admin users do not see the farm selector"
  artifacts:
    - path: "src/stores/activeFarmStore.ts"
      provides: "Zustand store for super admin's active farm override"
      min_lines: 15
    - path: "src/hooks/useActiveFarm.ts"
      provides: "Hook returning current active farm (own farm or super admin override)"
      min_lines: 15
    - path: "src/components/FarmSelector.tsx"
      provides: "Dropdown component for super admin to select which farm to view"
      min_lines: 30
    - path: "src/components/Header.tsx"
      provides: "Header with conditional FarmSelector for super_admin"
      contains: "FarmSelector"
  key_links:
    - from: "src/hooks/useActiveFarm.ts"
      to: "src/stores/activeFarmStore.ts"
      via: "Zustand store subscription for overrideFarmId"
      pattern: "useActiveFarmStore"
    - from: "src/components/FarmSelector.tsx"
      to: "src/stores/activeFarmStore.ts"
      via: "setActiveFarm/clearOverride actions"
      pattern: "useActiveFarmStore"
    - from: "src/components/Header.tsx"
      to: "src/components/FarmSelector.tsx"
      via: "Conditional render for super_admin role"
      pattern: "cross_farm_access.*FarmSelector"
---

<objective>
Build the super admin cross-farm access infrastructure: a Zustand store for active farm override, a useActiveFarm hook, a FarmSelector dropdown, and header integration.

Purpose: Super admins need to view and manage any farm in the system. This plan creates the mechanism to switch between farms and lays the groundwork for data queries to respect the active farm override.

Output: activeFarmStore.ts, useActiveFarm.ts, FarmSelector.tsx, updated Header.tsx.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-permission-enforcement/04-01-SUMMARY.md
@src/stores/
@src/hooks/useUserRole.ts
@src/lib/permissions.ts
@src/lib/AuthProvider.tsx
@src/components/Header.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activeFarmStore and useActiveFarm hook</name>
  <files>src/stores/activeFarmStore.ts, src/hooks/useActiveFarm.ts</files>
  <action>
**Create `src/stores/activeFarmStore.ts`** -- Zustand v5 store for super admin's farm override:

```typescript
import { create } from 'zustand';

interface ActiveFarmState {
  /** Farm ID override set by super admin farm selector. Null = use own farm. */
  overrideFarmId: string | null;
  overrideFarmName: string | null;
  setActiveFarm: (farmId: string, farmName: string) => void;
  clearOverride: () => void;
}

export const useActiveFarmStore = create<ActiveFarmState>((set) => ({
  overrideFarmId: null,
  overrideFarmName: null,
  setActiveFarm: (farmId, farmName) =>
    set({ overrideFarmId: farmId, overrideFarmName: farmName }),
  clearOverride: () =>
    set({ overrideFarmId: null, overrideFarmName: null }),
}));
```

**Create `src/hooks/useActiveFarm.ts`** -- hook that combines auth context with override store:

```typescript
import { useAuth } from '../lib/AuthProvider';
import { useUserRole } from './useUserRole';
import { useActiveFarmStore } from '../stores/activeFarmStore';

export function useActiveFarm(): { farmId: string | null; farmName: string | null; isOverride: boolean } {
  const { onboardingStatus } = useAuth();
  const role = useUserRole();
  const overrideFarmId = useActiveFarmStore((s) => s.overrideFarmId);
  const overrideFarmName = useActiveFarmStore((s) => s.overrideFarmName);

  // Super admin with an active override
  if (role === 'super_admin' && overrideFarmId) {
    return { farmId: overrideFarmId, farmName: overrideFarmName, isOverride: true };
  }

  // Default: own farm from auth context
  return {
    farmId: onboardingStatus?.farmId ?? null,
    farmName: onboardingStatus?.farmName ?? null,
    isOverride: false,
  };
}
```

Key design decisions:
- `isOverride` boolean lets consuming components show visual indicators when viewing another farm
- Zustand store (not React Context) avoids re-render cascades when switching farms -- only subscribed components update
- The hook is role-aware: only super_admin can use the override. For all other roles, it always returns their own farm.
- This hook will be used by data-fetching hooks in future phases to query the correct farm's data.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero type errors. Confirm activeFarmStore.ts exports `useActiveFarmStore` with `setActiveFarm`, `clearOverride` actions. Confirm useActiveFarm.ts returns `{ farmId, farmName, isOverride }`.</verify>
  <done>Zustand store created for super admin farm override. useActiveFarm hook returns the correct farm (own or override) based on role. Both compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create FarmSelector component and integrate into Header</name>
  <files>src/components/FarmSelector.tsx, src/components/Header.tsx</files>
  <action>
**Create `src/components/FarmSelector.tsx`** -- dropdown for super admin to select a farm:

Use Headless UI v2 `Listbox` (already in project deps) for an accessible dropdown. The component:

1. Queries ALL farms from PowerSync local database: `SELECT id, name FROM farms ORDER BY name ASC`. This only returns data if the super admin's sync rules include all farms.
2. Shows the currently active farm name (from `useActiveFarm()`).
3. On selection, calls `useActiveFarmStore.getState().setActiveFarm(farmId, farmName)`.
4. Has a "My Farm" option at the top that calls `clearOverride()` to return to the super admin's own farm.
5. Styled to fit in the header bar -- compact, dark theme matching the existing header style (bg-primary).
6. Wrapped in `React.memo` since it receives no changing props.

```typescript
import { memo, useMemo } from 'react';
import { Listbox, ListboxButton, ListboxOption, ListboxOptions } from '@headlessui/react';
import { ChevronUpDownIcon, BuildingOfficeIcon } from '@heroicons/react/24/outline';
import { useQuery } from '@powersync/react';
import { useActiveFarm } from '../hooks/useActiveFarm';
import { useActiveFarmStore } from '../stores/activeFarmStore';
import { useAuth } from '../lib/AuthProvider';

interface FarmRow {
  id: string;
  name: string;
}

function FarmSelectorInner() {
  const { farmId: activeFarmId, farmName: activeFarmName, isOverride } = useActiveFarm();
  const { onboardingStatus } = useAuth();
  const setActiveFarm = useActiveFarmStore((s) => s.setActiveFarm);
  const clearOverride = useActiveFarmStore((s) => s.clearOverride);

  const { data } = useQuery<FarmRow>('SELECT id, name FROM farms ORDER BY name ASC');
  const farms = useMemo(() => data ?? [], [data]);

  const ownFarmId = onboardingStatus?.farmId ?? null;
  const ownFarmName = onboardingStatus?.farmName ?? 'My Farm';

  const handleChange = (farmId: string) => {
    if (farmId === ownFarmId) {
      clearOverride();
    } else {
      const farm = farms.find((f) => f.id === farmId);
      if (farm) setActiveFarm(farm.id, farm.name);
    }
  };

  return (
    <Listbox value={activeFarmId ?? ''} onChange={handleChange}>
      <div className="relative">
        <ListboxButton className="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white text-sm max-w-[180px]">
          <BuildingOfficeIcon className="h-4 w-4 flex-shrink-0" />
          <span className="truncate">{activeFarmName ?? 'Select Farm'}</span>
          {isOverride && <span className="text-yellow-300 text-xs">(viewing)</span>}
          <ChevronUpDownIcon className="h-4 w-4 flex-shrink-0" />
        </ListboxButton>
        <ListboxOptions className="absolute top-full mt-1 right-0 w-56 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto py-1">
          {/* Own farm option */}
          <ListboxOption
            value={ownFarmId ?? ''}
            className="px-3 py-2 text-sm text-white cursor-pointer data-[focus]:bg-gray-700 data-[selected]:bg-primary/30 flex items-center gap-2"
          >
            <span className="font-medium">{ownFarmName}</span>
            <span className="text-gray-400 text-xs">(my farm)</span>
          </ListboxOption>

          {/* Divider */}
          {farms.length > 1 && <div className="border-t border-gray-700 my-1" />}

          {/* All other farms */}
          {farms
            .filter((f) => f.id !== ownFarmId)
            .map((farm) => (
              <ListboxOption
                key={farm.id}
                value={farm.id}
                className="px-3 py-2 text-sm text-white cursor-pointer data-[focus]:bg-gray-700 data-[selected]:bg-primary/30"
              >
                {farm.name}
              </ListboxOption>
            ))}
        </ListboxOptions>
      </div>
    </Listbox>
  );
}

const FarmSelector = memo(FarmSelectorInner);
export default FarmSelector;
```

**Update `src/components/Header.tsx`**:

1. Import `useUserRole` from `../hooks/useUserRole`, `hasPermission` from `../lib/permissions`, and `FarmSelector` from `./FarmSelector`.
2. Inside the component, derive the permission:
```typescript
const role = useUserRole();
const canCrossFarm = hasPermission(role, 'cross_farm_access');
```
3. Conditionally render FarmSelector in the header bar next to the farm name. When `canCrossFarm` is true, replace the static farm name display with `<FarmSelector />`. When false, keep the existing static farm name.
4. Read the existing Header.tsx first to understand its current structure before modifying.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero type errors. Confirm FarmSelector.tsx exists with Listbox, queries farms table, calls setActiveFarm/clearOverride. Confirm Header.tsx conditionally renders FarmSelector for super_admin. Run `npx vite build` to verify no runtime import issues.</verify>
  <done>FarmSelector dropdown exists and is shown to super_admin in the header. Non-super_admin users see the static farm name as before. Zustand store powers the farm override. Builds successfully.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify super admin sync rules (PowerSync Dashboard)</name>
  <files>docs/powersync-sync-rules.yaml</files>
  <action>
Verify and update PowerSync Dashboard sync rules for super admin cross-farm access. The FarmSelector queries `SELECT id, name FROM farms` from PowerSync local database. For this to show farms other than the super admin's own farm, PowerSync sync rules must include an "all farms" bucket for super_admin users. Current sync rules (from docs/powersync-sync-rules.yaml) only sync data for farms where the user has a farm_members row. Super admin needs ALL farms data.

Steps for human verification:
1. Check the PowerSync Dashboard sync rules
2. Verify whether an "all farms" bucket exists for super_admin role users
3. If NOT present, add a new sync bucket that checks `request.jwt() ->> 'user_role'` equals 'super_admin' and syncs ALL rows from: farms, wells, farm_members, farm_invites
4. Deploy the updated sync rules
5. If you prefer to defer this and have super admin manually added as member of farms instead, type "defer"

NOTE: If sync rules are already configured for super_admin cross-farm access from Phase 3, type "already done."
  </action>
  <verify>Super admin user can see multiple farms in the FarmSelector dropdown. Switching between farms shows different farm data.</verify>
  <done>PowerSync sync rules support super admin seeing all farms data. FarmSelector populates correctly for super admin users. Type "done", "defer", or "already done" to continue.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. activeFarmStore.ts exports Zustand store with overrideFarmId, overrideFarmName, setActiveFarm, clearOverride
3. useActiveFarm.ts returns { farmId, farmName, isOverride } respecting super_admin override
4. FarmSelector.tsx renders Listbox dropdown querying farms table
5. Header.tsx conditionally renders FarmSelector for super_admin, static farm name for others
6. PowerSync sync rules verified to include super_admin all-farms bucket (checkpoint)
</verification>

<success_criteria>
- Super admin sees FarmSelector dropdown in header
- Non-super_admin users see static farm name (no FarmSelector)
- FarmSelector lists all farms from PowerSync local database
- Selecting a farm updates the Zustand store
- useActiveFarm returns the overridden farm for super_admin, own farm for all other roles
- Sync rules support super admin seeing all farms (verified via checkpoint)
- TypeScript compiles and Vite builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-permission-enforcement/04-03-SUMMARY.md`
</output>
