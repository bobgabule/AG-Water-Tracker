---
phase: 02-offline-session-resilience
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/AuthProvider.tsx
  - src/components/RequireAuth.tsx
  - src/pages/auth/PhonePage.tsx
  - src/pages/auth/VerifyPage.tsx
autonomous: true

must_haves:
  truths:
    - "User whose account has been revoked sees 'Your session has expired, please sign in again' when connectivity returns and token refresh fails"
    - "User attempting to register while offline sees 'No internet connection' message instead of a cryptic error"
  artifacts:
    - path: "src/lib/AuthProvider.tsx"
      provides: "Session expired state tracking with user-initiated vs forced sign-out distinction"
      contains: "sessionExpired"
    - path: "src/components/RequireAuth.tsx"
      provides: "Session expired message display on forced sign-out"
      contains: "session has expired"
    - path: "src/pages/auth/PhonePage.tsx"
      provides: "Pre-submit connectivity check"
      contains: "useOnlineStatus"
    - path: "src/pages/auth/VerifyPage.tsx"
      provides: "Pre-submit connectivity check"
      contains: "useOnlineStatus"
  key_links:
    - from: "src/lib/AuthProvider.tsx"
      to: "src/components/RequireAuth.tsx"
      via: "sessionExpired state exposed through AuthContextType"
      pattern: "sessionExpired"
    - from: "src/pages/auth/PhonePage.tsx"
      to: "src/hooks/useOnlineStatus.ts"
      via: "useOnlineStatus hook import"
      pattern: "useOnlineStatus"
    - from: "src/pages/auth/VerifyPage.tsx"
      to: "src/hooks/useOnlineStatus.ts"
      via: "useOnlineStatus hook import"
      pattern: "useOnlineStatus"
---

<objective>
Add "session expired" messaging for forced sign-outs (revoked accounts) and add connectivity guards to the registration pages (PhonePage and VerifyPage) so offline users see a clear "no internet" message.

Purpose: After Plan 02-01 fixes the connector semantics, a revoked user's token refresh will permanently fail, triggering a SIGNED_OUT auth event. Without this plan, the user is silently redirected to the phone page with no explanation. Also, users who are offline and try to register see generic error messages instead of a clear connectivity warning.

Output: Modified AuthProvider with session-expired tracking, modified RequireAuth with expired message UI, modified PhonePage and VerifyPage with connectivity guards.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-offline-session-resilience/02-RESEARCH.md
@.planning/phases/02-offline-session-resilience/02-01-SUMMARY.md

Key source files:
@src/lib/AuthProvider.tsx
@src/components/RequireAuth.tsx
@src/pages/auth/PhonePage.tsx
@src/pages/auth/VerifyPage.tsx
@src/hooks/useOnlineStatus.ts
@src/components/OfflineMessage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track forced sign-out and expose session-expired state</name>
  <files>src/lib/AuthProvider.tsx, src/components/RequireAuth.tsx</files>
  <action>
**In AuthProvider.tsx:**

1. Add a `useRef` to track user-initiated sign-out:
   ```typescript
   const userInitiatedSignOut = useRef(false);
   ```

2. Add state for session-expired reason:
   ```typescript
   const [sessionExpired, setSessionExpired] = useState(false);
   ```

3. Modify `signOut` callback:
   - Set `userInitiatedSignOut.current = true` BEFORE calling `supabase.auth.signOut()`
   - After all cleanup (PowerSync clear, state clearing, cache clearing from 02-01), reset: `userInitiatedSignOut.current = false`

4. Modify `handleAuthStateChange` -- in the `'SIGNED_OUT'` case:
   ```typescript
   case 'SIGNED_OUT': {
     // Detect forced sign-out (revoked account, expired refresh token)
     if (!userInitiatedSignOut.current) {
       setSessionExpired(true);
     }
     setSession(null);
     setUser(null);
     setOnboardingStatus(null);
     break;
   }
   ```

5. Add `clearSessionExpired` callback:
   ```typescript
   const clearSessionExpired = useCallback(() => {
     setSessionExpired(false);
   }, []);
   ```

6. Update `AuthContextType` interface:
   - Add `sessionExpired: boolean;`
   - Add `clearSessionExpired: () => void;`

7. Add both to the context value object.

**In RequireAuth.tsx:**

1. Destructure `sessionExpired` and `clearSessionExpired` from `useAuth()`.

2. In the `!session` block (after isAuthReady check, where the component currently either shows OfflineMessage or redirects), add a check for `sessionExpired` BEFORE the existing logic:

   ```typescript
   if (!session) {
     // Session expired (forced sign-out from revoked account)
     if (sessionExpired) {
       return (
         <div className="flex items-center justify-center min-h-screen bg-gray-900">
           <div className="text-center px-6">
             <ExclamationTriangleIcon className="h-16 w-16 text-yellow-500 mx-auto mb-4" />
             <h1 className="text-xl font-semibold text-white mb-2">
               Session Expired
             </h1>
             <p className="text-gray-400 max-w-sm mb-6">
               Your session has expired. Please sign in again.
             </p>
             <button
               onClick={() => {
                 clearSessionExpired();
                 // Navigate is handled by the re-render after clearing expired state
               }}
               className="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-medium text-white transition-colors"
             >
               Sign In
             </button>
           </div>
         </div>
       );
     }

     if (!isOnline) {
       return <OfflineMessage />;
     }

     return <Navigate to={fallbackPath} state={{ from: location }} replace />;
   }
   ```

3. Add import for `ExclamationTriangleIcon` from `@heroicons/react/24/outline`.

Key behaviors:
- When a user explicitly signs out, `userInitiatedSignOut` is true, so `sessionExpired` stays false and they see the normal sign-in page.
- When a revoked user's token refresh fails, Supabase fires SIGNED_OUT, `userInitiatedSignOut` is false, `sessionExpired` becomes true, and RequireAuth shows the expired message.
- Clicking "Sign In" clears the `sessionExpired` flag, which re-renders RequireAuth. Since `!session` is still true, it falls through to the `Navigate` and redirects to `/auth/phone`.
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- no type errors.
Verify AuthProvider exports `sessionExpired` and `clearSessionExpired` in context type.
Verify RequireAuth renders "Session Expired" UI with ExclamationTriangleIcon when `sessionExpired` is true.
  </verify>
  <done>
Forced sign-out (revoked account) shows "Your session has expired. Please sign in again." with a "Sign In" button. Explicit sign-out redirects to the sign-in page as before with no expired message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connectivity guards to registration pages</name>
  <files>src/pages/auth/PhonePage.tsx, src/pages/auth/VerifyPage.tsx</files>
  <action>
**In PhonePage.tsx:**

1. Add import: `import { useOnlineStatus } from '../../hooks/useOnlineStatus';`

2. Call the hook inside the component: `const isOnline = useOnlineStatus();`

3. Add a pre-submit connectivity check at the start of `handleSubmit`, after `e.preventDefault()` and after the 10-digit validation:
   ```typescript
   if (!isOnline) {
     setError('No internet connection. Connect to the internet to sign in.');
     return;
   }
   ```

4. Add `isOnline` to the `handleSubmit` useCallback dependency array.

5. Optionally: Also handle network errors from the actual `sendOtp` call more gracefully. In the existing catch block, check if the error looks like a network error:
   ```typescript
   catch (err) {
     if (!navigator.onLine) {
       setError('No internet connection. Connect to the internet to sign in.');
     } else {
       const message = err instanceof Error ? err.message : 'Failed to send verification code';
       setError(message);
     }
   }
   ```
   This handles the case where `navigator.onLine` was true but the actual request failed (e.g., WiFi without internet).

**In VerifyPage.tsx:**

1. Add import: `import { useOnlineStatus } from '../../hooks/useOnlineStatus';`

2. Call the hook: `const isOnline = useOnlineStatus();`

3. Add connectivity check in `handleVerify`, at the start (after the `if (!phone || verifyingRef.current) return;` guard):
   ```typescript
   if (!isOnline) {
     setError('No internet connection. Connect to the internet to verify your code.');
     return;
   }
   ```

4. Add `isOnline` to the `handleVerify` useCallback dependency array.

5. Add connectivity check in `handleResend`, at the start (after the `if (!phone || resendCooldown > 0) return;` guard):
   ```typescript
   if (!isOnline) {
     setError('No internet connection. Connect to the internet to resend the code.');
     return;
   }
   ```

6. Add `isOnline` to the `handleResend` useCallback dependency array.

7. In both catch blocks (handleVerify and handleResend), add the same `navigator.onLine` fallback check as PhonePage for consistency.
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- no type errors.
Verify PhonePage.tsx imports useOnlineStatus and checks `!isOnline` before sending OTP.
Verify VerifyPage.tsx imports useOnlineStatus and checks `!isOnline` before verifying and resending.
  </verify>
  <done>
PhonePage shows "No internet connection" when user tries to send OTP while offline. VerifyPage shows "No internet connection" when user tries to verify or resend while offline. Both also handle post-check network failures gracefully.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. AuthProvider.tsx has `sessionExpired` state, `userInitiatedSignOut` ref, `clearSessionExpired` callback, and all three are in the context value
3. RequireAuth.tsx shows "Session Expired" UI with yellow ExclamationTriangleIcon when `sessionExpired` is true and `!session`
4. PhonePage.tsx checks `!isOnline` before `sendOtp` call
5. VerifyPage.tsx checks `!isOnline` before `verifyOtp` and `sendOtp` (resend) calls
</verification>

<success_criteria>
- Revoked user sees "Your session has expired. Please sign in again." with a Sign In button
- Normal sign-out redirects to phone page without expired message
- User on PhonePage while offline sees "No internet connection" error on submit
- User on VerifyPage while offline sees "No internet connection" error on verify/resend
- All error messages are clear and actionable (not cryptic network errors)
</success_criteria>

<output>
After completion, create `.planning/phases/02-offline-session-resilience/02-02-SUMMARY.md`
</output>
