---
phase: 05-grower-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/powersync-schema.ts
  - src/components/auth/OtpInput.tsx
  - src/pages/auth/VerifyPage.tsx
  - src/pages/onboarding/CreateFarmPage.tsx
  - src/pages/onboarding/ProfilePage.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "PowerSync farms table schema matches actual database columns (no invite_code)"
    - "OTP input accepts 6 digits to match Supabase default phone OTP length"
    - "CreateFarmPage back button navigates to profile page, not sign out"
    - "Already-onboarded users visiting /onboarding/* are redirected to dashboard"
  artifacts:
    - path: "src/lib/powersync-schema.ts"
      provides: "farms table without invite_code column"
      contains: "farms"
    - path: "src/components/auth/OtpInput.tsx"
      provides: "Configurable-length OTP input (default 6 digits)"
      contains: "length"
    - path: "src/pages/auth/VerifyPage.tsx"
      provides: "6-digit OTP state and auto-submit"
      contains: "code.join"
    - path: "src/pages/onboarding/CreateFarmPage.tsx"
      provides: "Back button navigates to /onboarding/profile"
      contains: "navigate.*onboarding/profile"
    - path: "src/App.tsx"
      provides: "Onboarding routes wrapped with forward guard"
      contains: "RequireNotOnboarded"
  key_links:
    - from: "src/pages/auth/VerifyPage.tsx"
      to: "src/components/auth/OtpInput.tsx"
      via: "OtpInput component with 6-digit configuration"
      pattern: "OtpInput"
    - from: "src/App.tsx"
      to: "src/components/RequireNotOnboarded.tsx"
      via: "Forward guard wrapping onboarding routes"
      pattern: "RequireNotOnboarded"
---

<objective>
Fix the existing grower onboarding flow to match current database schema and improve UX.

Purpose: The grower registration flow (OTP → profile → farm → dashboard) already exists and works. This plan fixes schema drift from Phase 3/4 migrations, corrects OTP digit count, fixes back-navigation UX, and adds forward guards so already-onboarded users don't re-enter the flow.

Output: Updated PowerSync schema, 6-digit OTP input, improved navigation, forward guard component, TypeScript compiles clean.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/powersync-schema.ts
@src/components/auth/OtpInput.tsx
@src/pages/auth/VerifyPage.tsx
@src/pages/onboarding/ProfilePage.tsx
@src/pages/onboarding/CreateFarmPage.tsx
@src/App.tsx
@src/components/RequireOnboarded.tsx
@src/lib/resolveNextRoute.ts
@src/lib/AuthProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PowerSync schema — remove farms.invite_code</name>
  <files>src/lib/powersync-schema.ts</files>
  <action>
Remove the `invite_code` column from the `farms` table definition in `src/lib/powersync-schema.ts`.

**Why:** Migration 024 dropped the `farms.invite_code` column from the database. The PowerSync local schema still includes it, causing a mismatch. While this doesn't cause runtime errors (the column just stays null locally), it's stale and should be cleaned up to prevent confusion.

Steps:
1. Read `src/lib/powersync-schema.ts`
2. Find the `farms` table definition
3. Remove the `invite_code: column.text` line
4. Verify no other files reference `farms.invite_code` in the frontend (grep for `invite_code` in `src/`)
  </action>
  <verify>Run `npx tsc -b --noEmit`. Grep for `invite_code` in `src/` to confirm no remaining references. If any component reads `farms.invite_code`, update it to remove that reference.</verify>
  <done>PowerSync schema matches actual database. No `invite_code` references remain in frontend code.</done>
</task>

<task type="auto">
  <name>Task 2: Fix OTP input to support 6-digit codes</name>
  <files>src/components/auth/OtpInput.tsx, src/pages/auth/VerifyPage.tsx</files>
  <action>
Update the OTP input from 4 digits to 6 digits. Supabase phone OTP sends 6-digit codes by default, and the VerifyPage comment on line 31 confirms the intent is "6-digit code" — the 4-digit implementation is a bug.

1. Update `OtpInput.tsx`:
   - Make the digit count configurable via a `length` prop (default: 6)
   - Replace all hardcoded `4` references with the `length` prop
   - Update paste handler to slice to `length` instead of `4`
   - Update auto-advance to check `index < length - 1` instead of `index < 3`
   - Update aria labels: `Digit ${index + 1} of ${length}`
   - Update `useOtpState` default length from 4 to 6

2. Update `VerifyPage.tsx`:
   - Change initial state: `useState<string[]>(['', '', '', '', '', ''])` (6 empty strings)
   - Update `isComplete` check: `code.join('').length === 6`
   - Update code reset on error: `setCode(['', '', '', '', '', ''])`
   - Update comment on line 31: "6-digit" is already correct, just fix the code to match
   - Pass `length={6}` to `OtpInput` if using the configurable prop approach

Keep `OtpInput` generic (configurable via prop) so it can be reused with different lengths if needed.
  </action>
  <verify>Run `npx tsc -b --noEmit`. Visually inspect that OtpInput renders 6 input boxes. Verify auto-submit triggers when all 6 digits are filled. Check that paste works correctly with 6-digit codes. Confirm `useOtpState(6).isComplete` returns true for 6 filled digits.</verify>
  <done>OTP input supports 6-digit codes. VerifyPage uses 6-digit state. Auto-submit triggers on 6th digit. Paste fills all 6 boxes.</done>
</task>

<task type="auto">
  <name>Task 3: Fix CreateFarmPage back button and ProfilePage polish</name>
  <files>src/pages/onboarding/CreateFarmPage.tsx, src/pages/onboarding/ProfilePage.tsx</files>
  <action>
Fix the CreateFarmPage back button to navigate back to the profile page instead of signing out. Also add accessibility attributes to ProfilePage error display.

**CreateFarmPage.tsx:**
1. Change `handleBack` from calling `signOut()` to `navigate('/onboarding/profile', { replace: true })`
2. Update the button label from "Sign out" to "Back"
3. Remove the `signOut` import from `useAuth()` destructuring (if no longer needed)
4. Keep the `ArrowLeftIcon` for visual consistency

**ProfilePage.tsx:**
1. Add `role="alert"` and `aria-live="polite"` to the error display div (CreateFarmPage already has this, ProfilePage doesn't)
2. No other changes needed — ProfilePage is well-implemented
  </action>
  <verify>Run `npx tsc -b --noEmit`. Confirm CreateFarmPage handleBack uses navigate, not signOut. Confirm ProfilePage error div has role="alert".</verify>
  <done>CreateFarmPage back button navigates to profile (no sign-out). ProfilePage error has proper ARIA attributes. Both pages compile clean.</done>
</task>

<task type="auto">
  <name>Task 4: Add forward guard for onboarding routes</name>
  <files>src/components/RequireNotOnboarded.tsx, src/App.tsx</files>
  <action>
Create a `RequireNotOnboarded` component that redirects already-onboarded users away from `/onboarding/*` routes back to the dashboard. Without this, a user who completes onboarding could manually navigate to `/onboarding/profile` and see an empty form.

**Create `src/components/RequireNotOnboarded.tsx`:**

Follow the exact pattern of `RequireAuth.tsx` and `RequireOnboarded.tsx`:

```typescript
import { Navigate, Outlet } from 'react-router';
import { useAuth } from '../lib/AuthProvider';

interface RequireNotOnboardedProps {
  children?: React.ReactNode;
}

export default function RequireNotOnboarded({ children }: RequireNotOnboardedProps) {
  const { onboardingStatus } = useAuth();

  // If fully onboarded (has profile AND farm membership), redirect to dashboard
  if (onboardingStatus?.hasProfile && onboardingStatus?.hasFarmMembership) {
    return <Navigate to="/" replace />;
  }

  // Not fully onboarded — allow access to onboarding routes
  return children ? <>{children}</> : <Outlet />;
}
```

Key design decisions:
- Only redirect when BOTH `hasProfile` AND `hasFarmMembership` are true (fully onboarded)
- Do NOT redirect when `onboardingStatus` is null (loading/error states) — let RequireAuth handle that
- Do NOT redirect when only profile is complete (user still needs to create farm)
- Use `<Navigate to="/" replace />` — silent redirect, no error message

**Update `src/App.tsx`:**

Wrap the onboarding routes with `RequireNotOnboarded`:

```tsx
{/* Onboarding routes - require session only + not already onboarded */}
<Route element={<RequireAuth />}>
  <Route element={<RequireNotOnboarded />}>
    <Route path="/onboarding/profile" element={<ProfilePage />} />
    <Route path="/onboarding/farm" element={<Navigate to="/onboarding/farm/create" replace />} />
    <Route path="/onboarding/farm/create" element={<CreateFarmPage />} />
  </Route>
</Route>
```

Import `RequireNotOnboarded` at the top of App.tsx with other layout components.
  </action>
  <verify>Run `npx tsc -b --noEmit`. Confirm RequireNotOnboarded.tsx exists and follows the pattern. Confirm App.tsx wraps onboarding routes with RequireNotOnboarded. Manually trace the routing logic: a fully-onboarded user navigating to /onboarding/profile should hit RequireAuth (pass) -> RequireNotOnboarded (redirect to /) -> never reach ProfilePage. Verify alignment: RequireNotOnboarded redirects when `hasProfile && hasFarmMembership` is true — this is the exact inverse of RequireOnboarded's checks at lines 93-101, which redirect when `!hasProfile` or `!hasFarmMembership`. Confirm these are perfect inverses: RequireOnboarded blocks incomplete users from app routes, RequireNotOnboarded blocks complete users from onboarding routes.</verify>
  <done>RequireNotOnboarded component created. Onboarding routes guarded. Fully-onboarded users redirected to dashboard. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. PowerSync schema `farms` table has no `invite_code` column
3. OTP input renders 6 boxes matching Supabase default 6-digit phone OTP
4. CreateFarmPage back button navigates to `/onboarding/profile`, does NOT sign out
5. ProfilePage error div has `role="alert"` and `aria-live="polite"`
6. RequireNotOnboarded component exists and wraps `/onboarding/*` routes in App.tsx
7. Already-onboarded user visiting `/onboarding/profile` is redirected to `/`
</verification>

<success_criteria>
- PowerSync schema matches actual database schema (no stale columns)
- OTP flow supports correct digit count for Supabase phone OTP
- CreateFarmPage provides non-destructive back navigation (back to profile, not sign out)
- Onboarding routes are forward-guarded (already-onboarded users can't re-enter)
- All existing onboarding functionality preserved (no regressions)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-grower-onboarding/05-01-SUMMARY.md`
</output>
