---
phase: 05-grower-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/auth/VerifyPage.tsx
  - src/lib/resolveNextRoute.ts
  - src/pages/onboarding/index.ts
  - src/pages/onboarding/CreateFarmPage.tsx
autonomous: true

must_haves:
  truths:
    - "VerifyPage uses resolveNextRoute for already-logged-in redirect instead of hardcoded '/'"
    - "resolveNextRoute handles all edge cases (null status, partial onboarding, full onboarding)"
    - "No dead references to old invite code UI flow exist in frontend src/"
    - "User who partially completed onboarding resumes from where they left off on next login"
  artifacts:
    - path: "src/pages/auth/VerifyPage.tsx"
      provides: "Already-logged-in redirect uses resolveNextRoute(onboardingStatus)"
      contains: "resolveNextRoute"
    - path: "src/lib/resolveNextRoute.ts"
      provides: "Centralized routing logic handling all onboarding states"
      contains: "resolveNextRoute"
  key_links:
    - from: "src/pages/auth/VerifyPage.tsx"
      to: "src/lib/resolveNextRoute.ts"
      via: "resolveNextRoute(onboardingStatus) for redirect"
      pattern: "resolveNextRoute\\(onboardingStatus\\)"
    - from: "src/components/RequireOnboarded.tsx"
      to: "src/lib/resolveNextRoute.ts"
      via: "Same routing logic (profile → farm → dashboard)"
      pattern: "hasProfile|hasFarmMembership"
---

<objective>
Verify routing logic, fix redirect inconsistency in VerifyPage, and clean up dead code from old invite system.

Purpose: This plan ensures the routing logic is consistent across all entry points, the partial-onboarding resume works correctly, and there are no dead code references to the old invite code UI flow. It completes Phase 5 by verifying the entire flow end-to-end.

Output: Consistent redirect logic, verified resolveNextRoute edge cases, clean codebase with no dead invite code UI references.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/pages/auth/VerifyPage.tsx
@src/pages/auth/PhonePage.tsx
@src/lib/resolveNextRoute.ts
@src/components/RequireOnboarded.tsx
@src/lib/AuthProvider.tsx
@src/App.tsx
@src/lib/powersync-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix VerifyPage already-logged-in redirect</name>
  <files>src/pages/auth/VerifyPage.tsx</files>
  <action>
Fix the VerifyPage redirect for already-logged-in users to use `resolveNextRoute` instead of a hardcoded `/` path.

**Current code (line 51-55):**
```typescript
useEffect(() => {
  if (isAuthReady && user) {
    navigate('/', { replace: true });
  }
}, [isAuthReady, user, navigate]);
```

**Problem:** If a logged-in user who hasn't completed onboarding visits `/auth/verify`, they're redirected to `/` which triggers RequireOnboarded, which redirects to `/onboarding/profile`. This double-redirect works but is unnecessary and causes a brief flash.

**Fix:**
```typescript
useEffect(() => {
  if (isAuthReady && user) {
    const nextRoute = resolveNextRoute(onboardingStatus);
    navigate(nextRoute, { replace: true });
  }
}, [isAuthReady, user, onboardingStatus, navigate]);
```

Steps:
1. Read `src/pages/auth/VerifyPage.tsx`
2. Import `resolveNextRoute` (already imported on line 6)
3. Add `onboardingStatus` to the `useAuth()` destructuring
4. Replace the hardcoded `'/'` with `resolveNextRoute(onboardingStatus)`
5. Add `onboardingStatus` to the useEffect dependency array

**Note:** `resolveNextRoute(null)` returns `/auth/phone`, which is the correct behavior if onboarding status hasn't loaded yet — it stays on the auth flow until status is determined.
  </action>
  <verify>Run `npx tsc -b --noEmit`. Verify VerifyPage uses `resolveNextRoute(onboardingStatus)` in the already-logged-in redirect. Check that `onboardingStatus` is destructured from `useAuth()` and included in the useEffect deps array.</verify>
  <done>VerifyPage redirect uses resolveNextRoute for consistent routing. No double-redirects for logged-in users.</done>
</task>

<task type="auto">
  <name>Task 2: Verify resolveNextRoute handles all edge cases</name>
  <files>src/lib/resolveNextRoute.ts</files>
  <action>
Audit `resolveNextRoute` to verify it correctly handles all onboarding states. No code changes expected — this is a verification task.

**Expected state machine:**
| Input Status | Expected Route | Reason |
|---|---|---|
| `null` | `/auth/phone` | Not authenticated or status failed |
| `{ hasProfile: false, hasFarmMembership: false }` | `/onboarding/profile` | New user, needs profile |
| `{ hasProfile: true, hasFarmMembership: false }` | `/onboarding/farm/create` | Has profile, needs farm |
| `{ hasProfile: true, hasFarmMembership: true }` | `/app/dashboard` | Fully onboarded |
| `{ hasProfile: false, hasFarmMembership: true }` | `/onboarding/profile` | Edge case: has farm but no profile (shouldn't happen, but handled correctly) |

Steps:
1. Read `src/lib/resolveNextRoute.ts`
2. Trace through each case in the truth table above
3. Verify the function handles all cases correctly
4. Verify `isOnboardingComplete` returns true only when both `hasProfile` and `hasFarmMembership` are true

**If any edge case is wrong**, fix it. The most important invariant is:
- `hasProfile: false` → ALWAYS go to `/onboarding/profile` (regardless of farm membership)
- `hasProfile: true, hasFarmMembership: false` → ALWAYS go to `/onboarding/farm/create`
- Both true → dashboard

**Also verify alignment with RequireOnboarded.tsx:**
The `RequireOnboarded` component has its own inline checks (lines 93-101) that follow the same priority order. Confirm the logic matches `resolveNextRoute`. They should be equivalent:
- RequireOnboarded checks `!hasProfile` → redirect to profile
- RequireOnboarded checks `!hasFarmMembership` → redirect to farm/create
- resolveNextRoute checks same conditions in same order

If these are misaligned, fix `resolveNextRoute` to match `RequireOnboarded`.
  </action>
  <verify>Manually trace all 5 states through both resolveNextRoute and RequireOnboarded. Confirm they produce identical routing decisions. Run `npx tsc -b --noEmit`.</verify>
  <done>resolveNextRoute handles all edge cases correctly and aligns with RequireOnboarded routing logic.</done>
</task>

<task type="auto">
  <name>Task 3: Clean up dead code references to old invite code UI</name>
  <files>src/pages/onboarding/index.ts</files>
  <action>
Search for and remove any dead code references to the old invite code system's UI flow.

**Search targets:**
1. Grep `src/` for: `join_farm`, `JoinFarm`, `FarmChoice`, `invite_code` (frontend references only)
2. Grep `src/` for: `joinFarm`, `farm/join`, `onboarding/join`
3. Check if `src/pages/onboarding/index.ts` exports any old pages (currently exports ProfilePage and CreateFarmPage — verify nothing else)

**Expected findings:**
- `src/lib/powersync-schema.ts` may still have `invite_code` on farms — this was already fixed in Plan 05-01 Task 1
- No frontend UI references to `join_farm_with_code` RPC should exist (the old flow was replaced before any UI was built)

**If dead code is found:**
- Remove unused imports
- Remove unused components or pages
- Remove unused route definitions from App.tsx
- Do NOT remove database functions (RPCs) — those are handled by migrations, not frontend cleanup

**If no dead code is found:**
- Document that the codebase is clean and no old invite code UI exists
  </action>
  <verify>Run full grep for `join_farm|JoinFarm|FarmChoice|invite_code` in `src/`. Result should be zero matches (after Plan 05-01 removes `invite_code` from PowerSync schema). Run `npx tsc -b --noEmit`.</verify>
  <done>No dead code references to old invite code UI flow. Codebase is clean. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 4: Fix CreateFarmPage refresh retry and verify partial onboarding resume</name>
  <files>src/pages/onboarding/CreateFarmPage.tsx</files>
  <action>
Add retry logic to CreateFarmPage's `refreshOnboardingStatus()` call and verify Success Criterion 3 ("User who partially completed onboarding resumes from where they left off on next login").

**Fix: Add retry logic to CreateFarmPage**

The current code (lines 125-130) wraps `refreshOnboardingStatus()` in a try/catch and navigates regardless of success. If the refresh fails, the user navigates to the dashboard with stale `onboardingStatus` (farmId is null), which causes RequireOnboarded to redirect them back to `/onboarding/farm/create` — creating a bad UX loop until they reload.

Replace the existing try/catch with retry logic:

```typescript
// In CreateFarmPage handleSubmit, replace:
//   try { await refreshOnboardingStatus(); } catch { }
//   navigate('/app/dashboard', { replace: true });
// With:
let refreshed = false;
for (let attempt = 0; attempt < 3 && !refreshed; attempt++) {
  try {
    await refreshOnboardingStatus();
    refreshed = true;
  } catch {
    if (attempt < 2) await new Promise(r => setTimeout(r, 500));
  }
}
navigate('/', { replace: true });
```

Key changes:
1. Retry `refreshOnboardingStatus()` up to 3 times with 500ms delay between retries
2. Navigate to `/` instead of `/app/dashboard` (both work, but `/` is the canonical route per App.tsx)
3. If all 3 retries fail, navigation still proceeds — the status will self-correct on next app load

**Verify all resume scenarios after the fix:**

| Scenario | Expected Behavior | Verified By |
|---|---|---|
| Profile created, app closed, returns | Lands on CreateFarmPage | resolveNextRoute returns `/onboarding/farm/create` |
| OTP only, app closed, returns | Lands on ProfilePage | resolveNextRoute returns `/onboarding/profile` |
| Fully onboarded, refreshes | Stays on dashboard | RequireOnboarded passes |
| Farm created, refresh fails | Retries 3 times, then navigates; self-corrects on next load | Retry logic + INITIAL_SESSION handler |

Trace each scenario through AuthProvider → resolveNextRoute → RequireOnboarded to confirm.
  </action>
  <verify>Run `npx tsc -b --noEmit`. Confirm CreateFarmPage has retry logic (3 attempts). Confirm navigation target is `/` not `/app/dashboard`. Trace all 4 scenarios through the code to verify correct routing.</verify>
  <done>CreateFarmPage has retry logic for refreshOnboardingStatus. All 4 partial onboarding resume scenarios verified. Success Criterion 3 is fully met.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. VerifyPage uses `resolveNextRoute(onboardingStatus)` for already-logged-in redirect
3. resolveNextRoute handles all 5 states correctly and aligns with RequireOnboarded
4. No dead code references to old invite code UI in `src/`
5. Partial onboarding resume works for all scenarios (profile-only, no-profile, full, stale-status with retry)
6. CreateFarmPage has 3-attempt retry logic for refreshOnboardingStatus
6. All three Phase 5 success criteria are verified:
   - SC1: New user OTP → profile → farm → dashboard (existing flow, polished in Plan 05-01)
   - SC2: Unknown phone auto-enters grower flow (resolveNextRoute sends to profile, no choice screen)
   - SC3: Partial onboarding resumes from correct step (server-driven via get_onboarding_status RPC)
</verification>

<success_criteria>
- VerifyPage redirect is consistent with the rest of the app (uses resolveNextRoute)
- resolveNextRoute produces correct routes for all onboarding states
- No dead code from old invite code system remains in frontend
- Partial onboarding resume verified for all scenarios
- All Phase 5 success criteria met and documented
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-grower-onboarding/05-02-SUMMARY.md`
</output>
