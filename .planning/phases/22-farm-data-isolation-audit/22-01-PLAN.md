---
phase: 22-farm-data-isolation-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/035_isolation_audit_fixes.sql
  - .planning/phases/22-farm-data-isolation-audit/22-AUDIT-REPORT.md
autonomous: true
requirements:
  - ISO-01
  - ISO-02
  - ISO-03

must_haves:
  truths:
    - "Stale legacy invite_code fallback in join_farm_with_code_impl is removed"
    - "super_admin_user_id setting exists in app_settings table"
    - "All RPC functions use fully qualified public.* references"
  artifacts:
    - path: "supabase/migrations/035_isolation_audit_fixes.sql"
      provides: "Stale RPC cleanup and super_admin_user_id app setting"
      contains: "super_admin_user_id"
    - path: ".planning/phases/22-farm-data-isolation-audit/22-AUDIT-REPORT.md"
      provides: "Comprehensive isolation audit report with PASS/FAIL verdicts"
      contains: "ISO-01"
  key_links:
    - from: "private.join_farm_with_code_impl"
      to: "public.farm_invites"
      via: "code lookup only (no legacy farms.invite_code fallback)"
      pattern: "farm_invites"
---

<objective>
Clean stale database code and add super_admin configuration setting.

Purpose: The audit found two stale references to `farms.invite_code` (dropped in migration 024) inside RPCs, and the super_admin identification requires a configurable user ID in app_settings. This migration fixes the stale code and adds the setting.

Output: A single SQL migration file that remediates all backend-level audit findings.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-farm-data-isolation-audit/22-CONTEXT.md
@supabase/migrations/020_security_definer_private_schema.sql
@supabase/migrations/024_fix_search_path_and_legacy_cleanup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create isolation audit migration</name>
  <files>supabase/migrations/035_isolation_audit_fixes.sql</files>
  <action>
Create migration `supabase/migrations/035_isolation_audit_fixes.sql` with three sections:

**Section 1: Clean stale join_farm_with_code_impl**

`CREATE OR REPLACE FUNCTION private.join_farm_with_code_impl(p_code TEXT)` that removes the legacy fallback block (lines 187-203 in migration 020). The current function has two paths:
1. farm_invites lookup (correct, keep as-is)
2. Fallback to `public.farms WHERE invite_code = p_code` (STALE -- `invite_code` column was dropped in migration 024)

Replace the function with only the farm_invites path. If no farm_invite matches, raise `'Invalid invite code'` immediately (no fallback). Also remove the stale `'member'` role -- the farm_invites path already uses the invite's role column. Keep all other logic identical: auth check, expiry check, max_uses check, existing membership check, insert into farm_members, increment uses_count.

Preserve: `SECURITY DEFINER`, `SET search_path = ''`, `RETURNS UUID`, all existing variable declarations (remove `v_farm_id` since `v_invite.farm_id` is used directly).

**Section 2: INSERT super_admin_user_id into app_settings**

```sql
INSERT INTO public.app_settings (key, value, description)
VALUES ('super_admin_user_id', '', 'Supabase auth.uid() of the super admin account. Empty until account is created.')
ON CONFLICT (key) DO NOTHING;
```

This allows the super admin to be identified by a configurable app_settings value instead of hardcoded logic. The value starts empty -- the client will set it when the super admin account is created.

**Section 3: Grant and notify**

```sql
NOTIFY pgrst, 'reload schema';
```

No new grants needed (existing grants from migration 024 cover these functions).

Add a header comment documenting what this migration fixes and referencing the Phase 22 isolation audit.
  </action>
  <verify>
Review the migration SQL for correctness:
1. The `join_farm_with_code_impl` function no longer references `invite_code` or `public.farms`
2. The `super_admin_user_id` INSERT uses `ON CONFLICT DO NOTHING` for idempotency
3. `NOTIFY pgrst, 'reload schema'` is present
4. Run `npx tsc -b --noEmit` to confirm no TypeScript impact (migration is SQL-only)
  </verify>
  <done>
Migration file exists at `supabase/migrations/035_isolation_audit_fixes.sql`. The stale `farms.invite_code` fallback in `join_farm_with_code_impl` is removed. A `super_admin_user_id` row exists in app_settings insert. No references to dropped `invite_code` column remain in any RPC function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive audit report</name>
  <files>.planning/phases/22-farm-data-isolation-audit/22-AUDIT-REPORT.md</files>
  <action>
Create a comprehensive audit report at `.planning/phases/22-farm-data-isolation-audit/22-AUDIT-REPORT.md` documenting every layer of farm data isolation that was audited.

**Report structure:**

# Farm Data Isolation Audit Report

## Executive Summary
Brief summary: Database layer is well-isolated with no cross-farm leakage. Two stale code references cleaned. Critical client-side gap found and fixed (13 files using authStatus instead of useActiveFarm). Super admin UI features implemented.

## Audit Methodology
List all layers audited: RLS policies, PowerSync sync rules, RPC functions, trigger functions, client-side hooks/pages, connector upload path.

## Findings by Layer

### Layer 1: RLS Policies
Table for each table (farms, wells, readings, allocations, farm_members, farm_invites, users, subscription_tiers, app_settings) showing:
- Policies defined (SELECT/INSERT/UPDATE/DELETE)
- Isolation method (farm_id filter, membership check, etc.)
- Verdict: PASS/FAIL with explanation

### Layer 2: PowerSync Sync Rules
Table for each bucket showing parameterization and data filter. All PASS.

### Layer 3: RPC Functions
Table for each function showing farm isolation check and super_admin support. Note the two stale references fixed.

### Layer 4: Trigger Functions
Table showing all triggers use fully qualified `public.` references.

### Layer 5: Client-Side Hooks & Pages
Document the critical gap: 13 files used authStatus?.farmId instead of useActiveFarm().farmId. List all files and the fix applied.

### Layer 6: Connector Upload Path
Document that all writes go through Supabase RLS. No bypass possible.

## Remediation Summary
1. Migration 035: Cleaned stale invite_code references, added super_admin_user_id setting
2. 13 files: Replaced authStatus?.farmId with useActiveFarm().farmId
3. Header: Maroon background for super_admin
4. activeFarmStore: Added Zustand persist middleware
5. Sync rules docs: Added super_admin auto-membership note

## Requirement Verification
- ISO-01: PASS — All RLS policies filter by farm_id via get_user_farm_ids()
- ISO-02: PASS — All sync rule buckets parameterized by farm_id from farm_members
- ISO-03: PASS — Super admin auto-membership gives consistent cross-farm access
  </action>
  <verify>
1. Report exists at `.planning/phases/22-farm-data-isolation-audit/22-AUDIT-REPORT.md`
2. Report covers all 6 layers
3. Report includes requirement verification section
4. All tables have PASS/FAIL verdicts
  </verify>
  <done>
Comprehensive audit report written covering all database layers, findings, remediation actions, and requirement verification.
  </done>
</task>

</tasks>

<verification>
- Migration file parses as valid SQL (no syntax errors)
- No reference to `invite_code` column exists in the new function body
- `super_admin_user_id` setting is inserted with empty default value
- Migration is idempotent (ON CONFLICT DO NOTHING for app_settings)
</verification>

<success_criteria>
- `supabase/migrations/035_isolation_audit_fixes.sql` exists and contains the cleaned RPC + app setting
- The stale legacy invite code fallback path is removed from `join_farm_with_code_impl`
- `super_admin_user_id` is available as a configurable app_setting
- Comprehensive audit report exists documenting all layers with PASS/FAIL verdicts
</success_criteria>

<output>
After completion, create `.planning/phases/22-farm-data-isolation-audit/22-01-SUMMARY.md`
</output>
