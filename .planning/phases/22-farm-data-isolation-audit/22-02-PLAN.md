---
phase: 22-farm-data-isolation-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useWells.ts
  - src/hooks/useWellCount.ts
  - src/hooks/useSubscriptionTier.ts
  - src/hooks/useSeatUsage.ts
  - src/pages/DashboardPage.tsx
  - src/pages/WellListPage.tsx
  - src/pages/WellDetailPage.tsx
  - src/pages/WellAllocationsPage.tsx
  - src/pages/UsersPage.tsx
  - src/pages/SubscriptionPage.tsx
  - src/pages/SettingsPage.tsx
  - src/components/PendingInvitesList.tsx
  - src/components/AddUserModal.tsx
  - src/stores/activeFarmStore.ts
  - src/components/Header.tsx
  - docs/powersync-sync-rules.yaml
autonomous: true
requirements:
  - ISO-01
  - ISO-02
  - ISO-03

must_haves:
  truths:
    - "All hooks and pages query by the active farm (own or super_admin override), not hardcoded auth farm"
    - "Super admin farm selection persists across page reloads via Zustand persist"
    - "Header background is maroon (#800000) when user is super_admin"
    - "useUserRole.ts and FarmSelector.tsx are NOT modified (circular dependency and ownFarmId respectively)"
  artifacts:
    - path: "src/hooks/useWells.ts"
      provides: "Well queries filtered by active farm"
      contains: "useActiveFarm"
    - path: "src/hooks/useWellCount.ts"
      provides: "Well count filtered by active farm"
      contains: "useActiveFarm"
    - path: "src/hooks/useSubscriptionTier.ts"
      provides: "Tier lookup by active farm"
      contains: "useActiveFarm"
    - path: "src/hooks/useSeatUsage.ts"
      provides: "Seat usage by active farm"
      contains: "useActiveFarm"
    - path: "src/pages/DashboardPage.tsx"
      provides: "Dashboard uses active farm"
      contains: "useActiveFarm"
    - path: "src/pages/UsersPage.tsx"
      provides: "Users page uses active farm"
      contains: "useActiveFarm"
    - path: "src/stores/activeFarmStore.ts"
      provides: "Persisted farm override state"
      contains: "persist"
    - path: "src/components/Header.tsx"
      provides: "Maroon header for super_admin"
      contains: "bg-[#800000]"
  key_links:
    - from: "src/hooks/useWells.ts"
      to: "src/hooks/useActiveFarm.ts"
      via: "useActiveFarm().farmId replaces authStatus?.farmId"
      pattern: "useActiveFarm"
    - from: "src/stores/activeFarmStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist"
    - from: "src/components/Header.tsx"
      to: "src/hooks/useUserRole.ts"
      via: "role-based header color"
      pattern: "super_admin.*bg-\\[#800000\\]"
---

<objective>
Fix all 13 files that use `authStatus?.farmId` to use `useActiveFarm().farmId` instead, add Zustand persist middleware to the active farm store, add a maroon header for super_admin users, and update sync rules documentation.

Purpose: When a super_admin switches farms via FarmSelector, ALL data queries must use the selected farm -- not the super_admin's primary farm. Without this fix, farm switching is cosmetic only (FarmSelector updates but data stays pinned to the admin's primary farm). The persist middleware ensures the selected farm survives page reloads. The maroon header provides constant visual awareness that the user has elevated privileges.

Output: 13 files using useActiveFarm, a persisted Zustand store, a role-aware header, and updated sync rules documentation.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-farm-data-isolation-audit/22-CONTEXT.md
@src/hooks/useActiveFarm.ts
@src/hooks/useUserRole.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix data hooks to use useActiveFarm instead of authStatus</name>
  <files>
    src/hooks/useWells.ts
    src/hooks/useWellCount.ts
    src/hooks/useSubscriptionTier.ts
    src/hooks/useSeatUsage.ts
  </files>
  <action>
In each of these four hooks, replace the `authStatus?.farmId` pattern with `useActiveFarm().farmId`.

**useWells.ts:**
- Remove: `import { useAuth } from '../lib/AuthProvider';`
- Add: `import { useActiveFarm } from './useActiveFarm';`
- Replace: `const { authStatus } = useAuth();` and `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`
- The rest of the hook remains identical (query guard, useQuery, useMemo mapping).

**useWellCount.ts:**
- Same pattern: remove useAuth import, add useActiveFarm import.
- Replace `const { authStatus } = useAuth();` and `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`

**useSubscriptionTier.ts:**
- Same pattern: remove useAuth import, add useActiveFarm import.
- Replace `const { authStatus } = useAuth();` and `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`

**useSeatUsage.ts:**
- Same pattern: remove useAuth import, add useActiveFarm import.
- Replace `const { authStatus } = useAuth();` and `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`

**IMPORTANT -- DO NOT modify useUserRole.ts.** It must keep using `authStatus?.farmId` because `useActiveFarm` calls `useUserRole` internally. Changing it would create a circular dependency. This is safe because super_admin has `role = 'super_admin'` in ALL farms (auto-add triggers from migration 025).

**IMPORTANT -- DO NOT modify FarmSelector.tsx.** It correctly uses `authStatus?.farmId` as `ownFarmId` to distinguish the user's own farm from overrides.
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with zero errors
2. Grep confirms no `authStatus?.farmId` in the four modified hooks
3. Grep confirms `useActiveFarm` is imported in all four hooks
  </verify>
  <done>
All four data hooks derive farmId from useActiveFarm() instead of authStatus. useUserRole.ts and FarmSelector.tsx are unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix pages and components to use useActiveFarm instead of authStatus</name>
  <files>
    src/pages/DashboardPage.tsx
    src/pages/WellListPage.tsx
    src/pages/WellDetailPage.tsx
    src/pages/WellAllocationsPage.tsx
    src/pages/UsersPage.tsx
    src/pages/SubscriptionPage.tsx
    src/pages/SettingsPage.tsx
    src/components/PendingInvitesList.tsx
    src/components/AddUserModal.tsx
  </files>
  <action>
Replace `authStatus?.farmId` with `useActiveFarm().farmId` in all 9 files. The pattern is the same in each file but some have additional references to `authStatus.farmName` that also need updating.

**DashboardPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const farmId = authStatus?.farmId ?? null;` and `const farmName = authStatus?.farmName ?? null;`
- With: `const { farmId, farmName } = useActiveFarm();`
- Keep `useAuth` import if still needed for `user` (check: `user` is used for `user?.id` in well creation)
- The `upgradeUrl` computation uses `farmId` which now comes from useActiveFarm -- correct.

**WellListPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const { authStatus } = useAuth();` and `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`
- Remove useAuth import if no longer needed (check: only `authStatus` is destructured from useAuth)
- `useLatestReadings(farmId)` will now receive the active farm ID -- correct.
- `upgradeUrl` uses `farmId` which now comes from useActiveFarm -- correct.

**WellDetailPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const farmId = authStatus?.farmId ?? '';`
- With: `const { farmId: activeFarmId } = useActiveFarm();` and `const farmId = activeFarmId ?? '';`
- Keep useAuth import if needed for other properties.

**WellAllocationsPage.tsx:**
- Same pattern as WellDetailPage.tsx: replace `authStatus?.farmId ?? ''` with useActiveFarm().

**UsersPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`
- Keep useAuth import for `user` (used for `user?.id` in member comparison).

**SubscriptionPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const farmId = authStatus?.farmId ?? null;`
- With: `const { farmId } = useActiveFarm();`
- Remove useAuth import if no longer needed.

**SettingsPage.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- At the farm ID display section (~line 281): replace `authStatus?.farmId` with the active farm's farmId.
- Keep useAuth import for user profile editing and other auth properties.

**PendingInvitesList.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace: `const farmId = authStatus?.farmId;`
- With: `const { farmId } = useActiveFarm();`
- Remove useAuth import if no longer needed.

**AddUserModal.tsx:**
- Add: `import { useActiveFarm } from '../hooks/useActiveFarm';`
- Replace all 6 references to `authStatus?.farmId` and `authStatus.farmId`:
  - Line 41: `authStatus?.farmId` in upgradeUrl computation → use `farmId` from useActiveFarm
  - Line 42: `authStatus.farmId` in buildSubscriptionUrl → use `farmId`
  - Line 76: `authStatus?.farmId` guard → use `farmId`
  - Line 98: `authStatus.farmId` in invite RPC call → use `farmId`
  - Line 141: `authStatus?.farmId` in useMemo dep → use `farmId`
  - Line 323: `authStatus?.farmId` in disabled check → use `farmId`
- Also replace `authStatus?.farmName` (line 141 region) with `farmName` from useActiveFarm.
- Keep useAuth import for `user`, `session`, and other auth properties needed in this component.

**General pattern for each file:**
1. Add `import { useActiveFarm } from '../hooks/useActiveFarm';` (or `'./useActiveFarm'` for hooks)
2. Add `const { farmId, farmName } = useActiveFarm();` (or just `farmId` if farmName not needed)
3. Remove `authStatus?.farmId` and `authStatus?.farmName` usages
4. Only remove `useAuth` import if ALL its destructured values are no longer needed
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with zero errors
2. Grep for `authStatus?.farmId` across all 9 modified files returns empty
3. Grep confirms `useActiveFarm` is imported in all 9 files
4. Verify useAuth is still imported in files that need `user`, `session`, or other auth context
  </verify>
  <done>
All 9 pages and components derive farmId from useActiveFarm() instead of authStatus. Super admin farm switching now propagates through every data query on every page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Zustand persist to activeFarmStore, maroon header, and update sync rules docs</name>
  <files>
    src/stores/activeFarmStore.ts
    src/components/Header.tsx
    docs/powersync-sync-rules.yaml
  </files>
  <action>
**activeFarmStore.ts -- Add Zustand persist middleware:**

Replace the current `create<ActiveFarmState>((set) => ({ ... }))` with `persist` middleware so the super_admin's last-viewed farm survives page reloads.

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface ActiveFarmState {
  overrideFarmId: string | null;
  overrideFarmName: string | null;
  setActiveFarm: (farmId: string, farmName: string) => void;
  clearOverride: () => void;
}

export const useActiveFarmStore = create<ActiveFarmState>()(
  persist(
    (set) => ({
      overrideFarmId: null,
      overrideFarmName: null,
      setActiveFarm: (farmId, farmName) =>
        set({ overrideFarmId: farmId, overrideFarmName: farmName }),
      clearOverride: () =>
        set({ overrideFarmId: null, overrideFarmName: null }),
    }),
    {
      name: 'ag-active-farm',
    }
  )
);
```

Key points:
- Use `persist` from `zustand/middleware` (already included with zustand v5, no extra install)
- Storage key: `'ag-active-farm'` (stored in localStorage)
- The double parentheses `create<T>()(persist(...))` is required by Zustand v5 TypeScript inference with middleware
- `clearOverride()` is already called on sign-out in AuthProvider, so persisted state clears properly
- Non-super_admin users: `useActiveFarm()` ignores override at line 22 (`role === 'super_admin'` check)

**Header.tsx -- Maroon background for super_admin:**

- The header currently uses `bg-[#5f7248]` (green) at line 16.
- When `role === 'super_admin'`, use `bg-[#800000]` (maroon) instead.
- Implementation: Compute `const headerBg = role === 'super_admin' ? 'bg-[#800000]' : 'bg-[#5f7248]';` before the return statement and use `headerBg` in the `<header>` className.
- `useUserRole` is already imported and called in Header.tsx (for `hasPermission(role, 'cross_farm_access')`), so no new imports needed.

**docs/powersync-sync-rules.yaml -- Add super_admin documentation:**

Add a comment section at the top of the file documenting the super_admin behavior:
```yaml
# Super Admin Note:
#   Super admin users have farm_members rows in ALL farms (via auto-add
#   triggers from migration 025). This means all farm-scoped buckets
#   naturally include all farms for super_admin users -- no special
#   sync rule logic is needed.
```
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with zero errors
2. Grep confirms `persist` is used in activeFarmStore
3. Grep confirms maroon color in Header: `grep "800000" src/components/Header.tsx`
4. docs/powersync-sync-rules.yaml contains the super admin note
  </verify>
  <done>
The active farm store persists to localStorage. Header is maroon for super_admin. Sync rules documentation updated with super_admin behavior note.
  </done>
</task>

</tasks>

<verification>
- `npx tsc -b --noEmit` passes with zero type errors
- No file uses `authStatus?.farmId` for data queries except useUserRole.ts (circular dep), useActiveFarm.ts (the source), and FarmSelector.tsx (ownFarmId)
- activeFarmStore uses Zustand persist middleware with localStorage
- Header.tsx conditionally applies maroon background for super_admin role
- docs/powersync-sync-rules.yaml documents super_admin auto-membership behavior
</verification>

<success_criteria>
- 13 files (4 hooks + 7 pages + 2 components) use useActiveFarm().farmId for data queries
- activeFarmStore persists to localStorage via Zustand persist middleware
- Header is maroon when role is super_admin, green otherwise
- Sync rules documentation is updated
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-farm-data-isolation-audit/22-02-SUMMARY.md`
</output>
