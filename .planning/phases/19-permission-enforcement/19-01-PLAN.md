---
phase: 19-permission-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/permissions.ts
  - src/App.tsx
  - src/components/SideMenu.tsx
autonomous: true
requirements:
  - PERM-04
  - PERM-01
  - PERM-02

must_haves:
  truths:
    - "Permission matrix contains 12 actions: create_well, edit_well, delete_well, manage_allocations, record_reading, edit_reading, delete_reading, view_wells, manage_users, manage_farm, manage_invites, cross_farm_access"
    - "Meter checker navigating to /wells/:id/edit is redirected to the map page"
    - "Meter checker navigating to /wells/:id/allocations is redirected to the map page"
    - "Meter checker navigating to /users is redirected to the map page"
    - "Users nav item is hidden for meter checkers in the side menu"
  artifacts:
    - path: "src/lib/permissions.ts"
      provides: "12-action permission matrix with manage_wells and view_members removed"
      contains: "edit_well"
    - path: "src/App.tsx"
      provides: "RequireRole route guards on well edit, allocations, and users routes"
      contains: "RequireRole"
    - path: "src/components/SideMenu.tsx"
      provides: "Users nav item filtered by manage_users action"
      contains: "manage_users"
  key_links:
    - from: "src/App.tsx"
      to: "src/lib/permissions.ts"
      via: "RequireRole action prop referencing new Action type values"
      pattern: "action=\"edit_well\""
    - from: "src/components/SideMenu.tsx"
      to: "src/lib/permissions.ts"
      via: "requiredAction property on Users nav item"
      pattern: "requiredAction.*manage_users"
---

<objective>
Replace the coarse permission matrix with the 12-action matrix from user decisions, add RequireRole route guards for well editing, allocation management, and user management routes, and hide the Users nav item for meter checkers.

Purpose: Establish the permission foundation and route-level access control so meter checkers cannot reach restricted pages.
Output: Updated permissions.ts with new action set, App.tsx with three new route guards, SideMenu.tsx with Users item gated.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-permission-enforcement/19-CONTEXT.md
@.planning/phases/19-permission-enforcement/19-RESEARCH.md
@src/lib/permissions.ts
@src/components/RequireRole.tsx
@src/App.tsx
@src/components/SideMenu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace permission matrix with 12-action system</name>
  <files>src/lib/permissions.ts</files>
  <action>
Replace the ACTIONS array and PERMISSION_MATRIX in `src/lib/permissions.ts` with the 12-action matrix specified in CONTEXT.md.

**New ACTIONS array (replace existing):**
```
'create_well', 'edit_well', 'delete_well', 'manage_allocations',
'record_reading', 'edit_reading', 'delete_reading', 'view_wells',
'manage_users', 'manage_farm', 'manage_invites', 'cross_farm_access'
```

**Removed actions:** `manage_wells`, `view_members` -- these no longer exist in the array.

**Updated PERMISSION_MATRIX:**
- `super_admin`: ALL_ACTIONS (all 12)
- `grower`: ALL_EXCEPT_CROSS_FARM (11, excludes cross_farm_access)
- `admin`: `create_well`, `edit_well`, `delete_well`, `manage_allocations`, `record_reading`, `edit_reading`, `delete_reading`, `view_wells`, `manage_users`, `manage_invites` (10 actions -- excludes manage_farm and cross_farm_access)
- `meter_checker`: `record_reading`, `edit_reading`, `delete_reading`, `view_wells` (4 actions)

**Also remove `isAdminOrAbove()` function** -- research confirms it is never imported anywhere in the codebase. Remove the function and its JSDoc comment. Keep `hasPermission`, `ROLE_DISPLAY_NAMES`, and `ROLE_BADGE_STYLES` unchanged.

**Keep ALL_ACTIONS and ALL_EXCEPT_CROSS_FARM helper constants** -- they still work with the new array.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero errors. Grep for `manage_wells` and `view_members` in `src/` -- zero results. Grep for `isAdminOrAbove` in `src/` -- zero results.</verify>
  <done>permissions.ts exports a 12-action ACTIONS array and PERMISSION_MATRIX matching the CONTEXT.md matrix exactly. Old actions and unused helper are gone.</done>
</task>

<task type="auto">
  <name>Task 2: Add route guards and gate Users nav item</name>
  <files>src/App.tsx, src/components/SideMenu.tsx</files>
  <action>
**App.tsx route guards:**

Wrap three routes with `RequireRole` layout guards (same pattern as the existing `/subscription` guard):

1. `/wells/:id/edit` -- `RequireRole action="edit_well"` with fallbackPath="/"
2. `/wells/:id/allocations` -- `RequireRole action="manage_allocations"` with fallbackPath="/"
3. `/users` -- `RequireRole action="manage_users"` with fallbackPath="/"

Use static fallbackPath="/" (map page) for all three. Per user decision, redirect is silent with no toast. The `RequireRole` component already returns null during loading and redirects when unauthorized -- no changes needed to RequireRole itself.

Replace the existing unguarded route lines:
```tsx
<Route path="/users" element={<UsersPage />} />
```
with:
```tsx
<Route element={<RequireRole action="manage_users" />}>
  <Route path="/users" element={<UsersPage />} />
</Route>
```

And similarly for `/wells/:id/edit` and `/wells/:id/allocations`. Keep `/wells/:id` (detail page) unguarded -- accessible to all roles.

**SideMenu.tsx Users nav item:**

Add `requiredAction: 'manage_users'` to the Users nav item in the `navItems` array. The existing `visibleItems` filter already handles this -- no other changes needed.

Change:
```tsx
{ label: 'Users', icon: UsersIcon, path: '/users' },
```
to:
```tsx
{ label: 'Users', icon: UsersIcon, path: '/users', requiredAction: 'manage_users' },
```
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero errors. Verify App.tsx has 4 total RequireRole usages (subscription + 3 new). Verify SideMenu has 2 requiredAction entries (manage_farm + manage_users).</verify>
  <done>Meter checkers are redirected to `/` when accessing well edit, allocations, or users routes via URL. Users nav item is hidden for meter checkers.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Grep `manage_wells` in src/ returns zero matches
3. Grep `view_members` in src/ returns zero matches
4. Grep `isAdminOrAbove` in src/ returns zero matches
5. App.tsx contains `RequireRole` wrapping edit, allocations, and users routes
6. SideMenu.tsx Users item has `requiredAction: 'manage_users'`
</verification>

<success_criteria>
- Permission matrix has exactly 12 actions matching CONTEXT.md specification
- Three new route guards protect well edit, allocations, and users pages
- Users nav item hidden for meter checkers
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-permission-enforcement/19-01-SUMMARY.md`
</output>
