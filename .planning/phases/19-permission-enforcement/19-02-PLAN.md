---
phase: 19-permission-enforcement
plan: 02
type: execute
wave: 2
depends_on:
  - 19-01
files_modified:
  - src/pages/WellDetailPage.tsx
  - src/components/WellDetailSheet.tsx
  - src/components/WellDetailHeader.tsx
  - src/pages/SettingsPage.tsx
autonomous: true
requirements:
  - PERM-01
  - PERM-03

must_haves:
  truths:
    - "Meter checker viewing a well detail page does not see the Edit button"
    - "Meter checker on the Settings page does not see the Farm ID row"
    - "Grower and admin viewing a well detail page see the Edit button"
    - "All roles see the New Reading button on well detail page"
  artifacts:
    - path: "src/pages/WellDetailPage.tsx"
      provides: "Permission check that conditionally passes onEdit to WellDetailSheet"
      contains: "hasPermission"
    - path: "src/components/WellDetailSheet.tsx"
      provides: "Optional onEdit prop that hides edit when undefined"
      contains: "onEdit?"
    - path: "src/components/WellDetailHeader.tsx"
      provides: "Conditional edit button rendering based on onEdit presence"
      contains: "onEdit &&"
    - path: "src/pages/SettingsPage.tsx"
      provides: "Farm ID row hidden for meter checkers"
      contains: "hasPermission"
  key_links:
    - from: "src/pages/WellDetailPage.tsx"
      to: "src/lib/permissions.ts"
      via: "hasPermission(role, 'edit_well') determining onEdit callback"
      pattern: "hasPermission.*edit_well"
    - from: "src/pages/WellDetailPage.tsx"
      to: "src/components/WellDetailSheet.tsx"
      via: "onEdit prop passed as undefined when no permission"
      pattern: "onEdit.*canEdit"
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/components/WellDetailHeader.tsx"
      via: "onEdit prop forwarded only when defined"
      pattern: "onEdit.*onEdit"
---

<objective>
Hide the well edit button for meter checkers on the well detail page, and hide farm-level settings for meter checkers on the Settings page.

Purpose: Meter checkers see a clean, read-only experience -- well detail shows only view and reading actions, settings shows only personal information.
Output: WellDetailPage/Sheet/Header chain conditionally hides edit button, SettingsPage hides Farm ID row for restricted roles.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-permission-enforcement/19-CONTEXT.md
@.planning/phases/19-permission-enforcement/19-RESEARCH.md
@.planning/phases/19-permission-enforcement/19-01-SUMMARY.md
@src/pages/WellDetailPage.tsx
@src/components/WellDetailSheet.tsx
@src/components/WellDetailHeader.tsx
@src/pages/SettingsPage.tsx
@src/lib/permissions.ts
@src/hooks/useUserRole.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hide edit button for meter checkers on well detail page</name>
  <files>src/pages/WellDetailPage.tsx, src/components/WellDetailSheet.tsx, src/components/WellDetailHeader.tsx</files>
  <action>
**Strategy:** Lift the permission check to WellDetailPage (the top of the chain) and pass `onEdit` as `undefined` when the user lacks `edit_well` permission. This follows the existing project pattern of managing callbacks at the page level and avoids adding hooks inside `React.memo` components.

**WellDetailPage.tsx:**
1. Add imports: `import { useUserRole } from '../hooks/useUserRole';` and `import { hasPermission } from '../lib/permissions';`
2. Inside the component, after `const farmId = ...`:
   ```tsx
   const role = useUserRole();
   const canEdit = hasPermission(role, 'edit_well');
   ```
3. Change the `onEdit` prop passed to `WellDetailSheet` from `onEdit={handleEdit}` to `onEdit={canEdit ? handleEdit : undefined}`.

**WellDetailSheet.tsx:**
1. Make `onEdit` optional in the `WellDetailSheetProps` interface: change `onEdit: () => void;` to `onEdit?: () => void;`
2. Forward `onEdit` to `WellDetailHeader` unchanged -- it will be `undefined` for meter checkers.

**WellDetailHeader.tsx:**
1. Make `onEdit` optional in `WellDetailHeaderProps`: change `onEdit: () => void;` to `onEdit?: () => void;`
2. Wrap the edit button (lines 74-82, the `<button>` with `onClick={onEdit}` and "Edit" text) in a conditional: `{onEdit && ( ... )}`. This completely hides the button when `onEdit` is undefined.
3. The Back button, map pin, well info, and proximity indicator remain unchanged -- visible to all roles.

**Do NOT:**
- Add `useUserRole()` inside WellDetailHeader (it is `React.memo` -- avoid unnecessary hook, lift check to page level)
- Disable the button instead of hiding it (user decision: completely hidden)
- Show a toast or message (user decision: no notification)
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero errors. Verify WellDetailHeader renders edit button only when `onEdit` is defined. Verify WellDetailPage imports and uses `hasPermission` with `'edit_well'`.</verify>
  <done>Meter checkers see the well detail page without an Edit button. Growers, admins, and super_admins see the Edit button. New Reading button remains visible for all roles.</done>
</task>

<task type="auto">
  <name>Task 2: Hide farm-level settings for meter checkers</name>
  <files>src/pages/SettingsPage.tsx</files>
  <action>
**What to hide:** The Farm ID row in the Account section. Per the user's decision, meter checkers should see only personal settings. The Farm ID is informational but farm-level -- hide it for users without `manage_farm` permission. Phone number, role, profile editing, and sign out remain visible to all.

**SettingsPage.tsx:**
1. Add import: `import { hasPermission } from '../lib/permissions';` (the file already imports from `'../lib/permissions'` for `ROLE_DISPLAY_NAMES` and `Role` -- add `hasPermission` to the existing import).
2. After `const userRole = useUserRole();` (already exists), add:
   ```tsx
   const canManageFarm = hasPermission(userRole, 'manage_farm');
   ```
3. Wrap the Farm ID row (`onboardingStatus?.farmId && (...)` block, approximately lines 261-265) with an additional `canManageFarm` check:
   ```tsx
   {canManageFarm && onboardingStatus?.farmId && (
     <div className="p-4">
       <p className="text-sm text-gray-400">Farm ID</p>
       <p className="text-white font-mono text-sm">{onboardingStatus.farmId}</p>
     </div>
   )}
   ```

**Do NOT:**
- Hide the phone number row (personal info, visible to all)
- Hide the role badge (personal info, visible to all)
- Hide the profile edit section (personal, visible to all)
- Hide the sign out button (available to all)
- The Subscription link is already hidden via SideMenu `requiredAction: 'manage_farm'` gating -- no changes needed there
  </action>
  <verify>Run `npx tsc -b --noEmit` -- zero errors. Verify SettingsPage uses `hasPermission` with `'manage_farm'` to gate Farm ID row.</verify>
  <done>Meter checkers see Profile (name, email) + Account (phone, role) + Sign Out on Settings page. Farm ID row is hidden. Growers and admins see all settings including Farm ID.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. WellDetailPage.tsx imports `useUserRole` and `hasPermission`, checks `edit_well` permission
3. WellDetailSheet.tsx has optional `onEdit?` prop
4. WellDetailHeader.tsx conditionally renders edit button with `{onEdit && (...)}`
5. SettingsPage.tsx hides Farm ID row with `canManageFarm` check
6. New Reading button on well detail page is NOT gated (visible to all roles)
</verification>

<success_criteria>
- Meter checker sees well detail without Edit button
- Meter checker sees Settings without Farm ID
- Grower/admin/super_admin see Edit button and Farm ID
- New Reading button visible for all roles
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-permission-enforcement/19-02-SUMMARY.md`
</output>
