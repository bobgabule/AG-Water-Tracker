---
phase: 17-subscription-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/033_subscription_tier_tables.sql
autonomous: false
requirements:
  - TIER-01
  - TIER-02
  - TIER-03

must_haves:
  truths:
    - "A subscription_tiers table exists with Starter and Pro rows containing per-role seat limits and well limits"
    - "An app_settings table exists with subscription_website_url, support_email, and app_url rows"
    - "Every farm has a subscription_tier column (NOT NULL) linking to subscription_tiers, with existing farms set to 'pro'"
    - "Tier limits can be changed via direct DB update without redeploying the app"
    - "Both new tables have RLS enabled with read-only access for authenticated users"
  artifacts:
    - path: "supabase/migrations/033_subscription_tier_tables.sql"
      provides: "Complete migration creating subscription_tiers, app_settings, and farms.subscription_tier"
      min_lines: 80
      contains: "CREATE TABLE subscription_tiers"
  key_links:
    - from: "farms.subscription_tier"
      to: "subscription_tiers.slug"
      via: "FOREIGN KEY constraint"
      pattern: "REFERENCES subscription_tiers\\(slug\\)"
    - from: "subscription_tiers"
      to: "RLS policy"
      via: "Row Level Security"
      pattern: "ENABLE ROW LEVEL SECURITY"
---

<objective>
Create the subscription tier database foundation: a `subscription_tiers` lookup table, an `app_settings` key-value config table, and a `subscription_tier` FK column on the `farms` table, all in a single Supabase migration file.

Purpose: Move subscription tier limits from hardcoded constants (`src/lib/subscription.ts` PLAN_LIMITS) into the database so they can be queried and updated without code deploys. This is the foundation that Phase 18 (hooks) and Phase 20 (UI enforcement) build on.

Output: `supabase/migrations/033_subscription_tier_tables.sql` migration file ready to apply.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-subscription-database-foundation/17-CONTEXT.md
@.planning/phases/17-subscription-database-foundation/17-RESEARCH.md
@supabase/migrations/031_create_readings_and_allocations.sql
@supabase/migrations/001_initial_schema.sql
@src/lib/subscription.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 033 for subscription tier tables</name>
  <files>supabase/migrations/033_subscription_tier_tables.sql</files>
  <action>
Create `supabase/migrations/033_subscription_tier_tables.sql` with the following sections. Follow the project's established migration conventions (banner-comment headers, COMMENT ON annotations, updated_at triggers reusing `update_updated_at_column()` from migration 001, NOTIFY pgrst at end).

**Section 1: subscription_tiers table (TIER-01)**
- CREATE TABLE subscription_tiers with columns:
  - slug TEXT PRIMARY KEY
  - display_name TEXT NOT NULL
  - max_admins INTEGER NOT NULL
  - max_meter_checkers INTEGER NOT NULL
  - max_wells INTEGER NOT NULL
  - sort_order INTEGER NOT NULL DEFAULT 0
  - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
- Add COMMENT ON TABLE and COMMENT ON COLUMN for all columns
- Attach `update_updated_at_column()` trigger (same pattern as every other table in the project)
- Seed two rows:
  - ('starter', 'Starter Plan', 1, 1, 5, 1)
  - ('pro', 'Pro Plan', 1, 3, 10, 2)
- Per user decision: tier name is "Starter" not "Basic". Grower (always 1 per farm) is NOT stored as a seat limit. No is_active flag.

**Section 2: app_settings table (TIER-02)**
- CREATE TABLE app_settings with columns:
  - key TEXT PRIMARY KEY
  - value TEXT NOT NULL
  - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
- Add COMMENT ON TABLE and COMMENT ON COLUMN
- Attach `update_updated_at_column()` trigger
- Seed three rows with placeholder values:
  - ('subscription_website_url', 'https://example.com/subscribe')
  - ('support_email', 'support@example.com')
  - ('app_url', 'https://example.com/app')

**Section 3: farms.subscription_tier column (TIER-03)**
- Three-step pattern (add nullable, backfill, constrain):
  1. ALTER TABLE farms ADD COLUMN subscription_tier TEXT REFERENCES subscription_tiers(slug);
  2. UPDATE farms SET subscription_tier = 'pro' WHERE subscription_tier IS NULL;
  3. ALTER TABLE farms ALTER COLUMN subscription_tier SET NOT NULL;
- Add COMMENT ON COLUMN for the new column
- Create index: CREATE INDEX idx_farms_subscription_tier ON farms(subscription_tier);
- Per user decision: NO DEFAULT value on the column. Existing farms get 'pro'. New farms must have tier set explicitly at creation.

**Section 4: Row Level Security**
- ALTER TABLE subscription_tiers ENABLE ROW LEVEL SECURITY;
- ALTER TABLE app_settings ENABLE ROW LEVEL SECURITY;
- CREATE POLICY for SELECT on subscription_tiers TO authenticated USING (true);
- CREATE POLICY for SELECT on app_settings TO authenticated USING (true);
- No INSERT/UPDATE/DELETE policies (managed by super admin via Supabase dashboard using service_role which bypasses RLS)

**Section 5: NOTIFY pgrst**
- NOTIFY pgrst, 'reload schema'; (standard project convention for schema cache refresh)

**CRITICAL anti-patterns to avoid:**
- Do NOT add a DEFAULT on farms.subscription_tier (user explicitly decided no default)
- Do NOT use 'basic' -- the tier is called 'starter' per user decision
- Do NOT add grower seat limits to the tiers table (grower is always 1, inherent to farm)
- Do NOT create write RLS policies for the config tables
- Do NOT forget the updated_at triggers (project convention)
- Do NOT forget NOTIFY pgrst at the end
  </action>
  <verify>
1. File exists: `ls supabase/migrations/033_subscription_tier_tables.sql`
2. Contains all required CREATE TABLE statements: grep for `CREATE TABLE subscription_tiers`, `CREATE TABLE app_settings`
3. Contains three-step ALTER: grep for `ALTER TABLE farms ADD COLUMN subscription_tier`
4. Contains RLS: grep for `ENABLE ROW LEVEL SECURITY` (should appear twice)
5. Contains NOTIFY: grep for `NOTIFY pgrst`
6. Does NOT contain 'basic' as a tier slug: grep should find zero matches for `'basic'`
7. Does NOT contain DEFAULT on the subscription_tier column: grep for `DEFAULT.*starter` or `DEFAULT.*pro` on the ALTER TABLE line should find zero matches
8. TypeScript still compiles: `npx tsc -b --noEmit` (migration is SQL-only, no TS changes, but verify nothing broke)
  </verify>
  <done>
Migration file exists at `supabase/migrations/033_subscription_tier_tables.sql` with:
- subscription_tiers table with Starter and Pro seed data
- app_settings table with 3 placeholder rows
- farms.subscription_tier FK column with NOT NULL constraint and 'pro' backfill
- RLS enabled on both new tables with authenticated read-only policies
- updated_at triggers on both new tables
- NOTIFY pgrst at end
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Apply migration and verify in Supabase</name>
  <files>supabase/migrations/033_subscription_tier_tables.sql</files>
  <action>
Human applies migration 033 to Supabase and verifies the schema changes.

**What was built:** Migration 033 creates the subscription tier database foundation:
- `subscription_tiers` table with Starter and Pro tier rows
- `app_settings` table with placeholder config values
- `farms.subscription_tier` NOT NULL FK column (existing farms backfilled to 'pro')
- RLS policies granting authenticated read access
  </action>
  <verify>
1. Apply the migration to your Supabase instance:
   - Option A: Run `npx supabase db push` from the project root
   - Option B: Copy the SQL from `supabase/migrations/033_subscription_tier_tables.sql` and paste into Supabase Dashboard SQL Editor, then run

2. Verify subscription_tiers table:
   - In Supabase Dashboard > Table Editor, open `subscription_tiers`
   - Confirm two rows: 'starter' (1 admin, 1 meter checker, 5 wells) and 'pro' (1 admin, 3 meter checkers, 10 wells)

3. Verify app_settings table:
   - In Table Editor, open `app_settings`
   - Confirm three rows: subscription_website_url, support_email, app_url (all with placeholder values)
   - **Update the placeholder values** to your real URLs/email before deploying to production

4. Verify farms.subscription_tier column:
   - In Table Editor, open `farms`
   - Confirm the `subscription_tier` column exists and all existing farms show 'pro'

5. Verify RLS:
   - In Authentication > Policies, check that subscription_tiers and app_settings each have a SELECT policy for authenticated users
   - Confirm NO insert/update/delete policies exist on these tables

6. Quick query test (SQL Editor):
   ```sql
   SELECT f.name, st.display_name, st.max_wells
   FROM farms f JOIN subscription_tiers st ON st.slug = f.subscription_tier;
   ```
   Should return your farm(s) with "Pro Plan" and max_wells=10.
  </verify>
  <done>Migration applied to Supabase. subscription_tiers, app_settings tables exist. farms.subscription_tier column links to tiers. User approved.</done>
</task>

</tasks>

<verification>
1. Migration file exists and is syntactically valid SQL
2. subscription_tiers has exactly 2 rows with correct limits per CONTEXT.md decisions
3. app_settings has exactly 3 rows
4. farms.subscription_tier is NOT NULL with FK to subscription_tiers
5. RLS enabled on both new tables, read-only for authenticated
6. No DEFAULT on farms.subscription_tier
7. Tier slug is 'starter' not 'basic'
8. No grower seat limits in subscription_tiers
</verification>

<success_criteria>
- Migration 033 SQL file exists and follows project conventions
- After applying: `SELECT * FROM subscription_tiers` returns 2 rows (starter, pro)
- After applying: `SELECT * FROM app_settings` returns 3 rows
- After applying: `SELECT subscription_tier FROM farms` returns 'pro' for all existing farms
- After applying: `INSERT INTO subscription_tiers VALUES ('test', 'Test', 1, 1, 1, 3)` succeeds (extensible)
- After applying: Authenticated user API call can read tiers but not write
</success_criteria>

<output>
After completion, create `.planning/phases/17-subscription-database-foundation/17-01-SUMMARY.md`
</output>
