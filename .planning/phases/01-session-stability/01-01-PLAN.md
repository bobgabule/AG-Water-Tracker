---
phase: 01-session-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/AuthProvider.tsx
  - src/components/RequireAuth.tsx
  - src/components/RequireOnboarded.tsx
  - src/lib/PowerSyncContext.tsx
  - src/pages/onboarding/ProfilePage.tsx
autonomous: true

must_haves:
  truths:
    - "User reloads the app and sees either the dashboard or a login screen within 3 seconds -- never an infinite spinner"
    - "If get_onboarding_status RPC fails or times out, the app still resolves to a usable state"
    - "Loading screens show a spinner only (no text), with a 'Taking longer than usual...' message appearing after ~5 seconds"
  artifacts:
    - path: "src/lib/AuthProvider.tsx"
      provides: "Auth initialization with 5-second timeout on RPC, offline-first fallback, always sets isAuthReady in finally block"
      contains: "Promise.race"
    - path: "src/components/RequireOnboarded.tsx"
      provides: "Handles null onboardingStatus as a failure state (shows retry UI) rather than infinite spinner"
      contains: "showSlowMessage"
    - path: "src/components/RequireAuth.tsx"
      provides: "Loading screen without text, with slow-load detection"
      contains: "showSlowMessage"
    - path: "src/lib/PowerSyncContext.tsx"
      provides: "Loading screen without text, with slow-load detection"
      contains: "showSlowMessage"
    - path: "src/pages/onboarding/ProfilePage.tsx"
      provides: "Loading guard without text"
  key_links:
    - from: "src/lib/AuthProvider.tsx"
      to: "supabase.rpc('get_onboarding_status')"
      via: "Promise.race with 5-second timeout"
      pattern: "Promise\\.race"
    - from: "src/components/RequireOnboarded.tsx"
      to: "src/lib/AuthProvider.tsx"
      via: "useAuth().onboardingStatus with null handling"
      pattern: "onboardingStatus"
---

<objective>
Fix the auth initialization flow so the app never hangs on an infinite spinner when `get_onboarding_status` RPC fails or times out. Clean up all loading state text to use spinner-only with slow-load detection.

Purpose: AUTH-01 (session recovery) and AUTH-02 (dashboard reload resilience). The current auth flow blocks indefinitely when the RPC fails, leaving users staring at an infinite spinner. Field agents in areas with poor connectivity hit this regularly.

Output: Modified AuthProvider with timeout + offline-first fallback, updated RequireOnboarded with failure handling, and all loading screens updated to spinner-only with "Taking longer than usual..." after 5 seconds.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-session-stability/01-RESEARCH.md

@src/lib/AuthProvider.tsx
@src/components/RequireAuth.tsx
@src/components/RequireOnboarded.tsx
@src/lib/PowerSyncContext.tsx
@src/pages/onboarding/ProfilePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout and offline-first fallback to AuthProvider initialization</name>
  <files>src/lib/AuthProvider.tsx</files>
  <action>
Modify `fetchOnboardingStatus` and the `INITIAL_SESSION` handler in `AuthProvider.tsx` to add a 5-second timeout on the RPC call using `Promise.race`.

Specific changes:

1. In the `INITIAL_SESSION` case of `handleAuthStateChange` (around line 104-118), wrap the `fetchOnboardingStatus()` call with `Promise.race`:
   ```typescript
   const status = await Promise.race([
     fetchOnboardingStatus(),
     new Promise<null>((resolve) => setTimeout(() => resolve(null), 5000)),
   ]);
   setOnboardingStatus(status);
   ```

2. The same timeout pattern should be applied in the `SIGNED_IN` case (around line 128-131) and the `USER_UPDATED` case (around line 154-157).

3. In `initializeAuth` (around line 171-184), ensure the `finally` block ALWAYS sets `setIsAuthReady(true)` -- this is already the case, but verify it remains after changes.

4. The `verifyOtp` method (around line 237) does NOT need a timeout because it's user-initiated and the user expects to wait for verification. Leave it as-is.

Key behavior: When the RPC times out, `onboardingStatus` will be `null`. Task 2 handles what `RequireOnboarded` does with a null status after auth is ready.

Do NOT add any console.log statements. Error logging cleanup happens in Plan 03.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify that `Promise.race` is used in the INITIAL_SESSION, SIGNED_IN, and USER_UPDATED handlers.</verify>
  <done>AuthProvider RPC calls have a 5-second timeout via Promise.race. isAuthReady is always set in the finally block. The app resolves auth state within 5 seconds even if the RPC hangs.</done>
</task>

<task type="auto">
  <name>Task 2: Update RequireOnboarded to handle null status after auth ready + clean up all loading screens</name>
  <files>src/components/RequireOnboarded.tsx, src/components/RequireAuth.tsx, src/lib/PowerSyncContext.tsx, src/pages/onboarding/ProfilePage.tsx</files>
  <action>
**RequireOnboarded.tsx** -- The critical fix. Currently, when `onboardingStatus` is null (RPC failed/timed out), RequireOnboarded shows an infinite spinner because null is treated as "still loading." Fix this:

1. Import `useAuth` to also read `isAuthReady` and `session`:
   ```typescript
   const { onboardingStatus, isAuthReady, session } = useAuth();
   ```

2. Replace the current null-status spinner (lines 13-22) with a smarter check:
   - If `!isAuthReady` -- show the loading spinner (auth still initializing, legitimate wait)
   - If `isAuthReady && !onboardingStatus && session` -- auth completed but RPC failed. This is the bug case. Show a retry-able error state:
     - Use the same friendly error pattern: icon + "Something went wrong" + "Tap to try again" button
     - Import `ArrowPathIcon` from `@heroicons/react/24/outline`
     - The retry button should call `refreshOnboardingStatus()` from `useAuth()`
     - Add `useState` to track whether the retry is in progress (show spinner on the button during retry)
   - If `isAuthReady && !onboardingStatus && !session` -- no session at all, this shouldn't happen (RequireAuth catches it), but handle gracefully with a redirect to `/auth/phone`

3. Add slow-load detection: When showing the loading spinner (the `!isAuthReady` case), use a `useState` + `useEffect` timer. After 5 seconds of showing the spinner, set `showSlowMessage` to true and render `<p className="text-gray-400 text-sm">Taking longer than usual...</p>` below the spinner. Clean up the timer on unmount.

4. Remove the current `<p className="text-gray-400">Checking account status...</p>` text (violates "no status text" decision).

**RequireAuth.tsx** -- Update the loading screen (lines 20-29):
1. Remove `<p className="text-gray-400">Loading...</p>` (line 25)
2. Add slow-load detection: same pattern as above -- `useState(false)` for `showSlowMessage`, `useEffect` with 5-second timer, show "Taking longer than usual..." text when true
3. Add `useState` and `useEffect` imports if not already present

**PowerSyncContext.tsx** -- Update the loading screen (lines 50-58):
1. Convert the loading section to use a small component or inline the same pattern
2. Remove `<p className="text-gray-600">Initializing database...</p>` text
3. Add slow-load detection with the same 5-second "Taking longer than usual..." pattern
4. Change `text-gray-600` on the spinner to match the app's dark theme: use `bg-gray-900` for the container background (currently missing, causing a light background flash)

**ProfilePage.tsx** -- Update the loading guard (lines 25-36):
1. Remove `<p className="text-gray-400">Loading...</p>` text (line 31)
2. No slow-load detection needed here -- this is a transient guard that resolves almost instantly

Keep the friendly, approachable tone per user decision. Error UX should use icon + text pairing.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Visually inspect that: (1) no loading screen shows text initially, (2) RequireOnboarded has a retry button when onboardingStatus is null and isAuthReady is true, (3) slow-load messages appear after 5 seconds.</verify>
  <done>RequireOnboarded handles null onboardingStatus as a failure (retry UI) instead of infinite spinner. All four loading screens show spinner-only with "Taking longer than usual..." after 5 seconds. No loading text violates the "no status text" decision.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Grep for "Loading..." or "Checking account" or "Initializing database" in src/ -- should find zero matches in loading screens
3. Grep for "Promise.race" in AuthProvider.tsx -- should find matches in INITIAL_SESSION, SIGNED_IN, USER_UPDATED handlers
4. Grep for "Taking longer than usual" in RequireAuth.tsx, RequireOnboarded.tsx, PowerSyncContext.tsx -- should find matches
5. RequireOnboarded.tsx contains a retry button that calls refreshOnboardingStatus
</verification>

<success_criteria>
- App resolves auth state within 5 seconds even when RPC hangs (timeout fires)
- No loading screen shows text initially -- just spinner
- After 5 seconds, "Taking longer than usual..." message appears
- If RPC fails entirely, user sees a friendly retry screen (not infinite spinner)
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-stability/01-01-SUMMARY.md`
</output>
