---
phase: 01-session-stability
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - supabase/migrations/020_security_definer_private_schema.sql
  - src/lib/debugLog.ts
  - src/lib/powersync-connector.ts
  - src/lib/powersync.ts
  - src/lib/AuthProvider.tsx
  - src/pages/DashboardPage.tsx
  - src/components/MapView.tsx
  - src/components/AddUserModal.tsx
  - src/hooks/useGeolocation.ts
autonomous: true

must_haves:
  truths:
    - "All 8 SECURITY DEFINER functions are in the private schema, not directly callable via PostgREST API"
    - "Public schema has SECURITY INVOKER wrapper functions that delegate to private implementations"
    - "No sensitive data (upsert data, auth tokens, session details) is logged to console in production"
    - "A hidden debug mode (localStorage.__ag_debug) enables verbose logging for field support"
  artifacts:
    - path: "supabase/migrations/020_security_definer_private_schema.sql"
      provides: "Migration that moves all 8 SECURITY DEFINER functions to private schema with SECURITY INVOKER wrappers"
      contains: "CREATE SCHEMA IF NOT EXISTS private"
    - path: "src/lib/debugLog.ts"
      provides: "Debug logging utility gated behind localStorage flag"
      contains: "__ag_debug"
    - path: "src/lib/powersync-connector.ts"
      provides: "Console.log replaced with debugLog, no raw data logging in production"
    - path: "src/lib/powersync.ts"
      provides: "Sync status logging replaced with debugLog"
  key_links:
    - from: "supabase/migrations/020_security_definer_private_schema.sql"
      to: "public schema wrapper functions"
      via: "private.{function}_impl() called by public.{function}()"
      pattern: "private\\."
    - from: "src/lib/debugLog.ts"
      to: "All files with console.log/warn"
      via: "import { debugLog } from './debugLog'"
      pattern: "debugLog"
---

<objective>
Move all SECURITY DEFINER functions from the public schema to a private schema (preventing direct PostgREST API invocation) and replace all console.log/warn statements with a debug utility gated behind a localStorage flag.

Purpose: Security hardening (SECURITY DEFINER functions callable via PostgREST is a known exposure vector) and console cleanup (prevent sensitive data like upsert payloads from appearing in production logs). The user decision requires a quick audit of ALL RPC functions and a hidden debug mode for field support.

Output: SQL migration for private schema, debug logging utility, and all source files updated to use debugLog instead of console.log/warn.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-session-stability/01-RESEARCH.md
@.planning/phases/01-session-stability/01-01-SUMMARY.md
@.planning/phases/01-session-stability/01-02-SUMMARY.md

@supabase/migrations/010_auth_rpcs.sql
@supabase/migrations/015_update_create_farm_rpc.sql
@supabase/migrations/019_phone_invite_flow.sql
@src/lib/powersync-connector.ts
@src/lib/powersync.ts
@src/lib/AuthProvider.tsx
@src/pages/DashboardPage.tsx
@src/components/MapView.tsx
@src/components/AddUserModal.tsx
@src/hooks/useGeolocation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration to move SECURITY DEFINER functions to private schema</name>
  <files>supabase/migrations/020_security_definer_private_schema.sql</files>
  <action>
Create migration file `supabase/migrations/020_security_definer_private_schema.sql` that:

1. **Create private schema and set permissions:**
   ```sql
   CREATE SCHEMA IF NOT EXISTS private;
   REVOKE ALL ON SCHEMA private FROM public;
   REVOKE ALL ON SCHEMA private FROM anon;
   REVOKE ALL ON SCHEMA private FROM authenticated;
   GRANT USAGE ON SCHEMA private TO postgres;
   GRANT USAGE ON SCHEMA private TO service_role;
   ```

2. **For each of the 8 SECURITY DEFINER functions, create the private implementation and replace the public function with a SECURITY INVOKER wrapper:**

   The 8 functions (from research audit) with their current signatures:
   - `generate_random_code(integer)` -- helper, no auth
   - `create_farm_and_membership(text, text, text, text, text)` -- from migration 015
   - `join_farm_with_code(text)` -- from migration 010
   - `create_invite_code(uuid, text, integer, integer)` -- from migration 010
   - `get_onboarding_status()` -- from migration 019
   - `get_user_farm_memberships()` -- from migration 010
   - `invite_user_by_phone(uuid, text, text, text)` -- from migration 019
   - `revoke_farm_invite(text)` -- from migration 019

   For each function:
   a. Create `private.{function_name}_impl(...)` with:
      - Same body as the current public function
      - `SECURITY DEFINER`
      - `SET search_path = ''` (empty, per Supabase security recommendation)
      - All table references fully qualified: `public.users`, `public.farms`, `public.farm_members`, `public.farm_invites`, `public.wells`
      - `auth.uid()` remains as-is (auth schema is always available)

   b. Replace `public.{function_name}(...)` with:
      - `SECURITY INVOKER` (the default, but explicit for clarity)
      - `SET search_path = ''`
      - Body simply calls `SELECT private.{function_name}_impl(...)` or `PERFORM private.{function_name}_impl(...)` for VOID returns
      - Same return type
      - Same parameter names and types

   **Special cases:**
   - `generate_random_code` is a helper used ONLY by other SECURITY DEFINER functions. It should be moved entirely to private schema with NO public wrapper. The other private functions call `private.generate_random_code_impl()` instead of `generate_random_code()`.
   - `get_onboarding_status` references `auth.users` table -- use fully qualified `auth.users` (already qualified).
   - `invite_user_by_phone` also references `auth.users` -- same treatment.
   - Functions that return `VOID` (revoke_farm_invite): the wrapper should use `PERFORM` or `SELECT private.revoke_farm_invite_impl(...)` and return void.

3. **Drop the old public SECURITY DEFINER functions** after creating replacements. Use `DROP FUNCTION IF EXISTS` with exact signatures to avoid breaking overloaded functions.

4. **Add migration header comment** explaining the security rationale.

Important: The public wrapper functions MUST maintain identical signatures (parameter names, types, return types) so that existing client code (`supabase.rpc('get_onboarding_status')`) continues to work without changes.

Important: For `generate_random_code`, since it's being removed from public schema entirely, ensure all private functions that call it use `private.generate_random_code_impl()` instead.
  </action>
  <verify>Review the SQL for: (1) all 8 functions moved, (2) search_path set to empty string on all private functions, (3) all table references fully qualified in private implementations, (4) public wrappers use SECURITY INVOKER, (5) generate_random_code has no public wrapper. Run `npx tsc -b --noEmit` (migration doesn't affect TS, but confirms no accidental changes).</verify>
  <done>All 8 SECURITY DEFINER functions moved to private schema. Public wrappers use SECURITY INVOKER. search_path = '' on all private functions. Table references fully qualified. generate_random_code fully private (no public API exposure). Migration file ready for deployment via Supabase CLI.</done>
</task>

<task type="auto">
  <name>Task 2: Create debug logging utility and replace all console.log/warn statements</name>
  <files>src/lib/debugLog.ts, src/lib/powersync-connector.ts, src/lib/powersync.ts, src/lib/AuthProvider.tsx, src/pages/DashboardPage.tsx, src/components/MapView.tsx, src/components/AddUserModal.tsx, src/hooks/useGeolocation.ts</files>
  <action>
1. **Create `src/lib/debugLog.ts`:**
   ```typescript
   const DEBUG = typeof window !== 'undefined' && localStorage.getItem('__ag_debug') === 'true';

   export function debugLog(tag: string, ...args: unknown[]): void {
     if (DEBUG) {
       console.log(`[${tag}]`, ...args);
     }
   }

   export function debugWarn(tag: string, ...args: unknown[]): void {
     if (DEBUG) {
       console.warn(`[${tag}]`, ...args);
     }
   }

   export function debugError(tag: string, ...args: unknown[]): void {
     if (DEBUG) {
       console.error(`[${tag}]`, ...args);
     }
   }
   ```

2. **Replace console statements in each file** according to the research inventory:

   **src/lib/powersync-connector.ts:**
   - Line 68: `console.error('[PowerSync] Permanent upload error...')` -> `debugError('PowerSync', 'Permanent upload error, discarding transaction:', error)`
   - Line 71: `console.warn('[PowerSync] Retryable upload error...')` -> `debugWarn('PowerSync', 'Retryable upload error:', error)`
   - Line 95: `console.error('[PowerSync] Unexpected table...')` -> `debugError('PowerSync', 'Unexpected table in CRUD operation:', table)`
   - Line 104: `console.log('[PowerSync] Upserting to...')` -> **DELETE entirely** (HIGH sensitivity -- logs full row data)
   - Line 106: `console.log('[PowerSync] Upsert response...')` -> **DELETE entirely** (HIGH sensitivity -- logs response data)
   - Add import: `import { debugError, debugWarn } from './debugLog';`

   **src/lib/powersync.ts:**
   - Line 27: `console.log('[PowerSync] Status changed...')` -> `debugLog('PowerSync', 'Status changed:', { ... })`
   - Line 37: `console.log('[PowerSync] Initial status...')` -> `debugLog('PowerSync', 'Initial status:', { ... })`
   - Add import: `import { debugLog } from './debugLog';`

   **src/lib/AuthProvider.tsx:**
   - Line 69: `console.error('Failed to fetch onboarding status:', error)` -> `debugError('Auth', 'Failed to fetch onboarding status:', error)`
   - Line 83: `console.error('Error fetching onboarding status:', err)` -> `debugError('Auth', 'Error fetching onboarding status:', err)`
   - Line 180: `console.error('Failed to get initial session:', error)` -> `debugError('Auth', 'Failed to get initial session:', error)`
   - Line 252: `console.error('Sign out error:', error)` -> **KEEP as `console.error`** (sign-out errors are rare and actionable, always visible)
   - Line 259: `console.error('Failed to clear PowerSync:', error)` -> **KEEP as `console.error`** (same reasoning)
   - Add import: `import { debugError } from './debugLog';`

   **src/pages/DashboardPage.tsx:**
   - Line 73: `console.error('Cannot save well: missing farmId or user')` -> `debugError('Dashboard', 'Cannot save well: missing farmId or user')`
   - Line 114: `console.error('Failed to save well:', error)` -> `debugError('Dashboard', 'Failed to save well:', error)`
   - Add import: `import { debugError } from '../lib/debugLog';`

   **src/components/MapView.tsx:**
   - Line 96: `console.warn('Map error:', event.error)` -> `debugWarn('Map', 'Map error:', event.error)`
   - Add import: `import { debugWarn } from '../lib/debugLog';`

   **src/components/AddUserModal.tsx:**
   - Line 86: `console.error('SMS send failed:', smsError)` -> `debugError('Invite', 'SMS send failed:', smsError)`
   - Line 90: `console.error('Failed to send invite SMS:', smsErr)` -> `debugError('Invite', 'Failed to send invite SMS:', smsErr)`
   - Add import: `import { debugError } from '../lib/debugLog';`

   **src/hooks/useGeolocation.ts:**
   - Line 105: `console.warn('[useGeolocation] Geolocation API not available')` -> `debugWarn('Geolocation', 'Geolocation API not available')`
   - Line 141: `console.warn('[useGeolocation] Error:', { ... })` -> `debugWarn('Geolocation', 'Error:', { ... })`
   - Add import: `import { debugWarn } from '../lib/debugLog';`

Note: The two `console.error` calls in signOut (AuthProvider lines 252, 259) are intentionally kept as-is because sign-out failures are rare, actionable, and not sensitive.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Grep for `console.log` in src/ -- should find ZERO matches. Grep for `console.warn` in src/ -- should find ZERO matches. Grep for `console.error` in src/ -- should find only the 2 intentionally kept instances in AuthProvider.tsx signOut method. Grep for `debugLog\|debugWarn\|debugError` to confirm all replacements were made.</verify>
  <done>debugLog utility created with localStorage gate. All 19 console statements addressed: 15 replaced with debugLog/debugWarn/debugError, 2 HIGH-sensitivity ones deleted entirely, 2 kept as console.error (signOut). No sensitive data logged in production. Debug mode activatable via localStorage.__ag_debug = 'true'.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Migration file `020_security_definer_private_schema.sql` exists with all 8 functions moved
3. Grep for `SECURITY DEFINER` in migration -- should only appear inside private schema function definitions
4. Grep for `SECURITY INVOKER` in migration -- should appear in all public wrapper functions
5. Grep for `console.log` in src/ -- ZERO matches
6. Grep for `console.warn` in src/ -- ZERO matches
7. Grep for `console.error` in src/ -- exactly 2 matches (signOut in AuthProvider.tsx)
8. `src/lib/debugLog.ts` exists and exports `debugLog`, `debugWarn`, `debugError`
</verification>

<success_criteria>
- All SECURITY DEFINER functions are in private schema, callable only through SECURITY INVOKER wrappers
- Public API contract unchanged -- `supabase.rpc('get_onboarding_status')` still works
- No sensitive data logged to console in production (no console.log, no console.warn)
- Hidden debug mode enables verbose logging when `localStorage.__ag_debug = 'true'`
- generate_random_code has no public API exposure
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-stability/01-03-SUMMARY.md`
</output>
