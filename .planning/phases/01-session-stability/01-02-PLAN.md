---
phase: 01-session-stability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ErrorFallback.tsx
  - src/components/AppLayout.tsx
  - src/pages/DashboardPage.tsx
autonomous: true

must_haves:
  truths:
    - "When a component crashes (map WebGL error, PowerSync query failure, unexpected null), user sees a 'Something went wrong' screen with a retry button"
    - "The error screen is friendly -- icon + text, no technical details, approachable language"
    - "Error boundaries do not catch auth errors -- those still redirect to login"
    - "MapView crashes are caught independently from the rest of the dashboard"
  artifacts:
    - path: "src/components/ErrorFallback.tsx"
      provides: "Reusable error fallback component with icon + friendly message + retry button"
      contains: "Something went wrong"
    - path: "src/components/AppLayout.tsx"
      provides: "Route-level ErrorBoundary wrapping PowerSyncProvider and content"
      contains: "ErrorBoundary"
    - path: "src/pages/DashboardPage.tsx"
      provides: "MapView-specific ErrorBoundary wrapping the MapView component"
      contains: "ErrorBoundary"
  key_links:
    - from: "src/components/AppLayout.tsx"
      to: "src/components/ErrorFallback.tsx"
      via: "ErrorBoundary FallbackComponent prop"
      pattern: "FallbackComponent.*ErrorFallback"
    - from: "src/pages/DashboardPage.tsx"
      to: "src/components/ErrorFallback.tsx"
      via: "ErrorBoundary FallbackComponent prop for MapView"
      pattern: "ErrorBoundary.*MapView"
---

<objective>
Add error boundaries to catch component crashes and show a friendly recovery screen instead of a blank white page. Two boundaries: route-level (catches all protected app crashes) and MapView-specific (catches map WebGL/tile errors independently).

Purpose: AUTH-03 (error boundaries catch component crashes). Currently, any unhandled exception in the React tree produces a blank white page with no recovery path. This is especially problematic with MapView which can crash from WebGL context loss or tile fetch failures.

Output: `react-error-boundary` installed, reusable `ErrorFallback` component created, two error boundaries placed in the component tree.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-session-stability/01-RESEARCH.md

@src/components/AppLayout.tsx
@src/pages/DashboardPage.tsx
@src/components/MapView.tsx
@src/lib/PowerSyncContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-error-boundary and create ErrorFallback component</name>
  <files>src/components/ErrorFallback.tsx</files>
  <action>
1. Install react-error-boundary:
   ```bash
   npm install react-error-boundary
   ```

2. Create `src/components/ErrorFallback.tsx` with the following:

   - Import `ExclamationTriangleIcon` from `@heroicons/react/24/outline` and `ArrowPathIcon` from `@heroicons/react/24/outline`
   - Export a named function `ErrorFallback` that accepts `{ error, resetErrorBoundary }` props (typed using `FallbackProps` from `react-error-boundary`)
   - Render a centered container (`flex flex-col items-center justify-center min-h-[50vh] p-6`)
   - Show `ExclamationTriangleIcon` in gray-400, 12x12 size, with `mb-4`
   - Show "Something went wrong" as `text-lg font-medium text-white mb-2`
   - Show "Tap to try again." as `text-gray-400 text-sm mb-6`
   - Show a retry button with `ArrowPathIcon` + "Try Again" text:
     - Styling: `flex items-center gap-2 px-5 py-3 bg-primary rounded-lg text-white font-medium`
     - `onClick` calls `resetErrorBoundary`
   - Include `role="alert"` on the outer container for accessibility
   - Do NOT show `error.message` or any technical details (user decision: no technical details)

   Also export a compact variant `MapErrorFallback` for use inside the map area:
   - Same icon + message but more compact: `min-h-[30vh]` instead of `min-h-[50vh]`
   - Add `bg-gray-900/80 rounded-xl` for visual containment within the map area
   - Same retry button

Both components should be wrapped in `React.memo` per project conventions (frequently re-rendered components).
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify that `react-error-boundary` is in `package.json` dependencies. Verify `ErrorFallback.tsx` exports both `ErrorFallback` and `MapErrorFallback`.</verify>
  <done>react-error-boundary installed. ErrorFallback component created with friendly icon + message + retry button. MapErrorFallback compact variant created for map-specific errors. No technical error details shown.</done>
</task>

<task type="auto">
  <name>Task 2: Add error boundaries to AppLayout and DashboardPage</name>
  <files>src/components/AppLayout.tsx, src/pages/DashboardPage.tsx</files>
  <action>
**AppLayout.tsx** -- Add route-level error boundary:

1. Import `ErrorBoundary` from `react-error-boundary`
2. Import `ErrorFallback` from `./ErrorFallback`
3. Wrap `<PowerSyncProvider>` + `<AppLayoutContent />` inside an `<ErrorBoundary>`:
   ```tsx
   export default function AppLayout() {
     return (
       <ErrorBoundary FallbackComponent={ErrorFallback}>
         <PowerSyncProvider>
           <AppLayoutContent />
         </PowerSyncProvider>
       </ErrorBoundary>
     );
   }
   ```

This catches:
- PowerSync initialization errors that escape the provider's own error handling
- Component crashes in any protected page (DashboardPage, WellListPage, SettingsPage, etc.)
- Unexpected errors during rendering

This does NOT catch (by design):
- Auth errors (ErrorBoundary is BELOW RequireAuth/RequireOnboarded in the tree)
- Errors in auth pages (they're outside AppLayout)

**DashboardPage.tsx** -- Add MapView-specific error boundary:

1. Import `ErrorBoundary` from `react-error-boundary`
2. Import `MapErrorFallback` from `../components/ErrorFallback`
3. Import `useCallback` is already imported -- add a `useCallback` for the `onReset` handler
4. Wrap just the `<MapView ... />` component (around line 126-133) in an `<ErrorBoundary>`:
   ```tsx
   <ErrorBoundary
     FallbackComponent={MapErrorFallback}
     onReset={() => {
       // Force MapView to remount by toggling a key
     }}
   >
     <MapView ... />
   </ErrorBoundary>
   ```

5. Add a `mapKey` state (`useState(0)`) and pass `key={mapKey}` to MapView. In the `onReset` callback, increment `mapKey` to force a remount of MapView (WebGL context recovery requires a new canvas):
   ```tsx
   const [mapKey, setMapKey] = useState(0);
   const handleMapReset = useCallback(() => setMapKey(k => k + 1), []);
   ```
   Then use `onReset={handleMapReset}` on the ErrorBoundary.

This allows the map to crash and recover independently -- the rest of the dashboard (FABs, bottom sheets, sync banner) continues working. The user sees a contained error within the map area, not a full-page error.
  </action>
  <verify>Run `npx tsc -b --noEmit` to confirm no type errors. Verify that AppLayout.tsx imports and uses ErrorBoundary. Verify that DashboardPage.tsx has a separate ErrorBoundary wrapping MapView with MapErrorFallback. Verify that mapKey state exists for MapView remount on recovery.</verify>
  <done>Route-level ErrorBoundary in AppLayout catches all protected page crashes. MapView-specific ErrorBoundary in DashboardPage catches map crashes independently. Both use friendly recovery UI with retry button. Map recovery forces remount via key increment.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. `react-error-boundary` appears in package.json dependencies
3. Grep for "ErrorBoundary" in AppLayout.tsx -- should find wrapper around PowerSyncProvider
4. Grep for "ErrorBoundary" in DashboardPage.tsx -- should find wrapper around MapView
5. Grep for "Something went wrong" in ErrorFallback.tsx -- should find the friendly message
6. ErrorFallback.tsx does NOT contain `error.message` or stack trace rendering
</verification>

<success_criteria>
- When any component inside AppLayout throws, user sees "Something went wrong" + retry button
- When MapView crashes, user sees a contained error in the map area while FABs remain visible
- Retry button resets the error boundary and re-renders the component
- Map retry forces WebGL context recovery via component remount
- No technical error details shown to user
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-stability/01-02-SUMMARY.md`
</output>
