---
phase: 27-query-optimization-navigation-fluidity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useSubscriptionTier.ts
  - src/components/SideMenu.tsx
  - src/pages/DashboardPage.tsx
  - src/pages/WellDetailPage.tsx
  - src/pages/WellListPage.tsx
  - src/pages/WellEditPage.tsx
  - src/pages/WellAllocationsPage.tsx
  - src/pages/SettingsPage.tsx
  - src/pages/NoSubscriptionPage.tsx
  - src/pages/auth/VerifyPage.tsx
  - src/index.css
autonomous: true
requirements:
  - NAV-01
  - NAV-02

must_haves:
  truths:
    - "useSubscriptionTier fires a single SQL JOIN query instead of two sequential queries"
    - "Page transitions show smooth cross-fade via View Transitions API on supported browsers"
    - "Unsupported browsers get instant navigation with no errors or broken UI"
    - "Return shape of useSubscriptionTier is identical — no consumer changes needed"
  artifacts:
    - path: "src/hooks/useSubscriptionTier.ts"
      provides: "Single JOIN query for farm tier lookup"
      contains: "JOIN subscription_tiers"
    - path: "src/index.css"
      provides: "View transition cross-fade duration CSS"
      contains: "view-transition"
  key_links:
    - from: "src/hooks/useSubscriptionTier.ts"
      to: "PowerSync local SQLite"
      via: "single useQuery with JOIN"
      pattern: "JOIN subscription_tiers"
    - from: "src/components/SideMenu.tsx"
      to: "react-router navigate"
      via: "viewTransition: true option"
      pattern: "viewTransition.*true"
---

<objective>
Optimize useSubscriptionTier to a single JOIN query and add View Transitions API cross-fade to all page navigations.

Purpose: Eliminate one round-trip in tier lookup and make page transitions feel polished with a quick cross-fade animation.
Output: Optimized tier hook, view transition CSS, and updated navigate calls across all pages.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/useSubscriptionTier.ts
@src/components/SideMenu.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Single JOIN query for useSubscriptionTier</name>
  <files>src/hooks/useSubscriptionTier.ts</files>
  <action>
Replace the two-step sequential query pattern in useSubscriptionTier with a single JOIN query.

Current pattern (two queries):
1. `SELECT subscription_tier FROM farms WHERE id = ?` → gets tier slug
2. `SELECT * FROM subscription_tiers WHERE id = ?` → gets tier details

New pattern (single JOIN):
```sql
SELECT st.id, st.display_name, st.max_admins, st.max_meter_checkers, st.max_wells
FROM farms f
JOIN subscription_tiers st ON f.subscription_tier = st.id
WHERE f.id = ?
```

Implementation:
- Remove the first `useQuery` call for farms
- Remove the `tierSlug` useMemo
- Remove the second `useQuery` call for subscription_tiers
- Replace with a single `useQuery` using the JOIN SQL above
- Keep the same guard pattern: if no farmId, use `'SELECT NULL WHERE 0'`
- Keep the return type as `SubscriptionTierInfo | null` — identical API
- Remove the `FarmTierRow` interface (no longer needed)
- Keep the `TierRow` interface (still used for the JOIN result)
- Keep the final `useMemo` that maps `TierRow` → `SubscriptionTierInfo`
- Preserve existing caching behavior (PowerSync useQuery handles this)

The return shape MUST stay identical — `{ slug, displayName, maxAdmins, maxMeterCheckers, maxWells }` — so all consumers (DashboardPage, WellListPage, AddUserModal, SubscriptionPage, useSeatUsage) work without changes.
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Verify useSubscriptionTier.ts contains exactly one useQuery call with JOIN</manual>
  </verify>
  <done>useSubscriptionTier fires a single JOIN query. Return type and shape are unchanged. All consumers compile without modification.</done>
</task>

<task type="auto">
  <name>Task 2: View Transitions API cross-fade on all page navigations</name>
  <files>
    src/index.css
    src/components/SideMenu.tsx
    src/pages/DashboardPage.tsx
    src/pages/WellDetailPage.tsx
    src/pages/WellListPage.tsx
    src/pages/WellEditPage.tsx
    src/pages/WellAllocationsPage.tsx
    src/pages/SettingsPage.tsx
    src/pages/NoSubscriptionPage.tsx
    src/pages/auth/VerifyPage.tsx
  </files>
  <action>
Add View Transitions API cross-fade animation to all programmatic navigations. React Router v7 supports this natively via `{ viewTransition: true }` option on `navigate()`.

**CSS (src/index.css):**
Add a `::view-transition-old(root)` and `::view-transition-new(root)` rule setting `animation-duration: 150ms`. This gives all transitions a quick, snappy 150ms cross-fade per user decision. Place this near the end of the file after existing styles.

```css
/* View Transitions API — 150ms cross-fade for page navigations */
::view-transition-old(root),
::view-transition-new(root) {
  animation-duration: 150ms;
}
```

**All navigate() calls:**
Find every `navigate(path)` call across all page and component files and add `{ viewTransition: true }` as the second argument. Specifically:

1. `src/components/SideMenu.tsx` — `handleNav`: `navigate(path, { viewTransition: true })`
   - Also `handleSignOut`: `navigate('/auth/phone', { viewTransition: true })`
2. `src/pages/DashboardPage.tsx` — `handleWellClick`: `navigate(/wells/${id}, { viewTransition: true })`
   - Also `handleWellList`: `navigate('/wells', { viewTransition: true })`
3. `src/pages/WellDetailPage.tsx` — any navigate calls (check for navigate to edit, allocations, back)
4. `src/pages/WellListPage.tsx` — any navigate calls (check for navigate to well detail)
5. `src/pages/WellEditPage.tsx` — any navigate calls (check for navigate back to well detail)
6. `src/pages/WellAllocationsPage.tsx` — any navigate calls (check for navigate back)
7. `src/pages/SettingsPage.tsx` — any navigate calls
8. `src/pages/NoSubscriptionPage.tsx` — any navigate calls
9. `src/pages/auth/VerifyPage.tsx` — any navigate calls (after OTP verification)

For each file, search for all `navigate(` calls and add `{ viewTransition: true }` option. If the navigate call already has an options object (e.g., `{ replace: true }`), merge: `{ replace: true, viewTransition: true }`.

**Do NOT add viewTransition to `<Navigate>` redirect components** — those are React Router component redirects, not user-initiated navigations. Only add to `navigate()` function calls.

**Graceful fallback:** The View Transitions API is only supported in Chromium browsers. React Router v7 automatically checks for `document.startViewTransition` support — if not available, navigation happens instantly with no animation. No polyfill or CSS fallback needed per user decision ("instant swap with no animation").
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Open app in Chrome, navigate between pages via side menu — should see quick 150ms cross-fade. Open in Firefox — should navigate instantly with no errors.</manual>
  </verify>
  <done>All page navigations use View Transitions API. 150ms cross-fade visible in Chrome/Edge. Firefox/Safari fall back to instant swap. No console errors on any browser.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. useSubscriptionTier.ts contains exactly one `useQuery` call with a JOIN
3. All navigate() calls across the codebase include `viewTransition: true`
4. src/index.css contains `::view-transition` animation-duration rule
5. No consumer of useSubscriptionTier was modified (return shape preserved)
</verification>

<success_criteria>
- useSubscriptionTier fires one SQL query (JOIN) instead of two sequential queries
- Page transitions show 150ms cross-fade in Chrome/Edge via View Transitions API
- Unsupported browsers (Firefox/Safari) navigate instantly with no errors
- All existing functionality unchanged — no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/27-query-optimization-navigation-fluidity/27-01-SUMMARY.md`
</output>
