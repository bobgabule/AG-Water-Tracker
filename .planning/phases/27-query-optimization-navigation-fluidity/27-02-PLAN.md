---
phase: 27-query-optimization-navigation-fluidity
plan: 02
type: execute
wave: 2
depends_on:
  - 27-01
files_modified:
  - src/pages/DashboardPage.tsx
  - src/lib/powersync-connector.ts
autonomous: true
requirements:
  - NAV-03

must_haves:
  truths:
    - "New well marker appears on the map immediately after form submission, before sync completes"
    - "Optimistic marker looks identical to a synced well marker — no visual pending indicator"
    - "If sync to Supabase fails permanently, the optimistic marker is removed and a toast error is shown"
    - "Map stays at current view position after well creation — no auto-pan"
    - "Optimistic marker is tappable immediately — user can open well detail"
  artifacts:
    - path: "src/pages/DashboardPage.tsx"
      provides: "Optimistic well creation with error rollback"
      contains: "db.execute"
    - path: "src/lib/powersync-connector.ts"
      provides: "Sync failure notification for well operations"
      contains: "wells"
  key_links:
    - from: "src/pages/DashboardPage.tsx"
      to: "PowerSync local SQLite"
      via: "db.execute INSERT"
      pattern: "INSERT INTO wells"
    - from: "src/lib/powersync-connector.ts"
      to: "src/stores/toastStore.ts"
      via: "import useToastStore for sync failure notification"
      pattern: "toastStore"
---

<objective>
Make well creation feel instant with optimistic UI — the marker appears immediately on the map and handles sync failures gracefully.

Purpose: Remove the perceived delay between form submission and seeing the new well on the map. PowerSync writes locally first (already instant), but sync failures need explicit handling to remove the optimistic entry and notify the user.
Output: Enhanced DashboardPage with optimistic creation flow and connector with sync failure notifications.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-query-optimization-navigation-fluidity/27-01-SUMMARY.md
@src/pages/DashboardPage.tsx
@src/lib/powersync-connector.ts
@src/hooks/useWells.ts
@src/stores/toastStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync failure notification in PowerSync connector</name>
  <files>src/lib/powersync-connector.ts</files>
  <action>
Add sync failure notification to the PowerSync connector so the UI can react when a well creation fails to sync to Supabase.

Currently, when `isPermanentError` returns true, the connector calls `transaction.complete()` which silently discards the failed operation. For well INSERT failures, we need to notify the user.

**Implementation:**

1. Import `useToastStore` from `../stores/toastStore` at the top of the file. Since this is NOT a React component, access the store directly via `useToastStore.getState().show()` (Zustand stores can be accessed outside React).

2. In the `uploadData` method's permanent error catch block, BEFORE calling `transaction.complete()`:
   - Check if any operation in `transaction.crud` is a PUT on the `wells` table
   - If so, show a toast error: `useToastStore.getState().show('Well could not be saved. Please try again.', 'error')`
   - Also, for each failed well PUT operation, delete the optimistic local row by calling `await database.execute('DELETE FROM wells WHERE id = ?', [op.id])`. This removes the optimistic marker from the map.

3. The check should be:
```typescript
if (isPermanentError(error)) {
  // Rollback optimistic well entries and notify user
  for (const op of transaction.crud) {
    if (op.table === 'wells' && op.op === UpdateType.PUT) {
      try {
        await database.execute('DELETE FROM wells WHERE id = ?', [op.id]);
      } catch {
        // Best-effort rollback — ignore if already deleted
      }
      useToastStore.getState().show('Well could not be saved. Please try again.', 'error');
    }
  }
  debugError('PowerSync', 'Permanent upload error, discarding transaction:', error);
  await transaction.complete();
}
```

**Important notes:**
- Only handle wells table specifically — other tables (readings, allocations) keep existing behavior
- The `database` parameter is available in `uploadData` — pass it through for the DELETE
- The DELETE triggers a reactive update in useWells, removing the marker from the map
- Show only one toast even if there are multiple well operations in one transaction (use a flag or break after first)
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Verify powersync-connector.ts handles well PUT failures with local DELETE and toast notification</manual>
  </verify>
  <done>PowerSync connector detects permanent well sync failures, removes the optimistic local row, and shows an error toast to the user.</done>
</task>

<task type="auto">
  <name>Task 2: Optimistic well creation flow in DashboardPage</name>
  <files>src/pages/DashboardPage.tsx</files>
  <action>
The current well creation in DashboardPage already writes to PowerSync local SQLite via `db.execute(INSERT)`, which is already instant and reactive — `useWells` picks up the new row immediately. The marker already appears on the map right after the INSERT.

The key change is to ensure the creation flow feels optimistic:

1. **Close the form immediately after INSERT** — the current code already does this: after `db.execute()`, it sets `currentStep('closed')` and calls `showToast`. No change needed here.

2. **Do NOT await sync** — the current code already does NOT await sync. The `db.execute()` writes to local SQLite only. Sync happens in the background via the connector. No change needed here.

3. **Map stays at current position** — the current code does NOT auto-pan. The MapView `initialViewState` is memoized and only computed once. No change needed here.

4. **Optimistic marker is tappable** — the well gets a real UUID from `crypto.randomUUID()`, and `handleWellClick` navigates to `/wells/${id}`. Since the data is in local PowerSync, the WellDetailPage will find it. No change needed here.

5. **Marker looks identical** — since it's a real PowerSync row with all fields populated, the WellMarker renders it the same as any other well. No change needed here.

**What DOES need to change:**
The `handleSaveWell` error handling currently catches only the local INSERT error. If the local INSERT succeeds (which it almost always will), the sync error is handled by the connector (Task 1 above). However, we should make the success path cleaner:

- Remove the `setSaveError` and `saveError` state entirely — sync failures are now handled by the connector's toast, not by a DashboardPage error banner. This eliminates the red error banner that currently only shows for local INSERT failures (extremely rare edge case).
- Remove the `errorTimeoutRef` and its cleanup effect.
- Remove the save error notification JSX block.
- Simplify the catch block to just show a toast error directly: `showToast('Failed to save well. Please try again.', 'error')` — this covers the rare case where the local INSERT itself fails.
- Add `{ viewTransition: true }` to the navigate calls if not already done in Plan 01 (should be done, but double-check).

This simplification is appropriate because:
- Local INSERT failures are extremely rare (disk full, schema mismatch)
- Remote sync failures are handled by the connector (Task 1)
- The toast system is already the pattern used for success messaging

**Final state of handleSaveWell:**
```typescript
const handleSaveWell = useCallback(async (wellData: WellFormData) => {
  if (!hasPermission(role, 'create_well')) { ... }
  if (isSavingRef.current) return;
  if (!farmId || !user) { ... }

  isSavingRef.current = true;
  setIsSaving(true);

  try {
    await db.execute(`INSERT INTO wells ...`, [...]);
    setCurrentStep('closed');
    setPickedLocation(null);
    showToast(`"${wellData.name}" added successfully`);
  } catch (error) {
    debugError('Dashboard', 'Failed to save well:', error);
    showToast('Failed to save well. Please try again.', 'error');
  } finally {
    isSavingRef.current = false;
    setIsSaving(false);
  }
}, [db, farmId, role, user, showToast]);
```
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Create a new well on the map — marker should appear immediately. Check that no red error banner UI remains.</manual>
  </verify>
  <done>Well creation feels instant — marker appears on map immediately after form submit. Sync failure triggers toast error and removes marker. No unused error banner state remains in DashboardPage.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Creating a well shows the marker on the map immediately (before sync)
3. PowerSync connector handles well sync failures by removing local row and showing toast
4. DashboardPage no longer has the `saveError` state or error banner JSX
5. Optimistic well marker is tappable and navigates to well detail page
</verification>

<success_criteria>
- New well marker appears on map immediately after form submission
- Marker looks identical to any synced well (no pulsing, no transparency)
- Sync failure removes the marker and shows a toast error
- Map stays at current view position after creation
- Well detail page is accessible immediately via tap on optimistic marker
</success_criteria>

<output>
After completion, create `.planning/phases/27-query-optimization-navigation-fluidity/27-02-SUMMARY.md`
</output>
