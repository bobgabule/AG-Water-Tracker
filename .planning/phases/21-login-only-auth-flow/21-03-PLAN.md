---
phase: 21-login-only-auth-flow
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/035_fix_onboarding_status_wrapper.sql
  - src/pages/NoSubscriptionPage.tsx
  - src/lib/AuthProvider.tsx
autonomous: true
gap_closure: true
requirements: [AUTH-04, AUTH-05, AUTH-06]

must_haves:
  truths:
    - "Invite auto-join works on login: user with pending invite joins farm, invite deleted, lands on dashboard"
    - "Auto-redirect from /no-subscription to dashboard when user gets added to a farm"
    - "Sign out from NoSubscriptionPage completes quickly"
  artifacts:
    - path: "supabase/migrations/035_fix_onboarding_status_wrapper.sql"
      provides: "Public wrapper delegating to updated private impl with invite auto-join logic"
      contains: "get_onboarding_status_impl"
    - path: "src/pages/NoSubscriptionPage.tsx"
      provides: "Tab-focus re-check without premature navigation"
    - path: "src/lib/AuthProvider.tsx"
      provides: "Fast sign out with timeout on disconnectAndClear"
  key_links:
    - from: "supabase/migrations/035_fix_onboarding_status_wrapper.sql"
      to: "private.get_onboarding_status_impl()"
      via: "SQL delegation wrapper"
      pattern: "SELECT private\\.get_onboarding_status_impl"
    - from: "src/pages/NoSubscriptionPage.tsx"
      to: "src/lib/AuthProvider.tsx"
      via: "refreshAuthStatus + authStatus effect"
      pattern: "refreshAuthStatus"
    - from: "src/lib/AuthProvider.tsx"
      to: "src/lib/powersync.ts"
      via: "disconnectAndClear with timeout"
      pattern: "disconnectAndClear"
---

<objective>
Fix three UAT failures from Phase 21: invite auto-join blocker (broken RPC wrapper), auto-redirect stuck on /no-subscription (race condition), and slow sign-out (PowerSync disconnect without timeout).

Purpose: Close all diagnosed gaps so Phase 21 passes UAT.
Output: One new migration, two updated source files.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-login-only-auth-flow/21-01-SUMMARY.md
@.planning/phases/21-login-only-auth-flow/21-02-SUMMARY.md
@.planning/phases/21-login-only-auth-flow/21-UAT.md
@supabase/migrations/034_login_only_auto_join.sql
@supabase/migrations/023_fix_wrapper_security_definer.sql
@src/pages/NoSubscriptionPage.tsx
@src/lib/AuthProvider.tsx
@src/components/RequireOnboarded.tsx
@src/lib/powersync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix invite auto-join RPC and auto-redirect race condition</name>
  <files>
    supabase/migrations/035_fix_onboarding_status_wrapper.sql
    src/pages/NoSubscriptionPage.tsx
  </files>
  <action>
**Migration 035 (BLOCKER fix -- Test 7):**

Create `supabase/migrations/035_fix_onboarding_status_wrapper.sql` that recreates the public wrapper function to ensure it delegates to the updated private impl from migration 034.

The public wrapper was last created in migration 023 as:
```sql
CREATE OR REPLACE FUNCTION public.get_onboarding_status()
RETURNS JSON
LANGUAGE sql
SECURITY DEFINER
SET search_path = ''
AS $$
    SELECT private.get_onboarding_status_impl();
$$;
```

Migration 035 must:
1. `CREATE OR REPLACE FUNCTION public.get_onboarding_status()` -- same signature, same `SECURITY DEFINER`, same `SET search_path = ''`, same `LANGUAGE sql`, delegating to `private.get_onboarding_status_impl()`
2. `GRANT EXECUTE ON FUNCTION public.get_onboarding_status() TO authenticated, anon, public;`
3. `NOTIFY pgrst, 'reload schema';`

This ensures the RPC endpoint picks up the private impl that has invite auto-matching + delete logic from migration 034.

Add a clear header comment explaining this is a fix for the public wrapper not being recreated in migration 034, causing the RPC to still use the old migration 016 function body.

**NoSubscriptionPage.tsx (MAJOR fix -- Test 5):**

The current `visibilitychange` handler calls `navigate('/', { replace: true })` directly after `refreshAuthStatus()` returns. This navigates BEFORE React state propagates through context. `RequireOnboarded` then sees stale `authStatus` (no farm membership) and redirects back to `/no-subscription`, creating a loop.

Fix: Remove the `navigate` call from the `visibilitychange` handler. Only call `refreshAuthStatus()` to update the context state. The existing `useEffect` on line 55-59 already watches `authStatus?.hasFarmMembership` and navigates when it becomes true. This is the correct place for navigation because it runs AFTER React state has propagated.

The updated `visibilitychange` handler should be:
```typescript
const handleVisibilityChange = async () => {
  if (document.visibilityState === 'visible') {
    await refreshAuthStatus();
  }
};
```

Remove `navigate` from the dependency array of this effect since it's no longer used there. Keep `refreshAuthStatus` in the dependency array.
  </action>
  <verify>
1. `npx tsc -b --noEmit` -- zero type errors
2. Verify migration 035 contains `CREATE OR REPLACE FUNCTION public.get_onboarding_status()` delegating to `private.get_onboarding_status_impl()`
3. Verify NoSubscriptionPage visibilitychange handler calls only `refreshAuthStatus()` with NO navigate call
4. Verify the existing `authStatus?.hasFarmMembership` effect still handles navigation to `/`
  </verify>
  <done>
Migration 035 exists with public wrapper recreation + grants + schema reload. NoSubscriptionPage visibilitychange handler only refreshes auth state; navigation deferred to the authStatus effect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Speed up sign-out with PowerSync disconnect timeout</name>
  <files>src/lib/AuthProvider.tsx</files>
  <action>
**AuthProvider.tsx signOut() (MINOR fix -- Test 4):**

The current `signOut()` function (lines 446-480) sequentially awaits `disconnectAndClear()` with no timeout. When called from NoSubscriptionPage (which is outside the PowerSync provider), the PowerSync instance may be null/uninitialized, but even then the await can hang on an unresponsive instance.

Fix: Wrap the `disconnectAndClear()` call in a `Promise.race` with a 2-second timeout. If PowerSync doesn't disconnect within 2 seconds, proceed with the rest of sign-out cleanup anyway.

Replace the current PowerSync cleanup block (lines 457-461):
```typescript
// Clear PowerSync local database
try {
  await disconnectAndClear();
} catch (error) {
  debugError('Auth', 'Failed to clear PowerSync:', error);
}
```

With a timeout-guarded version:
```typescript
// Clear PowerSync local database (timeout prevents hanging on uninitialized instance)
try {
  await Promise.race([
    disconnectAndClear(),
    new Promise<void>((resolve) => setTimeout(resolve, 2000)),
  ]);
} catch (error) {
  debugError('Auth', 'Failed to clear PowerSync:', error);
}
```

This ensures sign-out completes in at most ~2 seconds even if PowerSync is stuck or not initialized. The `disconnectAndClear()` function in `powersync.ts` already handles the null case (returns immediately if `powerSyncInstance` is null), so the timeout is a safety net for cases where the instance exists but is unresponsive.

Do NOT change any other part of the signOut function. The Supabase sign-out, active farm store clear, localStorage clear, and state resets must remain unchanged.
  </action>
  <verify>
1. `npx tsc -b --noEmit` -- zero type errors
2. Verify `signOut()` in AuthProvider.tsx contains `Promise.race` around `disconnectAndClear()` with a 2000ms timeout
3. Verify all other signOut logic (supabase.auth.signOut, clearOverride, localStorage, state setters) is unchanged
  </verify>
  <done>
signOut() wraps disconnectAndClear() in a 2-second Promise.race timeout, ensuring fast sign-out even when PowerSync is unresponsive or not initialized.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Migration 035 file exists with correct public wrapper recreation
3. NoSubscriptionPage has no `navigate` call inside visibilitychange handler
4. AuthProvider signOut has timeout-guarded disconnectAndClear
5. No dead imports or unused variables introduced
</verification>

<success_criteria>
- Invite auto-join blocker resolved: public RPC wrapper delegates to updated private impl with invite matching/deletion logic
- Auto-redirect race condition resolved: visibilitychange only refreshes state, navigation handled by React effect after state propagation
- Sign-out speed improved: PowerSync disconnect cannot block sign-out for more than 2 seconds
- All three UAT test failures (Tests 4, 5, 7) have targeted fixes
- TypeScript compilation passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-login-only-auth-flow/21-03-SUMMARY.md`
</output>
