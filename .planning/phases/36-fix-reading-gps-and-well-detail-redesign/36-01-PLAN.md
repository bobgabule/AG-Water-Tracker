---
phase: 36-fix-reading-gps-and-well-detail-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/NewReadingSheet.tsx
  - src/components/WellDetailSheet.tsx
  - src/components/WellUsageGauge.tsx
  - src/components/WellReadingsList.tsx
  - src/components/WellDetailHeader.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "GPS capture uses 10s timeout and maximumAge:60000 to reuse cached positions"
    - "isSimilar flag is preserved when GPS fails or user is out-of-range via pendingSimilar state"
    - "Well Detail page body is green (bg-surface-dark) everywhere including behind readings"
    - "Readings list text is white on green with alternating darker row backgrounds"
    - "Out-of-range flags are yellow (not orange)"
    - "Empty readings shows 'No available readings' in white text"
    - "Gauge labels are unit-aware (Gallons/Cubic Feet/AF based on well.units)"
    - "Last Updated timestamp shows below well name in header"
    - "New Reading button uses bg-btn-confirm text-btn-confirm-text"
    - "Readings save offline via PowerSync and GPS works from hardware/cache"
  artifacts:
    - path: "src/components/NewReadingSheet.tsx"
      provides: "Fixed GPS capture and isSimilar flag"
      contains: "maximumAge: 60000"
    - path: "src/components/WellDetailSheet.tsx"
      provides: "Green body, lastReadingDate prop"
      contains: "bg-surface-dark"
    - path: "src/components/WellUsageGauge.tsx"
      provides: "Unit-aware labels"
      contains: "unitLabel"
    - path: "src/components/WellReadingsList.tsx"
      provides: "Green-themed readings list with alternating rows"
      contains: "text-white"
    - path: "src/components/WellDetailHeader.tsx"
      provides: "Last Updated timestamp"
      contains: "lastReadingDate"
---

<objective>
Fix GPS capture bug in new reading flow and redesign the Well Detail page to match the green-body design with white text, alternating row backgrounds, unit-aware gauge labels, and a "Last Updated" timestamp.

Purpose: GPS always fails when adding readings (5s timeout too short, no cache reuse). The Well Detail page needs visual consistency — green body everywhere, white text, yellow flags, and unit-aware labels.

Output: Readings save with GPS, gauge updates reactively, and the page matches the screenshot design.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/NewReadingSheet.tsx
@src/components/WellDetailSheet.tsx
@src/components/WellUsageGauge.tsx
@src/components/WellReadingsList.tsx
@src/components/WellDetailHeader.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GPS capture and isSimilar flag in NewReadingSheet</name>
  <files>src/components/NewReadingSheet.tsx</files>
  <action>
**Fix 1 — GPS capture options (line 74):**
Change `captureGps()` options from:
```
{ enableHighAccuracy: true, timeout: 5000 }
```
to:
```
{ enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
```
- `timeout: 10000` matches AddWellFormBottomSheet, LocationPickerBottomSheet, WellEditPage
- `maximumAge: 60000` reuses cached position from dashboard geolocation (instant instead of fresh satellite fix)
- Works offline: GPS uses hardware satellites, maximumAge accepts recent cache

**Fix 2 — Preserve isSimilar flag across view transitions:**

Bug: When reading is similar AND GPS fails or user is out-of-range, `isSimilar=true` passed to `handleGpsCaptureAndSave(true)` is lost because `handleSaveWithoutGps` and `handleRangeContinue` don't forward it to `saveReading()`.

1. Add state after line 96 (`problemsSubmitting`):
   ```typescript
   const [pendingSimilar, setPendingSimilar] = useState(false);
   ```

2. In `resetForm` callback (line 108-116), add:
   ```typescript
   setPendingSimilar(false);
   ```

3. In `handleGpsCaptureAndSave` (line 176), add at the start:
   ```typescript
   setPendingSimilar(isSimilar);
   ```

4. Change `handleSaveWithoutGps` (line 205-207) to:
   ```typescript
   const handleSaveWithoutGps = useCallback(() => {
     saveReading(null, false, pendingSimilar);
   }, [saveReading, pendingSimilar]);
   ```

5. Change `handleRangeContinue` (line 241-243) to:
   ```typescript
   const handleRangeContinue = useCallback(() => {
     saveReading(gpsResult, true, pendingSimilar);
   }, [saveReading, gpsResult, pendingSimilar]);
   ```
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>Search for "maximumAge" in NewReadingSheet.tsx, verify pendingSimilar state exists</manual>
  </verify>
  <done>GPS uses 10s timeout + 60s cache. isSimilar flag preserved via pendingSimilar state through gps-failed and range-warning views.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign Well Detail page — green body, readings styling, gauge labels, last updated</name>
  <files>src/components/WellDetailSheet.tsx, src/components/WellUsageGauge.tsx, src/components/WellReadingsList.tsx, src/components/WellDetailHeader.tsx</files>
  <action>
**WellDetailSheet.tsx — Green body + New Reading button + lastReadingDate:**

1. Line 93: Change `bg-white` to `bg-surface-dark` on the page container
2. Line 125: Change bottom button bar from `bg-white border-t border-gray-100` to `bg-surface-dark`
3. Line 129: Change "New Reading" button from `bg-btn-action text-white` to `bg-btn-confirm text-btn-confirm-text`
4. Add `lastReadingDate` derived from readings:
   ```typescript
   const lastReadingDate = readings.length > 0 ? readings[0].recordedAt : null;
   ```
5. Pass `lastReadingDate` as prop to `WellDetailHeader`

**WellDetailHeader.tsx — Last Updated timestamp:**

1. Add `lastReadingDate?: string | null` to props interface
2. Below the well name (line 96-97 area), inside the bottom bar div, add centered "Last Updated" text:
   ```tsx
   {lastReadingDate && (
     <p className="text-white/50 text-xs text-center mt-1">
       Last Updated {formatRelativeDate(lastReadingDate)}
     </p>
   )}
   ```
3. Add a `formatRelativeDate` helper at the top of the file:
   - Today → "Today at 4:03 PM"
   - Yesterday → "Yesterday at 4:03 PM"
   - Else → "Jun 15 at 4:03 PM"
4. Move the "Last Updated" text to be below the left well name section but spanning full width (outside the flex justify-between) so it appears centered below both name and proximity indicator.

**WellUsageGauge.tsx — Unit-aware labels:**

1. Add `unitLabel: string` to the props interface
2. Add unit display name mapping:
   ```typescript
   function getUnitDisplayName(unit: string): string {
     switch (unit) {
       case 'GAL': return 'Gallons';
       case 'CF': return 'Cubic Feet';
       case 'AF': return 'AF';
       default: return unit;
     }
   }
   ```
3. Replace "AF Allocated" → `{unitDisplayName} Allocated` (line 82)
4. Replace "AF Used" → `{unitDisplayName} Used` (line 88)
5. Replace "AF Left" → `{unitDisplayName} Left` (line 91-93)
6. Update WellDetailSheet.tsx to pass `unitLabel={well.units}` to WellUsageGauge

**WellReadingsList.tsx — Green body styling:**

All text → white/light. No white card. Alternating row backgrounds.

1. Line 35 — "READINGS" header: `text-gray-900` → `text-white`
2. Line 39 — empty state icon: `text-gray-300` → `text-white/30`
3. Line 40 — empty state text: `text-gray-400` → `text-white/60`, change text to "No available readings"
4. Line 45 — column headers: `text-gray-400` → `text-white/50`, `border-gray-200` → `border-white/10`
5. Line 52 — remove `divide-y divide-gray-100` (alternating bg replaces dividers)
6. Add `index` parameter to `readings.map((reading, index) => ...)`:
   - Apply alternating bg: `index % 2 === 0 ? 'bg-white/5' : ''` to the row className
7. Line 70 — active press state: `active:bg-gray-50` → `active:bg-white/10`
8. Line 79 — date text: `text-gray-900` → `text-white`
9. Line 80 — value text: `text-gray-900` → `text-white`
10. Line 84 — user/time text: `text-gray-600` → `text-white/60`
11. Line 89 — out-of-range flag: `text-orange-400` → `text-yellow-400`

After all changes, run the code-reviewer agent on all 4 modified component files.
  </action>
  <verify>
    <automated>npx tsc -b --noEmit</automated>
    <manual>
1. Well Detail page has green bg everywhere (no white sections)
2. Readings rows alternate with slightly darker green
3. All text is white/light
4. Out-of-range flags are yellow
5. Empty state shows "No available readings" in white
6. Gauge shows unit-appropriate labels (Gallons/CF/AF)
7. "Last Updated" appears below well name
8. "New Reading" button is light teal
    </manual>
  </verify>
  <done>Well Detail page fully redesigned — green body, white text readings with alternating rows, yellow flags, unit-aware gauge labels, Last Updated timestamp, light teal New Reading button. Empty state shows "No available readings" in white.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Add reading → GPS captures successfully (no "GPS Unavailable" screen)
3. Similar reading → warning → Continue → saves with `is_similar_reading = 1`
4. Out of range → warning → Continue allowed
5. After save, gauge updates (Allocated/Used/Left + fill %)
6. "Last Updated" shows correct relative time
7. Gauge labels show well's unit type (Gallons/CF/AF)
8. Page has green body everywhere (including readings section)
9. Readings rows alternate with darker green on even rows
10. All readings text is white/light
11. Out-of-range flags are yellow
12. Empty readings shows "No available readings" in white
13. "New Reading" button is light teal (#b6e5d1) with dark text (#3b6454)
14. Offline: readings save locally, GPS works from cache/hardware
</verification>

<success_criteria>
- GPS capture uses 10s timeout with 60s maximumAge — no more "GPS Unavailable" for normal use
- isSimilar flag preserved through gps-failed and range-warning view transitions
- Well Detail page body is bg-surface-dark everywhere
- Readings text is white on green with alternating bg-white/5 rows
- Out-of-range PlayIcon flags are text-yellow-400
- Empty state: "No available readings" in text-white/60
- WellUsageGauge labels match well.units (Gallons/Cubic Feet/AF)
- "Last Updated" timestamp shows relative time below well name
- "New Reading" button uses bg-btn-confirm text-btn-confirm-text
- Readings save offline via PowerSync, GPS works from hardware/cache
- `npx tsc -b --noEmit` passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/36-fix-reading-gps-and-well-detail-redesign/36-01-SUMMARY.md`
</output>
