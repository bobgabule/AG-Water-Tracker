---
phase: 18-tier-sync-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useAppSetting.ts
  - src/components/AddUserModal.tsx
  - docs/powersync-sync-rules.yaml
autonomous: false
requirements: [TIER-04]

must_haves:
  truths:
    - "subscription_tiers and app_settings data syncs from Supabase to PowerSync local SQLite for all authenticated users"
    - "useAppSetting('subscription_website_url') returns the stored value (or null when not yet synced)"
    - "AddUserModal disables the Send Invite button with 'Loading plan limits...' message when tier data has not synced yet"
  artifacts:
    - path: "src/hooks/useAppSetting.ts"
      provides: "Generic app settings key-value lookup hook"
      exports: ["useAppSetting"]
    - path: "src/components/AddUserModal.tsx"
      provides: "Loading state when tier data is null"
      contains: "Loading plan limits"
  key_links:
    - from: "src/hooks/useAppSetting.ts"
      to: "app_settings PowerSync table"
      via: "useQuery SELECT from app_settings WHERE id = ?"
      pattern: "useQuery.*app_settings.*WHERE id"
    - from: "src/components/AddUserModal.tsx"
      to: "src/hooks/useSubscriptionTier.ts"
      via: "useSubscriptionTier() null check for loading state"
      pattern: "useSubscriptionTier"
---

<objective>
Deploy PowerSync global bucket sync rules for subscription_tiers and app_settings tables, create a generic useAppSetting() hook for reading config values, and add tier-loading state to AddUserModal.

Purpose: Makes subscription tier data available offline via PowerSync and establishes the app settings access pattern. The loading state in AddUserModal prevents invites from being sent before tier limits are known.

Output: Deployed sync rules, useAppSetting hook, and AddUserModal with loading guard.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-tier-sync-hooks/18-RESEARCH.md
@.planning/phases/17-subscription-database-foundation/17-01-SUMMARY.md
@src/hooks/useSubscriptionTier.ts
@src/hooks/useSeatUsage.ts
@src/lib/powersync-schema.ts
@src/components/AddUserModal.tsx
@docs/powersync-sync-rules.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAppSetting hook and add loading state to AddUserModal</name>
  <files>src/hooks/useAppSetting.ts, src/components/AddUserModal.tsx</files>
  <action>
**1. Create `src/hooks/useAppSetting.ts`:**

Create a generic hook for reading app settings from the PowerSync-synced `app_settings` table.

```typescript
import { useMemo } from 'react';
import { useQuery } from '@powersync/react';

interface AppSettingRow {
  id: string;   // key mapped to id via sync rules (SELECT key AS id)
  value: string;
}

/**
 * Returns a single app setting value by key.
 * Returns `defaultValue` (default: null) when the key is not found or not yet synced.
 *
 * The app_settings table uses `key` as PK in Supabase, mapped to `id` in PowerSync
 * via sync rules (SELECT key AS id). Always query by `id` column client-side.
 */
export function useAppSetting(key: string, defaultValue: string | null = null): string | null {
  const { data } = useQuery<AppSettingRow>(
    `SELECT id, value FROM app_settings WHERE id = ?`,
    [key]
  );

  return useMemo(
    () => (data.length > 0 ? data[0].value : defaultValue),
    [data, defaultValue]
  );
}
```

Key decisions:
- Generic `useAppSetting(key, defaultValue?)` pattern (not specific hooks per setting) -- extensible without code changes when new settings added via DB
- Returns `string | null` -- all values treated as strings per user decision
- Uses `id` column (not `key`) because PowerSync maps `key AS id` in sync rules
- Memoizes result per CLAUDE.md convention

**2. Modify `src/components/AddUserModal.tsx`:**

Add a loading state when tier data (via `useSubscriptionTier()`) is null. Per user decision: disable invite button while tier data is loading with "Loading plan limits..." message.

Changes:
- Import `useSubscriptionTier` from `'../hooks/useSubscriptionTier'`
- Call `const tier = useSubscriptionTier();` at the top of the component (alongside existing `useSeatUsage()`)
- Add a loading state in the body section (before the `allSeatsFull` check): when `!tier`, show a centered loading message with a small spinner and "Loading plan limits..." text
- The Send Invite button's `disabled` prop already handles `!onboardingStatus?.farmId` -- add `|| !tier` to also disable when tier data hasn't loaded
- The loading state should replace the form content (not show alongside it) -- same pattern as `allSeatsFull` block but with spinner instead

Specifically, in the body section's conditional rendering:
- Before `allSeatsFull ? (...)` add: `!tier ? (loading state) : allSeatsFull ? (...)`
- Loading state UI: centered div with a small spinning circle and "Loading plan limits..." text in white, matching the existing allSeatsFull styling
- Also add `|| !tier` to the Send Invite button's disabled condition as a safety guard

Do NOT modify the existing `useSeatUsage()` call or its behavior -- it already handles tier=null gracefully (returns 0 limits).
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- no type errors.
Verify `useAppSetting.ts` exports the `useAppSetting` function.
Verify `AddUserModal.tsx` imports `useSubscriptionTier` and shows loading state when tier is null.
  </verify>
  <done>
`useAppSetting` hook exists and compiles. AddUserModal shows "Loading plan limits..." message and disables Send Invite button when tier data is null.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deploy sync rules to PowerSync dashboard</name>
  <files>docs/powersync-sync-rules.yaml</files>
  <action>
Human deploys the global bucket sync rules for `subscription_tiers` and `app_settings` to the PowerSync dashboard.

**What was built:** The PowerSync schema already defines `subscription_tiers` and `app_settings` tables (from Phase 17 groundwork). The sync rules YAML documentation at `docs/powersync-sync-rules.yaml` contains the global bucket definitions. These sync rules need to be deployed to the PowerSync dashboard so data actually syncs to clients.
  </action>
  <verify>
1. Open the PowerSync dashboard for your project
2. Navigate to the Sync Rules section
3. Copy the TWO new global bucket definitions from `docs/powersync-sync-rules.yaml`:
   - `subscription_tiers_global` bucket (lines 24-27)
   - `app_settings_global` bucket (lines 36-39)
4. Add them to your existing sync rules configuration
5. Deploy the updated sync rules
6. Verify deployment:
   - Open the app in a browser
   - Check browser DevTools console for sync activity
   - The `subscription_tiers` and `app_settings` tables should now contain data in the local SQLite database
   - The Subscription page should show tier name and seat counts (no longer showing skeleton indefinitely)

Type "deployed" when sync rules are live and data appears in the app, or describe any issues.
  </verify>
  <done>
PowerSync global bucket sync rules are deployed and subscription_tiers + app_settings data syncs to all authenticated clients. Subscription page shows real tier data instead of skeleton.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. `useAppSetting` hook returns correct type signature (`string | null`)
3. AddUserModal shows loading state when tier data is null
4. Sync rules deployed to PowerSync dashboard (confirmed via checkpoint)
5. Subscription tier data and app settings appear in local SQLite after sync
</verification>

<success_criteria>
- useAppSetting hook exists and can query any key from app_settings table
- AddUserModal blocks invite submission while tier data is loading
- PowerSync global bucket sync rules are deployed and subscription_tiers + app_settings data syncs to all authenticated clients
</success_criteria>

<output>
After completion, create `.planning/phases/18-tier-sync-hooks/18-01-SUMMARY.md`
</output>
