---
phase: 18-tier-sync-hooks
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - src/pages/SubscriptionPage.tsx
autonomous: true
requirements: [TIER-05]

must_haves:
  truths:
    - "Subscription page displays well count vs tier well limit (e.g., '3 / 10 Wells')"
    - "Red 'Full' badge appears next to well count when farm is at well limit"
    - "'Manage Plan' button appears on Subscription page when subscription_website_url is set and non-empty"
    - "'Manage Plan' button opens external URL with ?farm_id= parameter in device browser"
    - "'Manage Plan' button is hidden when subscription_website_url is empty or not set"
    - "Well count and Manage Plan button show skeleton loading state while tier data is null"
  artifacts:
    - path: "src/pages/SubscriptionPage.tsx"
      provides: "Well count display, Manage Plan external link, and tier-aware loading states"
      contains: ["Manage Plan", "ArrowTopRightOnSquareIcon", "Wells", "Full"]
  key_links:
    - from: "src/pages/SubscriptionPage.tsx"
      to: "src/hooks/useAppSetting.ts"
      via: "useAppSetting('subscription_website_url') for Manage Plan button visibility"
      pattern: "useAppSetting.*subscription_website_url"
    - from: "src/pages/SubscriptionPage.tsx"
      to: "wells PowerSync table"
      via: "useQuery COUNT(*) from wells for well count display"
      pattern: "COUNT.*wells.*WHERE.*farm_id"
    - from: "src/pages/SubscriptionPage.tsx"
      to: "src/hooks/useSubscriptionTier.ts"
      via: "useSubscriptionTier() for maxWells limit"
      pattern: "tier\\.maxWells"
---

<objective>
Enhance the Subscription page with well count display, "Manage Plan" external link button, and complete loading states for all tier-derived data.

Purpose: Users see their farm's well usage against the tier limit and can access the subscription management website. This completes the DB-driven tier replacement by making all tier data visible and actionable in the UI.

Output: Fully enhanced SubscriptionPage with well count, Manage Plan button, and loading skeletons.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-tier-sync-hooks/18-RESEARCH.md
@.planning/phases/18-tier-sync-hooks/18-01-SUMMARY.md
@src/pages/SubscriptionPage.tsx
@src/hooks/useSubscriptionTier.ts
@src/hooks/useSeatUsage.ts
@src/hooks/useAppSetting.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add well count display and Manage Plan button to SubscriptionPage</name>
  <files>src/pages/SubscriptionPage.tsx</files>
  <action>
Enhance the existing SubscriptionPage with three additions: well count display, "Manage Plan" button, and improved loading states. All additions use existing hooks plus the new `useAppSetting` from Plan 18-01.

**1. Add imports:**
- `useAuth` from `'../lib/AuthProvider'` (for farmId)
- `useAppSetting` from `'../hooks/useAppSetting'`
- `useQuery` from `'@powersync/react'`
- `useMemo` from `'react'`
- `ArrowTopRightOnSquareIcon` from `'@heroicons/react/24/outline'`

**2. Add well count query (inline in component):**
```typescript
const { onboardingStatus } = useAuth();
const farmId = onboardingStatus?.farmId ?? null;

const wellCountQuery = farmId
  ? `SELECT COUNT(*) as count FROM wells WHERE farm_id = ? AND status = 'active'`
  : 'SELECT NULL WHERE 0';

const { data: wellCountData } = useQuery<{ count: number }>(
  wellCountQuery,
  farmId ? [farmId] : []
);

const wellCount = useMemo(
  () => wellCountData?.[0]?.count ?? 0,
  [wellCountData]
);
```
Key: Filter by `status = 'active'` so decommissioned wells don't count against the limit.

**3. Add app settings query:**
```typescript
const subscriptionUrl = useAppSetting('subscription_website_url');
```

**4. Add well count row inside the seat usage card (the `tier && seatUsage` block):**
After the Meter Checkers row, add a Wells row matching the EXACT same layout pattern:
```tsx
{/* Wells */}
<div className="flex items-center justify-between">
  <span className="text-sm text-[#5f7248]">Wells</span>
  <span className={`text-sm font-medium ${wellCount >= tier.maxWells ? 'text-red-600' : 'text-[#5f7248]'}`}>
    {wellCount} / {tier.maxWells}
    {wellCount >= tier.maxWells && (
      <span className="ml-1.5 text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">Full</span>
    )}
  </span>
</div>
```

**5. Replace the bottom placeholder card** (the "Contact us to upgrade your plan" div) with the "Manage Plan" button:
```tsx
{/* Manage Plan button -- visible only when URL is set and non-empty */}
{subscriptionUrl && subscriptionUrl.trim() !== '' && farmId && (
  <a
    href={`${subscriptionUrl}${subscriptionUrl.includes('?') ? '&' : '?'}farm_id=${farmId}`}
    target="_blank"
    rel="noopener noreferrer"
    className="mt-4 inline-flex items-center justify-center gap-2 w-full bg-[#5f7248] text-white rounded-lg px-4 py-3 font-medium text-sm hover:bg-[#4e6339] transition-colors"
  >
    Manage Plan
    <ArrowTopRightOnSquareIcon className="h-4 w-4" />
  </a>
)}
```
Notes:
- Hidden when `subscriptionUrl` is null, empty, or whitespace -- no broken links per user decision
- Appends `?farm_id=<id>` (or `&farm_id=<id>` if URL already has query params)
- Uses `target="_blank"` to open in device's default browser per user decision
- External link icon (`ArrowTopRightOnSquareIcon`) per user decision
- The URL is currently empty in the DB -- button will be invisible until a real URL is inserted

**6. Update the loading skeleton** (the `!tier` block):
Add an additional skeleton row to represent the Wells row, matching the pattern of the existing skeleton lines. Also add a skeleton for the Manage Plan button area:
```tsx
{!tier && (
  <div className="bg-[#dfe4d4] rounded-lg p-3 mb-4 animate-pulse">
    <div className="h-4 bg-[#c5cdb4] rounded w-24 mb-2" />
    <div className="h-3 bg-[#c5cdb4] rounded w-full mb-1" />
    <div className="h-3 bg-[#c5cdb4] rounded w-full mb-1" />
    <div className="h-3 bg-[#c5cdb4] rounded w-full" />
  </div>
)}
```
(Three rows instead of two to account for Admins + Meter Checkers + Wells.)

**7. Keep the Subscription page gated behind `manage_farm` permission** -- this is already handled by the router (grower-only access). No changes needed to routing.

**Important: Do NOT add any hardcoded tier limits.** All values come from `useSubscriptionTier()` and `useSeatUsage()` hooks.
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- no type errors.
Verify SubscriptionPage imports: `useAuth`, `useAppSetting`, `useQuery`, `useMemo`, `ArrowTopRightOnSquareIcon`.
Verify well count query filters by `status = 'active'`.
Verify "Manage Plan" button has `target="_blank"` and `rel="noopener noreferrer"`.
Verify "Manage Plan" button is hidden when URL is empty/null.
Verify well count row uses the same layout pattern as admin/meter_checker rows.
Verify the "Full" badge appears when `wellCount >= tier.maxWells`.
  </verify>
  <done>
Subscription page shows well count vs tier limit with "Full" badge at capacity, "Manage Plan" button opens external URL with farm_id parameter (hidden when URL not set), and skeleton loading covers all three usage rows while tier data loads.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. Well count row displays correctly with same visual pattern as seat rows
3. "Full" badge appears on well count when at capacity (same red badge style)
4. "Manage Plan" button hidden when subscription_website_url is empty/null
5. "Manage Plan" button renders with external link icon when URL is set
6. Loading skeleton shows 3 rows (admins, meter checkers, wells)
7. No hardcoded tier limits anywhere in the modified file
</verification>

<success_criteria>
- Subscription page shows well count vs tier well limit alongside seat usage
- "Manage Plan" button conditionally renders based on app_settings URL value
- All tier-derived numbers show skeleton loading while data is null
- The hardcoded "Contact us to upgrade your plan" placeholder is replaced with the dynamic Manage Plan button
</success_criteria>

<output>
After completion, create `.planning/phases/18-tier-sync-hooks/18-02-SUMMARY.md`
</output>
