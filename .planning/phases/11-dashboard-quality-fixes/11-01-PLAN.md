---
phase: 11-dashboard-quality-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/validation.ts
  - src/components/AddWellFormBottomSheet.tsx
  - src/components/LocationPickerBottomSheet.tsx
  - src/components/WellMarker.tsx
autonomous: true

must_haves:
  truths:
    - "AddWellFormBottomSheet Save button is disabled when coordinates are outside US bounds (lat 18-72, lng -180 to -66)"
    - "AddWellFormBottomSheet shows inline error message when coordinates are globally valid but outside US bounds"
    - "LocationPickerBottomSheet Next button is disabled when coordinates are outside US bounds"
    - "LocationPickerBottomSheet shows inline error message when coordinates are globally valid but outside US bounds"
    - "WellMarker statusText is computed without useMemo wrapper"
    - "Typing-level input guards remain at global ranges (-90/90, -180/180) — users can still type any globally valid coordinate"
  artifacts:
    - path: "src/lib/validation.ts"
      provides: "US coordinate bounds constants and validation functions"
      exports: ["US_COORDINATE_BOUNDS", "isWithinUSBounds", "getCoordinateValidationError"]
    - path: "src/components/AddWellFormBottomSheet.tsx"
      provides: "Well creation form with US-bounds coordinate validation"
      contains: "getCoordinateValidationError"
    - path: "src/components/LocationPickerBottomSheet.tsx"
      provides: "Location picker with US-bounds coordinate validation"
      contains: "getCoordinateValidationError"
    - path: "src/components/WellMarker.tsx"
      provides: "Optimized well marker without useMemo on statusText"
  key_links:
    - from: "src/components/AddWellFormBottomSheet.tsx"
      to: "src/lib/validation.ts"
      via: "import { getCoordinateValidationError }"
      pattern: "getCoordinateValidationError"
    - from: "src/components/LocationPickerBottomSheet.tsx"
      to: "src/lib/validation.ts"
      via: "import { getCoordinateValidationError }"
      pattern: "getCoordinateValidationError"
---

<objective>
Add US-bounds coordinate validation to both form components and optimize WellMarker by removing unnecessary useMemo.

Purpose: Ensure wells can only be created within US territory (lat 18-72, lng -180 to -66) with clear inline error messaging, and clean up a redundant useMemo in WellMarker. This covers QUAL-03, QUAL-06, and QUAL-07 — the three items that need actual code changes in Phase 11.

Output: Shared validation utility, updated forms with US-bounds validation + inline errors, optimized WellMarker.
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dashboard-quality-fixes/11-RESEARCH.md
@src/components/AddWellFormBottomSheet.tsx
@src/components/LocationPickerBottomSheet.tsx
@src/components/WellMarker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared US-bounds validation utility and update both form components</name>
  <files>
    src/lib/validation.ts
    src/components/AddWellFormBottomSheet.tsx
    src/components/LocationPickerBottomSheet.tsx
  </files>
  <action>
**Step 1: Create `src/lib/validation.ts`**

Create a new file with these exports:

```typescript
export const US_COORDINATE_BOUNDS = {
  lat: { min: 18, max: 72 },
  lng: { min: -180, max: -66 },
} as const;

export function isWithinUSBounds(lat: number, lng: number): boolean {
  return (
    lat >= US_COORDINATE_BOUNDS.lat.min &&
    lat <= US_COORDINATE_BOUNDS.lat.max &&
    lng >= US_COORDINATE_BOUNDS.lng.min &&
    lng <= US_COORDINATE_BOUNDS.lng.max
  );
}

export function getCoordinateValidationError(lat: number, lng: number): string | null {
  if (isNaN(lat) || isNaN(lng)) return 'Invalid coordinates';
  if (lat < -90 || lat > 90) return 'Latitude must be between -90 and 90';
  if (lng < -180 || lng > 180) return 'Longitude must be between -180 and 180';
  if (!isWithinUSBounds(lat, lng)) {
    return 'Coordinates must be within the United States';
  }
  return null;
}
```

**Step 2: Update `AddWellFormBottomSheet.tsx`**

1. Add import: `import { getCoordinateValidationError } from '../lib/validation';`

2. Add a `coordinateError` computed value BEFORE `isFormValid` (around line 161):
```typescript
const coordinateError = getCoordinateValidationError(latitude, longitude);
```

3. Replace the current `isFormValid` (lines 161-165) with:
```typescript
const isFormValid =
  name.trim() !== '' &&
  wmisNumber.trim() !== '' &&
  coordinateError === null;
```

4. Add inline error display for coordinate validation AFTER the gpsError display (after line 269). Place it below the `{gpsError && ...}` block but still inside the `{/* Latitude, Longitude, GPS */}` section's parent div. Use the existing error pattern:
```tsx
{coordinateError && !gpsError && (
  <p className="text-red-500 text-xs mt-1">{coordinateError}</p>
)}
```
Note: Only show coordinate error when there is no GPS error (GPS error takes priority since it's more actionable).

5. DO NOT change the `handleLatitudeChange` or `handleLongitudeChange` functions — keep their typing-level guards at global -90/90 and -180/180 ranges.

**Step 3: Update `LocationPickerBottomSheet.tsx`**

1. Add import: `import { getCoordinateValidationError } from '../lib/validation';`

2. Add a `coordinateError` computed value BEFORE `isNextDisabled` (around line 91):
```typescript
const coordinateError = location
  ? getCoordinateValidationError(location.latitude, location.longitude)
  : null;
```

3. Replace `isNextDisabled` (lines 91-93) with:
```typescript
const isNextDisabled = !location || coordinateError !== null;
```

4. Add inline error display AFTER the existing GPS error block (after line 161). Add it below the `{gpsError && ...}` block:
```tsx
{coordinateError && !gpsError && (
  <p className="text-red-500 text-xs mt-2">{coordinateError}</p>
)}
```

5. DO NOT change the `handleLatitudeChange` or `handleLongitudeChange` functions — keep their typing-level guards at global -90/90 and -180/180 ranges.
  </action>
  <verify>
Run `npx tsc -b --noEmit` — no type errors.

Manually verify:
- `src/lib/validation.ts` exports `US_COORDINATE_BOUNDS`, `isWithinUSBounds`, and `getCoordinateValidationError`
- `AddWellFormBottomSheet.tsx` imports from `../lib/validation` and uses `getCoordinateValidationError` in `isFormValid`
- `LocationPickerBottomSheet.tsx` imports from `../lib/validation` and uses `getCoordinateValidationError` in `isNextDisabled`
- Both forms show inline coordinate error text below the coordinate inputs
- Neither form's `handleLatitudeChange` / `handleLongitudeChange` was modified
  </verify>
  <done>
Save button in AddWellFormBottomSheet is disabled when coordinates are outside US bounds (lat 18-72, lng -180 to -66). Next button in LocationPickerBottomSheet is disabled when coordinates are outside US bounds. Both forms show "Coordinates must be within the United States" inline error when coordinates are globally valid but outside US. Typing-level input guards remain at global ranges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unnecessary useMemo from WellMarker statusText</name>
  <files>
    src/components/WellMarker.tsx
  </files>
  <action>
In `src/components/WellMarker.tsx`:

1. Change the import on line 1 from:
```typescript
import { memo, useCallback, useMemo } from 'react';
```
to:
```typescript
import { memo, useCallback } from 'react';
```

2. Replace the useMemo-wrapped statusText (lines 69-71):
```typescript
const statusText = useMemo(() => {
  return getStatusText(well.createdAt, well.updatedAt);
}, [well.createdAt, well.updatedAt]);
```
with a direct function call:
```typescript
const statusText = getStatusText(well.createdAt, well.updatedAt);
```

This is safe because WellMarker is already wrapped in `React.memo`, so it only re-renders when props change. The `useMemo` dependency array `[well.createdAt, well.updatedAt]` is redundant with the outer `memo` check — if those props haven't changed, the component doesn't re-render at all.
  </action>
  <verify>
Run `npx tsc -b --noEmit` — no type errors.

Verify in `src/components/WellMarker.tsx`:
- `useMemo` is NOT in the import statement
- `statusText` is assigned via direct function call (no useMemo wrapper)
- The `getStatusText` function itself is unchanged
- The component is still wrapped in `memo()`
  </verify>
  <done>
WellMarker statusText is computed as a direct function call without useMemo. The useMemo import is removed. Component remains wrapped in React.memo for re-render prevention.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. `src/lib/validation.ts` exists and exports US_COORDINATE_BOUNDS, isWithinUSBounds, getCoordinateValidationError
3. AddWellFormBottomSheet.tsx: isFormValid uses coordinateError === null (not raw -90/90 ranges)
4. LocationPickerBottomSheet.tsx: isNextDisabled uses coordinateError !== null (not raw -90/90 ranges)
5. Both forms display inline coordinate error text
6. Neither form's typing-level handlers were changed (still accept -90/90, -180/180)
7. WellMarker.tsx: no useMemo import, statusText is direct function call
8. Already-implemented items confirmed (QUAL-01, QUAL-02, QUAL-04, QUAL-05, QUAL-08, QUAL-09 — verified during research, no code changes needed)
</verification>

<success_criteria>
- US-bounds coordinate validation prevents saving wells outside lat 18-72, lng -180 to -66 in both forms
- Inline error messages appear when coordinates are outside US bounds
- WellMarker uses plain function call instead of useMemo for statusText
- TypeScript compilation succeeds with no errors
- No regressions: typing-level input guards unchanged, meter serial number still optional, all existing behavior preserved
</success_criteria>

<output>
After completion, create `.planning/phases/11-dashboard-quality-fixes/11-01-SUMMARY.md`
</output>
