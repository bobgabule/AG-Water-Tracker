---
phase: 13-well-detail-page
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/components/WellUsageGauge.tsx
  - src/components/WellReadingsList.tsx
  - src/components/WellDetailSheet.tsx
  - src/hooks/useWellReadingsWithNames.ts
autonomous: true
requirements:
  - WELL-03
  - WELL-05
  - WELL-06
  - WELL-07
  - READ-07
  - PROX-01

must_haves:
  truths:
    - "Usage gauge bar shows allocated, used, and remaining amounts for the current allocation period with color-coded fill"
    - "When no allocation exists for the well, a 'No allocation set' message is displayed instead of the gauge"
    - "Readings history shows each reading's date, value, user name, and time in a scrollable list"
    - "Out-of-range readings are marked with a yellow indicator dot"
    - "When no readings exist, a 'No readings yet' empty state message is shown"
    - "GPS proximity indicator shows 'In Range' or 'Out of Range' based on user's current location and well coordinates"
  artifacts:
    - path: "src/components/WellUsageGauge.tsx"
      provides: "Horizontal stacked bar gauge with allocated/used/remaining and empty state"
      min_lines: 40
    - path: "src/components/WellReadingsList.tsx"
      provides: "Scrollable readings history with user names, dates, values, and GPS indicators"
      min_lines: 60
    - path: "src/hooks/useWellReadingsWithNames.ts"
      provides: "Enhanced readings query with LEFT JOIN to farm_members for recorder names"
      min_lines: 30
  key_links:
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/components/WellUsageGauge.tsx"
      via: "rendered in scrollable content area"
      pattern: "WellUsageGauge"
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/components/WellReadingsList.tsx"
      via: "rendered in scrollable content area"
      pattern: "WellReadingsList"
    - from: "src/hooks/useWellReadingsWithNames.ts"
      to: "farm_members"
      via: "LEFT JOIN for recorder_name"
      pattern: "LEFT JOIN farm_members"
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/lib/gps-proximity.ts"
      via: "getDistanceToWell + isInRange for proximity indicator"
      pattern: "getDistanceToWell|isInRange"
---

<objective>
Create the well detail content sections: usage gauge showing allocation data, readings history list with user names and GPS indicators, and GPS proximity display. These components plug into the scrollable content area of the WellDetailSheet created in Plan 01.

Purpose: Display the data that makes the well detail sheet useful -- users need to see allocation status at a glance, browse historical readings with who recorded them, and know if they're near the well.
Output: WellUsageGauge, WellReadingsList, useWellReadingsWithNames, updated WellDetailSheet
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-well-detail-page/13-CONTEXT.md
@.planning/phases/13-well-detail-page/13-RESEARCH.md
@.planning/phases/13-well-detail-page/13-01-SUMMARY.md
@src/hooks/useWellReadings.ts
@src/hooks/useWellAllocations.ts
@src/hooks/useWells.ts
@src/lib/gps-proximity.ts
@src/components/WellDetailSheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WellUsageGauge, WellReadingsList, and useWellReadingsWithNames</name>
  <files>
    src/components/WellUsageGauge.tsx
    src/components/WellReadingsList.tsx
    src/hooks/useWellReadingsWithNames.ts
  </files>
  <action>
**Step 1: Create useWellReadingsWithNames.ts** (`src/hooks/useWellReadingsWithNames.ts`)

This hook enhances `useWellReadings` by joining against `farm_members` to resolve `recorded_by` user IDs to display names.

```typescript
import { useMemo } from 'react';
import { useQuery } from '@powersync/react';

export interface ReadingWithName {
  id: string;
  wellId: string;
  value: string;
  recordedBy: string;
  recordedAt: string;
  recorderName: string;
  gpsLatitude: number | null;
  gpsLongitude: number | null;
  isInRange: boolean;
  notes: string | null;
}

interface ReadingWithNameRow {
  id: string;
  well_id: string | null;
  value: string | null;
  recorded_by: string | null;
  recorded_at: string | null;
  recorder_name: string | null;
  gps_latitude: number | null;
  gps_longitude: number | null;
  is_in_range: number | null;
  notes: string | null;
}
```

Query (when wellId is truthy):
```sql
SELECT r.id, r.well_id, r.value, r.recorded_by, r.recorded_at,
  r.gps_latitude, r.gps_longitude, r.is_in_range, r.notes,
  COALESCE(fm.full_name, 'Unknown') as recorder_name
FROM readings r
LEFT JOIN farm_members fm ON fm.user_id = r.recorded_by
WHERE r.well_id = ?
ORDER BY r.recorded_at DESC
```

When wellId is null/undefined, use `'SELECT NULL WHERE 0'` (standard empty guard).

Map rows using `useMemo` with boolean conversion for `is_in_range` (same pattern as useWellReadings.ts), nullish coalescing for text fields.

Return: `{ readings: ReadingWithName[], loading, error }`

**Step 2: Create WellUsageGauge.tsx** (`src/components/WellUsageGauge.tsx`)

Pure presentational component wrapped in React.memo.

Props:
```typescript
interface WellUsageGaugeProps {
  allocatedAf: string;  // TEXT from PowerSync, needs parseFloat
  usedAf: string;       // TEXT from PowerSync, needs parseFloat
}
```

Logic:
- `allocated = parseFloat(allocatedAf) || 0`
- `used = parseFloat(usedAf) || 0`
- `remaining = Math.max(0, allocated - used)`
- `usedPercent = allocated > 0 ? Math.min((used / allocated) * 100, 100) : 0`
- Color thresholds: `usedPercent > 90 ? 'bg-red-500' : usedPercent > 75 ? 'bg-yellow-500' : 'bg-green-500'`

Layout:
```
[Section title: "Water Usage"]
[Labels row: "Used: X.XX AF" (left) | "Remaining: X.XX AF" (right)]
[Horizontal bar: gray-700 background track, colored fill bar with rounded ends]
[Bottom label: "Allocated: X.XX AF" | "XX.X%" (right)]
```

Use Tailwind classes for the bar: `h-3 bg-white/10 rounded-full overflow-hidden` for track, dynamic width via `style={{ width: \`${usedPercent}%\` }}` for fill. Add `transition-all duration-300` to the fill for smooth updates.

**Step 3: Create WellReadingsList.tsx** (`src/components/WellReadingsList.tsx`)

Props:
```typescript
interface WellReadingsListProps {
  readings: ReadingWithName[];
}
```

Import `ReadingWithName` from `../hooks/useWellReadingsWithNames`.

Layout -- compact card rows (per research recommendation, not a dense table):
```
[Section title: "Readings History"]
[Divider-separated rows, each row:]
  Left column: Date (bold, text-sm, white) + Time (text-xs, white/50) -- stacked vertically
  Center: Value (text-lg, font-semibold, white)
  Right column: User name (text-xs, white/70) + GPS indicator (yellow dot if out of range)
```

For each reading:
- Parse `recordedAt` with `new Date(reading.recordedAt)`
- Date: `toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })` -- e.g., "Jan 15, 2026"
- Time: `toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })` -- e.g., "2:30 PM"
- GPS indicator: if `!reading.isInRange`, show a small yellow dot (`w-2.5 h-2.5 rounded-full bg-yellow-400`) with "Out of range" as a title attribute for accessibility

Empty state: When `readings.length === 0`:
```
[ClipboardDocumentListIcon from @heroicons/react/24/outline, w-10 h-10, text-white/30]
[Text: "No readings yet" -- text-sm, text-white/50]
```

Wrap in React.memo.
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with no errors
2. The three files exist and contain the expected exports
3. useWellReadingsWithNames query includes LEFT JOIN against farm_members
  </verify>
  <done>
- WellUsageGauge renders a horizontal bar with color-coded fill based on usage percentage
- WellUsageGauge correctly parseFloat's TEXT values from PowerSync
- WellReadingsList renders compact card rows with date, time, value, user name, and GPS indicator
- Out-of-range readings show a yellow dot indicator
- Empty readings state shows "No readings yet" with clipboard icon
- useWellReadingsWithNames resolves recorded_by to display names via LEFT JOIN
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire content sections and GPS proximity into WellDetailSheet</name>
  <files>
    src/components/WellDetailSheet.tsx
  </files>
  <action>
Update WellDetailSheet.tsx to replace the placeholder content with the real content sections.

**Step 1: Add imports**
```typescript
import { useWellAllocations } from '../hooks/useWellAllocations';
import { useWellReadingsWithNames } from '../hooks/useWellReadingsWithNames';
import { useGeolocation } from '../hooks/useGeolocation';
import { getDistanceToWell, isInRange } from '../lib/gps-proximity';
import WellUsageGauge from './WellUsageGauge';
import WellReadingsList from './WellReadingsList';
import { MapPinIcon } from '@heroicons/react/24/outline';
import { InformationCircleIcon } from '@heroicons/react/24/outline';
```

**Step 2: Add data hooks inside component**
After the existing well/navigation logic, add:
```typescript
const { allocations } = useWellAllocations(currentWell?.id ?? null);
const { readings } = useWellReadingsWithNames(currentWell?.id ?? null);
const { location: userLocation } = useGeolocation({ autoRequest: false });

// Find current allocation (most recent period that encompasses today, or just first/most recent)
const currentAllocation = useMemo(() => {
  const today = new Date().toISOString().split('T')[0];
  return allocations.find(a => a.periodStart <= today && a.periodEnd >= today)
    ?? allocations[0]  // fallback to most recent if none spans today
    ?? null;
}, [allocations]);

// GPS proximity
const proximityInfo = useMemo(() => {
  if (!userLocation || !currentWell?.location) return null;
  const dist = getDistanceToWell(
    { lat: userLocation.lat, lng: userLocation.lng },
    { latitude: currentWell.location.latitude, longitude: currentWell.location.longitude }
  );
  return { distance: dist, inRange: isInRange(dist) };
}, [userLocation, currentWell?.location]);
```

**Step 3: Replace placeholder content in the scrollable area**

Inside the scrollable content div (after the cross-fade wrapper), replace the placeholder text with:

```tsx
{currentWell && (
  <div className="p-4 pb-[max(1rem,env(safe-area-inset-bottom))] space-y-6">
    {/* GPS Proximity indicator */}
    {proximityInfo && (
      <div className={`flex items-center gap-2 px-3 py-2 rounded-lg ${
        proximityInfo.inRange ? 'bg-green-500/20' : 'bg-yellow-500/20'
      }`}>
        <MapPinIcon className={`w-5 h-5 ${
          proximityInfo.inRange ? 'text-green-400' : 'text-yellow-400'
        }`} />
        <span className={`text-sm font-medium ${
          proximityInfo.inRange ? 'text-green-300' : 'text-yellow-300'
        }`}>
          {proximityInfo.inRange ? 'In Range' : 'Out of Range'}
          <span className="text-white/50 font-normal ml-1.5">
            ({Math.round(proximityInfo.distance)} ft)
          </span>
        </span>
      </div>
    )}

    {/* Usage Gauge or Missing Allocation */}
    {currentAllocation ? (
      <WellUsageGauge
        allocatedAf={currentAllocation.allocatedAf}
        usedAf={currentAllocation.usedAf}
      />
    ) : (
      <div className="flex items-center gap-2 px-3 py-3 rounded-lg bg-white/5">
        <InformationCircleIcon className="w-5 h-5 text-white/40" />
        <span className="text-sm text-white/50">
          No allocation set for this well
        </span>
      </div>
    )}

    {/* Readings History */}
    <WellReadingsList readings={readings} />
  </div>
)}
```

**Important notes:**
- `useGeolocation` hook at `src/hooks/useGeolocation.ts` returns `{ location, loading, error, retry, requestLocation }` where `location` is `{ lat: number; lng: number } | null`. Use `autoRequest: false` so the well detail page does NOT trigger a location request on its own â€” it only displays proximity if the user has previously granted location permission (e.g., from the map's location FAB).
- The proximity indicator only shows when `userLocation` is non-null. It does not prompt for location permission.
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with no errors
2. Navigate to a well detail page -- see usage gauge (or "No allocation set" message)
3. See readings history list (or "No readings yet" message)
4. If GPS permission previously granted, see "In Range" or "Out of Range" indicator with distance in feet
  </verify>
  <done>
- WellDetailSheet renders WellUsageGauge when allocation exists, or "No allocation set" message when missing
- WellDetailSheet renders WellReadingsList with readings data (user names resolved via LEFT JOIN)
- GPS proximity indicator shows In Range (green) or Out of Range (yellow) with distance in feet when user location is available
- All content sections are inside the scrollable area with cross-fade support
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` -- zero type errors
2. Well detail page shows usage gauge with colored bar when allocation exists
3. Well detail page shows "No allocation set" when no allocation exists for the well
4. Readings list shows date, time, value, user name for each reading
5. Out-of-range readings have a yellow dot indicator
6. Empty readings state shows "No readings yet" with clipboard icon
7. GPS proximity shows "In Range" / "Out of Range" when user location is available
8. Scrolling through readings works without triggering swipe-down dismiss
</verification>

<success_criteria>
- All content sections render correctly with real data from PowerSync hooks
- Empty states display appropriate messages for missing allocations and readings
- GPS proximity indicator works with existing geolocation infrastructure
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-well-detail-page/13-02-SUMMARY.md`
</output>
