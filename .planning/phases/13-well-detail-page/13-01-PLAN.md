---
phase: 13-well-detail-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/pages/WellDetailPage.tsx
  - src/components/WellDetailSheet.tsx
  - src/components/WellDetailHeader.tsx
  - src/components/WellStatusIndicators.tsx
  - src/hooks/useWellProximityOrder.ts
autonomous: true
requirements:
  - WELL-01
  - WELL-02
  - WELL-04
  - WELL-08
  - WELL-09

must_haves:
  truths:
    - "User taps a well marker on the map and a full-page sheet slides up covering ~90% of the viewport with a dark scrim behind it"
    - "The sheet header shows farm name, well name, serial number, WMIS number, and last updated timestamp"
    - "Status indicators for Pump, Battery, and Meter display with check/X/warning icons based on state"
    - "Back button in the top-left dismisses the sheet and returns to the map"
    - "Edit button in the top-right navigates to /wells/:id/edit"
    - "Swiping down on the header dismisses the sheet"
    - "Swiping left/right on the header cycles through wells ordered by geographic proximity"
  artifacts:
    - path: "src/pages/WellDetailPage.tsx"
      provides: "Route page component for /wells/:id"
      min_lines: 20
    - path: "src/components/WellDetailSheet.tsx"
      provides: "Full-page slide-up sheet with Dialog, scrim, gestures, and content layout"
      min_lines: 80
    - path: "src/components/WellDetailHeader.tsx"
      provides: "Pinned header with back/edit buttons, well metadata, and status indicators"
      min_lines: 50
    - path: "src/components/WellStatusIndicators.tsx"
      provides: "Equipment status chips with icon/color mapping"
      min_lines: 30
    - path: "src/hooks/useWellProximityOrder.ts"
      provides: "Wells ordered by geographic distance from current well"
      min_lines: 25
  key_links:
    - from: "src/App.tsx"
      to: "src/pages/WellDetailPage.tsx"
      via: "Route /wells/:id"
      pattern: "path.*wells.*:id"
    - from: "src/pages/DashboardPage.tsx"
      to: "/wells/:id"
      via: "navigate(/wells/${id}) in handleWellClick"
      pattern: "navigate.*wells"
    - from: "src/components/WellDetailSheet.tsx"
      to: "src/hooks/useWellProximityOrder.ts"
      via: "proximity-ordered wells for swipe navigation"
      pattern: "useWellProximityOrder"
    - from: "src/components/WellDetailSheet.tsx"
      to: "react-swipeable"
      via: "useSwipeable for down/left/right gestures"
      pattern: "useSwipeable"
---

<objective>
Create the well detail sheet foundation: route, slide-up Dialog container with swipe gestures (dismiss + well-to-well navigation), and the pinned header showing well metadata and equipment status indicators.

Purpose: Establish the interactive sheet that users open by tapping a well marker, with all navigation mechanics (back, edit, swipe dismiss, swipe between wells) working before content sections are added.
Output: WellDetailPage, WellDetailSheet, WellDetailHeader, WellStatusIndicators, useWellProximityOrder
</objective>

<execution_context>
@C:/Users/Kis&Co/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kis&Co/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-well-detail-page/13-CONTEXT.md
@.planning/phases/13-well-detail-page/13-RESEARCH.md
@src/App.tsx
@src/pages/DashboardPage.tsx
@src/components/AddWellFormBottomSheet.tsx
@src/hooks/useWells.ts
@src/lib/gps-proximity.ts
@src/components/AppLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-swipeable, add route, create WellDetailPage + WellDetailSheet + useWellProximityOrder</name>
  <files>
    src/App.tsx
    src/pages/WellDetailPage.tsx
    src/components/WellDetailSheet.tsx
    src/hooks/useWellProximityOrder.ts
  </files>
  <action>
**Step 1: Install react-swipeable**
```bash
npm install react-swipeable
```

**Step 2: Add route to App.tsx**
Inside the AppLayout route group (after `/settings`), add:
```tsx
<Route path="/wells/:id" element={<WellDetailPage />} />
```
Import WellDetailPage at the top. This route sits alongside Dashboard inside AppLayout so the Header/SideMenu remain accessible (though the sheet will visually cover them).

**Step 3: Create useWellProximityOrder.ts** (`src/hooks/useWellProximityOrder.ts`)
- Import `useMemo` from react and `distance` from `@turf/distance`
- Import `WellWithReading` from `./useWells`
- Export function `useWellProximityOrder(currentWellId: string | undefined, wells: WellWithReading[]): WellWithReading[]`
- Inside: useMemo that filters out the current well and wells with `location === null`, computes distance from currentWell to each remaining well using `distance([currentWell.location.longitude, currentWell.location.latitude], [w.location.longitude, w.location.latitude], { units: 'feet' })`, sorts by distance ascending, then returns the full ordered array with the current well prepended at index 0 (so the ordered list is: [currentWell, nearest, next-nearest, ...])
- Memoize on `[currentWellId, wells]`
- If currentWellId is undefined or current well not found or has no location, return wells as-is (no reordering)

**Step 4: Create WellDetailPage.tsx** (`src/pages/WellDetailPage.tsx`)
- Import `useParams`, `useNavigate` from `react-router`
- Import `useCallback` from `react`
- Import `useWells` from hooks, `useAuth` from AuthProvider
- Import `WellDetailSheet` from components
- Extract `id` from `useParams<{ id: string }>()`
- Get `wells` from `useWells()`, `onboardingStatus` from `useAuth()`
- `farmName = onboardingStatus?.farmName ?? ''`
- Find `currentWell = wells.find(w => w.id === id)` -- if not found and wells not loading, could navigate back (but for now, show nothing)
- `handleClose = useCallback(() => navigate('/'), [navigate])`
- `handleEdit = useCallback(() => navigate(\`/wells/${id}/edit\`), [navigate, id])`
- `handleWellChange = useCallback((wellId: string) => navigate(\`/wells/${wellId}\`, { replace: true }), [navigate])`
- Render: `<WellDetailSheet wellId={id!} wells={wells} farmName={farmName} onClose={handleClose} onEdit={handleEdit} onWellChange={handleWellChange} />`

**Step 5: Create WellDetailSheet.tsx** (`src/components/WellDetailSheet.tsx`)
- Import: `useState, useCallback, useMemo, useRef` from react
- Import: `Dialog, DialogBackdrop, DialogPanel` from `@headlessui/react`
- Import: `useSwipeable` from `react-swipeable`
- Import: `WellDetailHeader` from `./WellDetailHeader` (will be created in Task 2, use placeholder for now)
- Import: `useWellProximityOrder` from hooks
- Import: `WellWithReading` from `../hooks/useWells`

Props interface:
```typescript
interface WellDetailSheetProps {
  wellId: string;
  wells: WellWithReading[];
  farmName: string;
  onClose: () => void;
  onEdit: () => void;
  onWellChange: (wellId: string) => void;
}
```

Component logic:
- `orderedWells = useWellProximityOrder(wellId, wells)`
- `currentIndex = useMemo(() => orderedWells.findIndex(w => w.id === wellId), [orderedWells, wellId])`
- `currentWell = orderedWells[currentIndex] ?? null`
- `[transitioning, setTransitioning] = useState(false)` -- for cross-fade effect
- `navigateToWell(direction: 'next' | 'prev')`: calculate target index with wrap-around, skip if only 1 well, trigger cross-fade (set transitioning=true, setTimeout 150ms to set false), call `onWellChange(orderedWells[targetIndex].id)`
- Swipe handlers via `useSwipeable`:
  ```typescript
  const swipeHandlers = useSwipeable({
    onSwipedDown: (e) => { if (e.absY > 80) onClose(); },
    onSwipedLeft: () => navigateToWell('next'),
    onSwipedRight: () => navigateToWell('prev'),
    delta: 40,
    trackTouch: true,
    trackMouse: false,
    preventScrollOnSwipe: false,
  });
  ```

Render structure:
```tsx
<Dialog open={true} onClose={() => {}} static className="relative z-50">
  <DialogBackdrop className="fixed inset-0 bg-black/40" />
  <div className="fixed inset-0 flex flex-col">
    {/* Top peek area (10% = dark background) */}
    <div className="h-[10vh]" />
    {/* Sheet panel (90%) */}
    <DialogPanel
      transition
      className="flex-1 bg-[#5f7248] rounded-t-2xl shadow-xl flex flex-col
        transition duration-350 ease-out data-[closed]:translate-y-full overflow-hidden"
    >
      {/* Swipeable header area */}
      <div {...swipeHandlers} className="flex-shrink-0">
        <WellDetailHeader
          well={currentWell}
          farmName={farmName}
          onClose={onClose}
          onEdit={onEdit}
        />
      </div>
      {/* Scrollable content area with cross-fade */}
      <div className={`flex-1 overflow-y-auto transition-opacity duration-150 ${transitioning ? 'opacity-0' : 'opacity-100'}`}>
        {currentWell && (
          <div className="p-4 pb-[max(1rem,env(safe-area-inset-bottom))]">
            {/* Content sections will be added in Plan 02 */}
            <p className="text-white/50 text-sm">Well detail content loading...</p>
          </div>
        )}
      </div>
    </DialogPanel>
  </div>
</Dialog>
```

IMPORTANT: Use `static` prop on Dialog (not `onClose` callback) to prevent clicking the backdrop from dismissing. The `onClose={() => {}}` is required by Dialog but won't fire because of `static`. Per user decision: tapping the overlay does NOT dismiss.

Note on `duration-350`: Tailwind v4 supports arbitrary values like `duration-350` (or use `duration-[350ms]`). Use whichever compiles -- check by running the dev server. If `duration-350` doesn't work, use `duration-300` as the closest built-in value. The user specified ~350ms which is approximate.
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with no errors
2. `npm run dev` starts and navigating to `/wells/some-id` renders the sheet (even if well not found, no crash)
3. react-swipeable is in package.json dependencies
  </verify>
  <done>
- Route `/wells/:id` exists in App.tsx and renders WellDetailPage
- WellDetailSheet renders a Headless UI Dialog covering 90% of viewport with dark scrim
- Sheet has ~350ms slide-up animation via data-[closed]:translate-y-full
- Swipe-down on header area dismisses the sheet (navigates to /)
- Swipe-left/right on header changes well via proximity ordering with 150ms cross-fade
- useWellProximityOrder returns wells sorted by geographic distance from current well
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WellDetailHeader and WellStatusIndicators components</name>
  <files>
    src/components/WellDetailHeader.tsx
    src/components/WellStatusIndicators.tsx
  </files>
  <action>
**Step 1: Create WellStatusIndicators.tsx** (`src/components/WellStatusIndicators.tsx`)

Create a pure presentational component that renders equipment status chips.

```typescript
import React from 'react';
import { CheckCircleIcon, XCircleIcon, ExclamationTriangleIcon, QuestionMarkCircleIcon } from '@heroicons/react/24/solid';

interface StatusConfig {
  icon: React.ComponentType<React.SVGProps<SVGSVGElement>>;
  color: string;
  label: string;
}

function getStatusConfig(state: string): StatusConfig {
  switch (state) {
    case 'Ok':
      return { icon: CheckCircleIcon, color: 'text-green-400', label: 'OK' };
    case 'Low':
      return { icon: ExclamationTriangleIcon, color: 'text-yellow-400', label: 'Low' };
    case 'Critical':
      return { icon: XCircleIcon, color: 'text-red-400', label: 'Critical' };
    case 'Dead':
      return { icon: XCircleIcon, color: 'text-red-600', label: 'Dead' };
    default:
      return { icon: QuestionMarkCircleIcon, color: 'text-gray-400', label: 'Unknown' };
  }
}

interface WellStatusIndicatorsProps {
  pumpState: string;
  batteryState: string;
  meterStatus: string;
}

// Wrap in React.memo per CLAUDE.md performance guidelines
const WellStatusIndicators = React.memo(function WellStatusIndicators({
  pumpState,
  batteryState,
  meterStatus,
}: WellStatusIndicatorsProps) {
  const pump = getStatusConfig(pumpState);
  const battery = getStatusConfig(batteryState);
  const meter = getStatusConfig(meterStatus);

  return (
    <div className="flex gap-3 flex-wrap">
      {[
        { label: 'Pump', config: pump },
        { label: 'Battery', config: battery },
        { label: 'Meter', config: meter },
      ].map(({ label, config }) => {
        const Icon = config.icon;
        return (
          <div
            key={label}
            className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/10"
          >
            <Icon className={`w-4 h-4 ${config.color}`} />
            <span className="text-xs text-white/80">
              {label}: {config.label}
            </span>
          </div>
        );
      })}
    </div>
  );
});

export default WellStatusIndicators;
```

**Step 2: Create WellDetailHeader.tsx** (`src/components/WellDetailHeader.tsx`)

Props:
```typescript
interface WellDetailHeaderProps {
  well: WellWithReading | null;
  farmName: string;
  onClose: () => void;
  onEdit: () => void;
}
```

Import:
- `React, useCallback` from react
- `ArrowLeftIcon` from `@heroicons/react/24/outline`
- `PencilSquareIcon` from `@heroicons/react/24/outline`
- `WellStatusIndicators` from `./WellStatusIndicators`
- `WellWithReading` from `../hooks/useWells`

Layout (information hierarchy per research recommendation):
```
Row 1: [<- Back] [Farm Name centered] [Edit pencil icon]
Row 2: Well Name (large, bold, white, text-xl)
Row 3: Serial # | WMIS # | Last Updated (small text, separated by middot)
Row 4: Status indicator chips (Pump, Battery, Meter)
```

If `well` is null, render a minimal header with just the back button and "Well not found" text.

Format `updatedAt` using `new Date(well.updatedAt).toLocaleDateString()` for the "Last Updated" display. Use a simple format -- no external date library.

For the serial and WMIS display, show them conditionally (only if non-null/non-empty). Separate with ` \u00B7 ` (middle dot). Example: `SN-12345 · WMIS-67890 · Updated Jan 15, 2026`.

Wrap in React.memo per CLAUDE.md performance guidelines.

Render padding: `px-4 pt-4 pb-3` to give breathing room. The header is inside the swipe handler div in WellDetailSheet so the entire header area is swipeable.
  </action>
  <verify>
1. `npx tsc -b --noEmit` passes with no errors
2. `npm run dev` -- navigate to a well detail page, header shows farm name, well name, serial/WMIS/last-updated, and status indicator chips
3. Back button navigates to `/`
4. Edit button navigates to `/wells/:id/edit`
  </verify>
  <done>
- WellDetailHeader renders farm name, well name, serial number, WMIS number, and formatted "Last Updated" date
- Status indicators show Pump, Battery, and Meter state with appropriate icon and color (Ok=green check, Low=yellow warning, Critical/Dead=red X, Unknown=gray question)
- Back arrow button in top-left triggers onClose
- Edit pencil button in top-right triggers onEdit
- Both components are wrapped in React.memo
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` -- zero type errors
2. Navigate from map to `/wells/:id` by tapping a well marker -- sheet slides up with animation
3. Sheet covers ~90% of viewport with dark scrim behind it
4. Header shows: farm name, well name, serial/WMIS/last-updated, pump/battery/meter status chips
5. Back button returns to map (navigates to `/`)
6. Edit button navigates to `/wells/:id/edit`
7. Swipe down on header dismisses the sheet
8. Swipe left/right on header cycles between wells (ordered by proximity) with brief cross-fade
9. Sheet does NOT dismiss when tapping the dark overlay
</verification>

<success_criteria>
- Well detail sheet is reachable from the map via well marker tap
- Sheet displays all well metadata and status in the pinned header
- All navigation mechanics work: back button, edit button, swipe dismiss, swipe between wells
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-well-detail-page/13-01-SUMMARY.md`
</output>
