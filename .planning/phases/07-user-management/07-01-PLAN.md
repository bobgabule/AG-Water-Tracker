---
phase: 07-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/029_disable_farm_member.sql
  - src/lib/powersync-schema.ts
  - src/lib/permissions.ts
  - src/components/AppLayout.tsx
autonomous: true

must_haves:
  truths:
    - "farm_members table has is_disabled INTEGER column (0=active, 1=disabled)"
    - "disable_farm_member and enable_farm_member RPCs exist and enforce role hierarchy"
    - "PowerSync schema includes is_disabled column on farm_members"
    - "A disabled user is signed out with a message on next app load"
    - "ROLE_BADGE_STYLES map exists in permissions.ts for colored role badges"
  artifacts:
    - path: "supabase/migrations/029_disable_farm_member.sql"
      provides: "is_disabled column + disable/enable RPCs"
      contains: "disable_farm_member"
    - path: "src/lib/powersync-schema.ts"
      provides: "is_disabled in PowerSync farm_members schema"
      contains: "is_disabled"
    - path: "src/lib/permissions.ts"
      provides: "ROLE_BADGE_STYLES export"
      contains: "ROLE_BADGE_STYLES"
    - path: "src/components/AppLayout.tsx"
      provides: "Disabled user session guard"
      contains: "is_disabled"
  key_links:
    - from: "supabase/migrations/029_disable_farm_member.sql"
      to: "public.farm_members"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "is_disabled"
    - from: "src/components/AppLayout.tsx"
      to: "farm_members.is_disabled"
      via: "PowerSync useQuery"
      pattern: "is_disabled.*=.*1"
---

<objective>
Add the disable/enable infrastructure for farm members and guard disabled user sessions.

Purpose: This plan lays the database foundation (is_disabled column + RPCs), updates the PowerSync schema to sync the new column, adds the ROLE_BADGE_STYLES constant for plan 02's UI, and implements the client-side disabled-user session guard so that disabled users are signed out on next app load.

Output: Migration 029, updated powersync-schema.ts, updated permissions.ts with badge styles, updated AppLayout.tsx with disabled-user guard.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-user-management/07-RESEARCH.md

@supabase/migrations/027_remove_farm_member.sql
@src/lib/powersync-schema.ts
@src/lib/permissions.ts
@src/components/AppLayout.tsx
@src/lib/AuthProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for is_disabled column and disable/enable RPCs</name>
  <files>supabase/migrations/029_disable_farm_member.sql</files>
  <action>
Create migration `029_disable_farm_member.sql` following the exact pattern from migration 027 (private impl + public SECURITY DEFINER wrapper + GRANT + NOTIFY).

**1. Add is_disabled column:**
```sql
ALTER TABLE public.farm_members ADD COLUMN IF NOT EXISTS is_disabled INTEGER NOT NULL DEFAULT 0;
```
Use INTEGER (not BOOLEAN) because PowerSync doesn't support BOOLEAN.

**2. Create `private.disable_farm_member_impl(p_farm_id UUID, p_member_user_id UUID)`:**
- SECURITY DEFINER, SET search_path = ''
- Verify caller is authenticated (auth.uid())
- Cannot disable yourself (v_caller_id = p_member_user_id raises exception)
- Get caller's role from public.farm_members
- Only super_admin, grower, admin can disable (same hierarchy as remove_farm_member_impl in migration 027)
- Get target's role, enforce hierarchy:
  - super_admin can disable anyone except themselves
  - grower can disable admin and meter_checker (not super_admin, not grower)
  - admin can only disable meter_checker
- UPDATE public.farm_members SET is_disabled = 1 WHERE farm_id = p_farm_id AND user_id = p_member_user_id
- Cannot disable already-disabled user: check current is_disabled first, raise 'User is already disabled'

**3. Create `public.disable_farm_member(p_farm_id UUID, p_member_user_id UUID)`:**
- SECURITY DEFINER wrapper (NOT INVOKER -- critical lesson from 06-02)
- SET search_path = ''
- Delegates to private.disable_farm_member_impl

**4. Create `private.enable_farm_member_impl(p_farm_id UUID, p_member_user_id UUID)`:**
- Same auth and hierarchy checks as disable (only those who can disable can re-enable)
- UPDATE public.farm_members SET is_disabled = 0 WHERE farm_id = p_farm_id AND user_id = p_member_user_id
- Cannot enable already-active user: check current is_disabled first, raise 'User is not disabled'

**5. Create `public.enable_farm_member(p_farm_id UUID, p_member_user_id UUID)`:**
- SECURITY DEFINER wrapper, delegates to private.enable_farm_member_impl

**6. GRANT EXECUTE on both public functions to authenticated, anon, public**
**7. NOTIFY pgrst, 'reload schema'**

Add COMMENT ON FUNCTION for both public wrappers describing their purpose.
  </action>
  <verify>
Run `npx tsc -b --noEmit` to confirm no TypeScript compilation issues (migration is SQL-only, but ensures nothing else broke).
Verify the migration file exists and contains both disable_farm_member and enable_farm_member functions.
  </verify>
  <done>Migration 029 exists with: ALTER TABLE for is_disabled column, private impl + public wrapper for both disable and enable RPCs, GRANT + NOTIFY at the end. All functions use SECURITY DEFINER and SET search_path = '' with fully qualified table references.</done>
</task>

<task type="auto">
  <name>Task 2: Update PowerSync schema, add ROLE_BADGE_STYLES, and add disabled-user session guard</name>
  <files>
    src/lib/powersync-schema.ts
    src/lib/permissions.ts
    src/components/AppLayout.tsx
  </files>
  <action>
**A. PowerSync schema (powersync-schema.ts):**

Add `is_disabled` column to the `farm_members` table definition:
```typescript
const farm_members = new TableV2({
  farm_id: column.text,
  user_id: column.text,
  role: column.text,
  full_name: column.text,
  is_disabled: column.integer, // 0 = active, 1 = disabled
  created_at: column.text,
});
```

**B. Role badge styles (permissions.ts):**

Add a `ROLE_BADGE_STYLES` export after `ROLE_DISPLAY_NAMES`:
```typescript
export const ROLE_BADGE_STYLES: Record<Role, string> = {
  super_admin: 'bg-purple-100 text-purple-700',
  grower: 'bg-green-100 text-green-700',
  admin: 'bg-yellow-100 text-yellow-700',
  meter_checker: 'bg-blue-100 text-blue-700',
};
```
These are Tailwind classes for light-background colored pills that match the green-themed UsersPage (the SettingsPage has its own dark-theme badge styling already).

**C. Disabled-user session guard (AppLayout.tsx):**

In `AppLayoutContent`, add a check for whether the current user is disabled. Import `useQuery` from `@powersync/react`, `useAuth` is already imported.

After the existing `useRoleChangeDetector()` call, add:

```typescript
const { user } = useAuth();
// Check if current user is disabled in any of their farm memberships
const { data: disabledCheck } = useQuery<{ is_disabled: number }>(
  user?.id
    ? 'SELECT is_disabled FROM farm_members WHERE user_id = ? AND is_disabled = 1 LIMIT 1'
    : 'SELECT NULL WHERE 0',
  user?.id ? [user.id] : []
);
```

Note: `useAuth()` is already called in `AppLayoutContent` (line 22 of current code via `onboardingStatus`). Destructure `user` and `signOut` from the existing call.

Add a `useEffect` that checks if `disabledCheck` has any rows:
```typescript
useEffect(() => {
  if (disabledCheck && disabledCheck.length > 0) {
    // User is disabled -- sign them out with a message
    alert('Your account has been disabled. Please contact your farm administrator.');
    signOut();
  }
}, [disabledCheck, signOut]);
```

Use `alert()` for simplicity -- this is an edge case that happens rarely (only when a currently-logged-in user gets disabled). A toast or custom UI would be over-engineering for this scenario. The `signOut()` function from `useAuth()` handles navigation to /auth.

Important: Destructure `signOut` from the existing `useAuth()` call, don't add a second `useAuth()` call. The current code has `const { onboardingStatus } = useAuth();` -- change to `const { user, onboardingStatus, signOut } = useAuth();`.
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- must pass with zero errors.
Verify `is_disabled` appears in powersync-schema.ts farm_members definition.
Verify `ROLE_BADGE_STYLES` is exported from permissions.ts.
Verify AppLayout.tsx imports useQuery and contains the disabled-user check.
  </verify>
  <done>PowerSync schema has is_disabled on farm_members. permissions.ts exports ROLE_BADGE_STYLES with per-role Tailwind classes. AppLayout.tsx checks is_disabled on every sync and signs out disabled users with a message.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes
2. Migration 029 file exists with correct structure (private + public + GRANT + NOTIFY)
3. PowerSync schema includes `is_disabled: column.integer` on farm_members
4. `ROLE_BADGE_STYLES` exported from permissions.ts
5. AppLayout.tsx queries farm_members for is_disabled and triggers signOut if found
6. All functions in migration use SECURITY DEFINER (not INVOKER) and SET search_path = ''
</verification>

<success_criteria>
- Database layer ready: is_disabled column exists, disable/enable RPCs enforce role hierarchy
- Sync layer ready: PowerSync schema includes is_disabled, will sync when dashboard rules are updated
- Client guard ready: disabled users are signed out on next app load
- UI support ready: ROLE_BADGE_STYLES available for plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-management/07-01-SUMMARY.md`
</output>
