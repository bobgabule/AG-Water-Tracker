---
phase: 07-user-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/pages/UsersPage.tsx
  - src/components/ConfirmDisableMemberDialog.tsx
autonomous: true

must_haves:
  truths:
    - "Each farm member in the list displays a colored role badge (Admin, Meter Checker, etc.)"
    - "A 'Show disabled users' toggle exists and reveals disabled accounts when enabled"
    - "Disabled users are visually distinct from active users (opacity, strikethrough, '(Disabled)' label)"
    - "Grower/admin can disable an active user via the member list"
    - "Grower/admin can re-enable a disabled user via the member list"
    - "User can edit their own first name, last name, and email in the Settings page (already works)"
  artifacts:
    - path: "src/pages/UsersPage.tsx"
      provides: "Member list with role badges, disable toggle, disable/enable actions"
      contains: "ROLE_BADGE_STYLES"
    - path: "src/components/ConfirmDisableMemberDialog.tsx"
      provides: "Confirmation dialog for disable action"
      contains: "ConfirmDisableMemberDialog"
  key_links:
    - from: "src/pages/UsersPage.tsx"
      to: "supabase.rpc('disable_farm_member')"
      via: "handleDisable callback"
      pattern: "disable_farm_member"
    - from: "src/pages/UsersPage.tsx"
      to: "supabase.rpc('enable_farm_member')"
      via: "handleEnable callback"
      pattern: "enable_farm_member"
    - from: "src/pages/UsersPage.tsx"
      to: "src/lib/permissions.ts"
      via: "import ROLE_BADGE_STYLES"
      pattern: "ROLE_BADGE_STYLES"
---

<objective>
Overhaul the UsersPage UI to add colored role badges, a "Show disabled users" toggle, and disable/enable member actions.

Purpose: This delivers the user-facing experience for USER-01 (role badges), USER-02 (disabled toggle), USER-06 (disable), and USER-07 (re-enable). USER-08 (profile edit) is already complete in SettingsPage from prior phases.

Output: Updated UsersPage.tsx with full member management, new ConfirmDisableMemberDialog.tsx.
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-user-management/07-RESEARCH.md
@.planning/phases/07-user-management/07-01-SUMMARY.md

@src/pages/UsersPage.tsx
@src/components/ConfirmDeleteMemberDialog.tsx
@src/lib/permissions.ts
@src/pages/SettingsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfirmDisableMemberDialog component</name>
  <files>src/components/ConfirmDisableMemberDialog.tsx</files>
  <action>
Create `ConfirmDisableMemberDialog.tsx` following the exact pattern of `ConfirmDeleteMemberDialog.tsx` (Dialog, DialogBackdrop, DialogPanel, DialogTitle from @headlessui/react with `data-[closed]:` transition attributes).

**Props interface:**
```typescript
interface ConfirmDisableMemberDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: () => void;
  memberName: string;
  loading: boolean;
}
```

**Differences from delete dialog:**
- Title: "Disable User" (not "Remove User")
- Icon: Use `NoSymbolIcon` from `@heroicons/react/24/outline` (circle with slash) instead of ExclamationTriangleIcon
- Icon background: `bg-orange-500/20`, icon color: `text-orange-400` (orange, not red -- disable is less destructive than delete)
- Body text: `Disable <memberName> from your farm? They will not be able to log in, but their data will be preserved. You can re-enable them later.`
- Confirm button: "Disable" text, `bg-orange-600 hover:bg-orange-700` colors (orange instead of red)
- Loading text: "Disabling..."

Keep same Dialog/DialogPanel structure, same transition classes, same Cancel button styling.
  </action>
  <verify>Run `npx tsc -b --noEmit` -- must pass.</verify>
  <done>ConfirmDisableMemberDialog.tsx exists with orange-themed disable confirmation following Headless UI v2 Dialog pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Overhaul UsersPage with role badges, disabled toggle, and disable/enable actions</name>
  <files>src/pages/UsersPage.tsx</files>
  <action>
Update `UsersPage.tsx` with the following changes. The file is ~208 lines currently -- aim to keep it under 300 lines.

**A. Update imports:**
- Add `import { Switch } from '@headlessui/react';` (Headless UI v2 toggle)
- Add `import { NoSymbolIcon } from '@heroicons/react/24/outline';` (for disable button icon)
- Add `import ConfirmDisableMemberDialog from '../components/ConfirmDisableMemberDialog';`
- Update permissions import: `import { hasPermission, ROLE_DISPLAY_NAMES, ROLE_BADGE_STYLES } from '../lib/permissions';`

**B. Update FarmMemberRow interface:**
Add `is_disabled: number;` field (0 or 1, INTEGER from PowerSync).

**C. Update the PowerSync query to include is_disabled:**
```typescript
const { data: rawMembers } = useQuery<FarmMemberRow>(
  farmId
    ? 'SELECT id, user_id, role, full_name, is_disabled, created_at FROM farm_members WHERE farm_id = ? ORDER BY created_at ASC'
    : 'SELECT NULL WHERE 0',
  farmId ? [farmId] : []
);
```
This query returns ALL members (including disabled). Filtering happens client-side.

**D. Add toggle state and filtered members:**
```typescript
const [showDisabled, setShowDisabled] = useState(false);

const members = useMemo(() => {
  const all = rawMembers ?? [];
  if (showDisabled) return all;
  return all.filter(m => !m.is_disabled);
}, [rawMembers, showDisabled]);
```

**E. Add disable/enable state and handlers:**
```typescript
const [disableTarget, setDisableTarget] = useState<FarmMemberRow | null>(null);
const [disableLoading, setDisableLoading] = useState(false);
const [actionError, setActionError] = useState<string | null>(null);
```

**handleDisableClick:**
```typescript
const handleDisableClick = useCallback((member: FarmMemberRow) => {
  setActionError(null);
  setDisableTarget(member);
}, []);
```

**handleDisableClose:**
```typescript
const handleDisableClose = useCallback(() => {
  setDisableTarget(null);
  setActionError(null);
}, []);
```

**handleDisableConfirm:**
Follow the exact pattern of handleDeleteConfirm. Call `supabase.rpc('disable_farm_member', { p_farm_id: farmId, p_member_user_id: disableTarget.user_id })`. Error handling:
- 'cannot disable yourself' -> 'You cannot disable yourself'
- 'not a member' -> 'This user is no longer a member'
- 'already disabled' -> 'This user is already disabled'
- default: use error message as-is

**handleEnable:**
Direct action (no confirmation dialog needed for re-enabling). Call `supabase.rpc('enable_farm_member', { p_farm_id: farmId, p_member_user_id: member.user_id })`. Set `actionError` on failure. This handler should accept a member directly:
```typescript
const handleEnable = useCallback(async (member: FarmMemberRow) => {
  if (!farmId) return;
  try {
    setDisableLoading(true);
    setActionError(null);
    const { error } = await supabase.rpc('enable_farm_member', {
      p_farm_id: farmId,
      p_member_user_id: member.user_id,
    });
    if (error) throw error;
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Failed to enable member';
    debugError('UsersPage', 'Failed to enable member:', err);
    setActionError(message);
  } finally {
    setDisableLoading(false);
  }
}, [farmId]);
```

**canDisableMember:** Same hierarchy logic as canDeleteMember (super_admin can disable anyone except self, grower can disable admin/meter_checker, admin can disable meter_checker only). Also cannot disable someone who is already disabled.

**F. Add "Show disabled users" toggle to the UI:**
Place between the USERS title and the members list:
```tsx
{canManageUsers && (
  <div className="flex items-center justify-between mb-4">
    <span className="text-sm text-[#5f7248]/70">Show disabled users</span>
    <Switch
      checked={showDisabled}
      onChange={setShowDisabled}
      className="group inline-flex h-6 w-11 items-center rounded-full bg-gray-300 transition data-[checked]:bg-[#5f7248]"
    >
      <span className="size-4 translate-x-1 rounded-full bg-white transition group-data-[checked]:translate-x-6" />
    </Switch>
  </div>
)}
```

**G. Update member row rendering with role badges and disable visual:**
Replace the current plain-text role display with a colored badge pill:
```tsx
<span className={`text-xs font-medium px-2 py-0.5 rounded-full ${ROLE_BADGE_STYLES[member.role as Role] ?? 'bg-gray-100 text-gray-700'}`}>
  {ROLE_DISPLAY_NAMES[member.role as Role] ?? member.role}
</span>
```

For disabled members, add visual indicators:
- The member row div gets conditional classes: `${member.is_disabled ? 'bg-gray-200 opacity-60' : 'bg-[#dfe4d4]'}`
- The member name gets: `${member.is_disabled ? 'text-gray-500 line-through' : 'text-[#5f7248]'}`
- After the name, if disabled: `{member.is_disabled === 1 && <span className="text-xs ml-2 text-red-500 font-normal no-underline">(Disabled)</span>}`

**H. Update action buttons per member:**
For each member row, the action area should show:
1. If member is disabled AND user can disable/enable them: Show an "Enable" button (green text, small)
2. If member is active AND canDisableMember: Show a disable icon button (NoSymbolIcon, orange on hover)
3. If canDeleteMember (keep existing): Show trash icon button

Layout the buttons in a flex row with gap-1:
```tsx
<div className="flex items-center gap-1 flex-shrink-0">
  {/* Role badge */}
  <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${ROLE_BADGE_STYLES[member.role as Role] ?? 'bg-gray-100 text-gray-700'}`}>
    {ROLE_DISPLAY_NAMES[member.role as Role] ?? member.role}
  </span>

  {/* Enable button (only for disabled members) */}
  {member.is_disabled === 1 && canDisableMember(member) && (
    <button
      onClick={() => handleEnable(member)}
      disabled={disableLoading}
      className="px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded hover:bg-green-200 transition-colors disabled:opacity-50"
    >
      Enable
    </button>
  )}

  {/* Disable button (only for active members) */}
  {!member.is_disabled && canDisableMember(member) && (
    <button
      onClick={() => handleDisableClick(member)}
      className="p-1 rounded text-[#5f7248]/40 hover:text-orange-600 transition-colors"
      aria-label={`Disable ${member.full_name}`}
    >
      <NoSymbolIcon className="h-4 w-4" />
    </button>
  )}

  {/* Delete button (keep existing, only for active members) */}
  {!member.is_disabled && canDeleteMember(member) && (
    <button
      onClick={() => handleDeleteClick(member)}
      className="p-1 rounded text-[#5f7248]/40 hover:text-red-600 transition-colors"
      aria-label={`Remove ${member.full_name}`}
    >
      <TrashIcon className="h-4 w-4" />
    </button>
  )}
</div>
```

**I. Add error banner for action errors:**
Above the members list (alongside or replacing the existing deleteError banner), show `actionError` if set:
```tsx
{actionError && (
  <div className="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
    <p className="text-red-700 text-sm">{actionError}</p>
  </div>
)}
```
Keep the existing deleteError banner for the delete flow.

**J. Add ConfirmDisableMemberDialog at the bottom:**
```tsx
<ConfirmDisableMemberDialog
  open={disableTarget !== null}
  onClose={handleDisableClose}
  onConfirm={handleDisableConfirm}
  memberName={disableTarget?.full_name ?? 'this member'}
  loading={disableLoading}
/>
```

**Important notes:**
- Wrap handleEnable, handleDisableConfirm, canDisableMember with `useCallback` for performance
- The `canDisableMember` function should return false for the `canDisableMember(member)` check when `member.is_disabled` (for disable button), but canDisableMember itself checks the role hierarchy only -- the disabled check is done in the JSX conditional (`!member.is_disabled && canDisableMember(member)` for disable, `member.is_disabled === 1 && canDisableMember(member)` for enable)
- Keep the existing delete functionality unchanged
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- must pass with zero errors.
Verify UsersPage.tsx imports Switch from @headlessui/react.
Verify UsersPage.tsx imports ROLE_BADGE_STYLES from permissions.ts.
Verify UsersPage.tsx contains both 'disable_farm_member' and 'enable_farm_member' RPC calls.
Verify ConfirmDisableMemberDialog.tsx is imported and rendered.
  </verify>
  <done>UsersPage shows colored role badges for each member. "Show disabled users" toggle filters the list. Disabled members have visual indicators (opacity, strikethrough, "(Disabled)" label). Grower/admin can disable active members (orange confirmation dialog) and re-enable disabled members (direct green button). Delete functionality remains intact.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with zero errors
2. Role badges appear as colored pills (not plain text) in the member list
3. "Show disabled users" toggle exists when user has manage_users permission
4. Disabled members show visual distinction (opacity, strikethrough, "(Disabled)" text)
5. Disable action calls `supabase.rpc('disable_farm_member')` with confirmation dialog
6. Enable action calls `supabase.rpc('enable_farm_member')` directly
7. Delete action still works unchanged
8. SettingsPage profile edit form still works (USER-08 -- no changes needed)
</verification>

<success_criteria>
- USER-01: Member list shows name + colored role badge for each farm member
- USER-02: Toggle reveals disabled accounts with visual distinction
- USER-06: Disable action available with confirmation dialog, calls RPC
- USER-07: Enable action available as direct button, calls RPC
- USER-08: Profile self-edit unchanged and working in SettingsPage
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-management/07-02-SUMMARY.md`
</output>
