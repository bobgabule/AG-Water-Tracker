---
phase: 03-role-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/021_four_role_system.sql
autonomous: true

must_haves:
  truths:
    - "farm_members.role CHECK constraint accepts only super_admin, grower, admin, meter_checker and rejects any other value"
    - "farm_invites.role CHECK constraint accepts only admin and meter_checker and rejects any other value"
    - "Existing data is preserved: owner rows become grower, member rows become meter_checker, admin rows stay admin"
    - "get_user_admin_farm_ids() returns farm_ids where role is super_admin, grower, or admin"
    - "create_farm_and_membership_impl() inserts role as grower (not owner)"
    - "create_invite_code_impl() validates role against admin and meter_checker (not admin and member)"
    - "invite_user_by_phone_impl() validates role against admin and meter_checker (not admin and member)"
    - "revoke_farm_invite_impl() checks role against super_admin, grower, admin (not owner, admin)"
  artifacts:
    - path: "supabase/migrations/021_four_role_system.sql"
      provides: "Role rename migration with constraint updates and function updates"
      contains: "CHECK (role IN ('super_admin', 'grower', 'admin', 'meter_checker'))"
  key_links:
    - from: "get_user_admin_farm_ids()"
      to: "RLS policies"
      via: "Helper function used by all admin-gated RLS policies"
      pattern: "role IN \\('super_admin', 'grower', 'admin'\\)"
    - from: "create_farm_and_membership_impl()"
      to: "farm_members"
      via: "INSERT with role = 'grower'"
      pattern: "'grower'"
---

<objective>
Migrate the database from the old 3-role system (owner/admin/member) to the new 4-role system (super_admin/grower/admin/meter_checker) in a single atomic migration.

Purpose: The database is the enforcement layer. CHECK constraints make it impossible to store invalid roles. Updating helper functions propagates role changes to all RLS policies automatically (since policies use these functions, not hardcoded role names).
Output: `supabase/migrations/021_four_role_system.sql`
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-role-foundation/03-RESEARCH.md

Key references:
- `supabase/migrations/020_security_definer_private_schema.sql` — Current private function implementations to update
- `supabase/migrations/011_new_rls_policies.sql` — Current helper functions (get_user_admin_farm_ids, get_user_farm_ids)
- `supabase/migrations/007_farm_members.sql` — Original farm_members CHECK constraint
- `supabase/migrations/008_farm_invites.sql` — Original farm_invites CHECK constraint
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create role system migration</name>
  <files>supabase/migrations/021_four_role_system.sql</files>
  <action>
Create `supabase/migrations/021_four_role_system.sql` with all changes in a single migration file. The migration must be wrapped in a transaction (PostgreSQL migrations are transactional by default with Supabase).

**Section 1: Update existing data (BEFORE constraint changes)**

```sql
-- Map old roles to new roles in farm_members
UPDATE farm_members SET role = 'grower' WHERE role = 'owner';
UPDATE farm_members SET role = 'meter_checker' WHERE role = 'member';
-- 'admin' stays 'admin', no update needed

-- Map old roles to new roles in farm_invites
UPDATE farm_invites SET role = 'meter_checker' WHERE role = 'member';
-- 'admin' stays 'admin', no update needed
```

**Section 2: Update CHECK constraints**

```sql
-- farm_members: drop old, add new with 4 roles
ALTER TABLE farm_members DROP CONSTRAINT IF EXISTS farm_members_role_check;
ALTER TABLE farm_members ADD CONSTRAINT farm_members_role_check
  CHECK (role IN ('super_admin', 'grower', 'admin', 'meter_checker'));

-- farm_invites: drop old, add new (only invitable roles)
ALTER TABLE farm_invites DROP CONSTRAINT IF EXISTS farm_invites_role_check;
ALTER TABLE farm_invites ADD CONSTRAINT farm_invites_role_check
  CHECK (role IN ('admin', 'meter_checker'));
```

**Section 3: Update get_user_admin_farm_ids() helper function**

This is defined in public schema (from migration 011). Update it with `CREATE OR REPLACE`:
- Change `role IN ('owner', 'admin')` to `role IN ('super_admin', 'grower', 'admin')`
- Keep SECURITY DEFINER, STABLE, SET search_path = public (matching current definition)

Note: `get_user_farm_ids()` does NOT need changes (it returns all farms regardless of role).

**Section 4: Update private schema functions**

All of these use `CREATE OR REPLACE` on the private schema functions from migration 020:

4a. `private.create_farm_and_membership_impl()`:
- Line `VALUES (v_farm_id, v_user_id, 'owner')` -> change `'owner'` to `'grower'`
- Everything else stays identical

4b. `private.create_invite_code_impl()`:
- Line `IF p_role NOT IN ('admin', 'member')` -> change to `IF p_role NOT IN ('admin', 'meter_checker')`
- Line `RAISE EXCEPTION 'Invalid role. Must be ''admin'' or ''member'''` -> change to `'Invalid role. Must be ''admin'' or ''meter_checker'''`
- Line `IF v_user_role NOT IN ('owner', 'admin')` -> change to `IF v_user_role NOT IN ('super_admin', 'grower', 'admin')`
- Line `RAISE EXCEPTION 'Only owners and admins can create invite codes'` -> change to `'Only growers and admins can create invite codes'`
- Everything else stays identical

4c. `private.invite_user_by_phone_impl()`:
- Line `IF p_role NOT IN ('admin', 'member')` -> change to `IF p_role NOT IN ('admin', 'meter_checker')`
- Line `RAISE EXCEPTION 'Invalid role. Must be ''admin'' or ''member'''` -> change to `'Invalid role. Must be ''admin'' or ''meter_checker'''`
- Line `IF v_user_role NOT IN ('owner', 'admin')` -> change to `IF v_user_role NOT IN ('super_admin', 'grower', 'admin')`
- Line `RAISE EXCEPTION 'Only owners and admins can invite users'` -> change to `'Only growers and admins can invite users'`
- Everything else stays identical

4d. `private.revoke_farm_invite_impl()`:
- Line `IF v_user_role IS NULL OR v_user_role NOT IN ('owner', 'admin')` -> change to `IF v_user_role IS NULL OR v_user_role NOT IN ('super_admin', 'grower', 'admin')`
- Line `RAISE EXCEPTION 'Only owners and admins can revoke invites'` -> change to `'Only growers and admins can revoke invites'`
- Everything else stays identical

**CRITICAL:** Copy the FULL function bodies from migration 020 when doing CREATE OR REPLACE. Do NOT write abbreviated versions. Every line of the original function must be preserved except the specific role string changes listed above. Keep `SET search_path = ''` and SECURITY DEFINER on all private functions.

**Section 5: Update public wrapper function comments** (optional but nice)

Update COMMENT ON the public wrappers to reflect new terminology:
- `create_farm_and_membership`: "...adds the calling user as grower"
- `create_invite_code`: "...grower/admin only"
- `invite_user_by_phone`: "...grower/admin only"
- `revoke_farm_invite`: "...grower/admin only"

Add a header comment block explaining the migration purpose and the role mapping (owner->grower, member->meter_checker).
  </action>
  <verify>
1. Read the migration file and verify all role references have been updated
2. Verify no old role names ('owner' or 'member') appear anywhere in the migration EXCEPT in the UPDATE statements that map old to new
3. Run `npx tsc -b --noEmit` (should still pass since this is a SQL-only change)
  </verify>
  <done>
Migration 021 exists with: data updates (owner->grower, member->meter_checker), constraint updates, helper function updates, and private function updates. All role references use the new 4-role names. File is ready to be applied to Supabase.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "'owner'" supabase/migrations/021_four_role_system.sql` returns only occurrences in UPDATE WHERE clauses (old->new mapping) and comment blocks
2. `grep "'member'" supabase/migrations/021_four_role_system.sql` returns only occurrences in UPDATE WHERE clauses
3. Constraint: `CHECK (role IN ('super_admin', 'grower', 'admin', 'meter_checker'))` appears for farm_members
4. Constraint: `CHECK (role IN ('admin', 'meter_checker'))` appears for farm_invites
5. get_user_admin_farm_ids uses `IN ('super_admin', 'grower', 'admin')`
6. create_farm_and_membership_impl uses `'grower'` for INSERT
7. All four private functions are fully reproduced (not abbreviated)
</verification>

<success_criteria>
- Single migration file covers all database role changes
- Old roles mapped to new before constraints are updated (avoids violation)
- Helper functions updated so RLS policies automatically use new roles
- Private functions updated with correct role validation
- No old role names in active code (only in migration UPDATE WHERE clauses)
</success_criteria>

<output>
After completion, create `.planning/phases/03-role-foundation/03-02-SUMMARY.md`
</output>
