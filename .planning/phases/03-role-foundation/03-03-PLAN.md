---
phase: 03-role-foundation
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/pages/SettingsPage.tsx
  - src/components/AddUserModal.tsx
  - docs/powersync-sync-rules.yaml
autonomous: true

must_haves:
  truths:
    - "SettingsPage uses isAdminOrAbove() from permissions module instead of hardcoded role === 'owner' || role === 'admin'"
    - "SettingsPage displays role using ROLE_DISPLAY_NAMES instead of raw database strings"
    - "AddUserModal role type uses 'meter_checker' | 'admin' instead of 'member' | 'admin'"
    - "AddUserModal displays 'Meter Checker' label instead of 'Member' for the role toggle"
    - "PowerSync sync rules documentation reflects grower role instead of owner"
  artifacts:
    - path: "src/pages/SettingsPage.tsx"
      provides: "Settings page with permission-based team management visibility"
      contains: "isAdminOrAbove"
    - path: "src/components/AddUserModal.tsx"
      provides: "Add user modal with meter_checker role option"
      contains: "meter_checker"
    - path: "docs/powersync-sync-rules.yaml"
      provides: "Updated sync rules documentation for new role names"
      contains: "role = 'grower'"
  key_links:
    - from: "src/pages/SettingsPage.tsx"
      to: "src/lib/permissions.ts"
      via: "imports isAdminOrAbove and ROLE_DISPLAY_NAMES"
      pattern: "import.*isAdminOrAbove.*from.*permissions"
    - from: "src/pages/SettingsPage.tsx"
      to: "src/hooks/useUserRole.ts"
      via: "uses useUserRole hook for role lookup"
      pattern: "useUserRole"
---

<objective>
Update all client code that references old role names to use the new permission system, and update the PowerSync sync rules documentation.

Purpose: After Plans 01 (permission module) and 02 (database migration), client code still references old role strings. This plan wires everything together so the client matches the database.
Output: Updated SettingsPage.tsx, AddUserModal.tsx, and powersync-sync-rules.yaml
</objective>

<execution_context>
@C:/Users/Bobits/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Bobits/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-role-foundation/03-RESEARCH.md
@.planning/phases/03-role-foundation/03-01-SUMMARY.md
@.planning/phases/03-role-foundation/03-02-SUMMARY.md

Key references:
- `src/pages/SettingsPage.tsx` — Has `role === 'owner' || role === 'admin'` check and raw role display
- `src/components/AddUserModal.tsx` — Has `type Role = 'member' | 'admin'` and "Member"/"Admin" labels
- `docs/powersync-sync-rules.yaml` — References `role = 'owner'` in farm_invites buckets
- `src/lib/permissions.ts` — (from Plan 01) Permission matrix, isAdminOrAbove, ROLE_DISPLAY_NAMES
- `src/hooks/useUserRole.ts` — (from Plan 01) useUserRole hook
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SettingsPage to use permission module</name>
  <files>src/pages/SettingsPage.tsx</files>
  <action>
Update `src/pages/SettingsPage.tsx` to use the new permission system:

1. **Replace the role query with useUserRole hook:**
   - Remove the `FarmMembership` interface
   - Remove the `useQuery<FarmMembership>` call that manually queries farm_members
   - Remove the `isAdminOrOwner` useMemo block
   - Add import: `import { useUserRole } from '../hooks/useUserRole';`
   - Add import: `import { isAdminOrAbove, ROLE_DISPLAY_NAMES } from '../lib/permissions';`
   - Add import: `import type { Role } from '../lib/permissions';`
   - Call `const userRole = useUserRole();`
   - Derive `const canManageTeam = isAdminOrAbove(userRole);`

2. **Update Team Management section visibility:**
   - Change `{isAdminOrOwner && (` to `{canManageTeam && (`

3. **Update Role display in Account section:**
   - Replace the raw `membershipData[0].role` display with `ROLE_DISPLAY_NAMES[userRole as Role]` (guarded by userRole being non-null)
   - Update the role badge color logic to use new role names:
     - `super_admin` -> purple (bg-purple-500/20 text-purple-400)
     - `grower` -> green (bg-green-500/20 text-green-400)
     - `admin` -> yellow (bg-yellow-500/20 text-yellow-400)
     - `meter_checker` -> blue (bg-blue-500/20 text-blue-400)
   - Guard with `{userRole && (` instead of `{membershipData?.[0]?.role && (`

4. **Remove unused references:**
   - Remove `membershipData` variable since we no longer query it directly
   - Remove `useQuery` import from `@powersync/react` (only if nothing else in the file uses it)
   - Remove `useMemo` import only if nothing else in the file uses it
  </action>
  <verify>Run `npx tsc -b --noEmit` -- no type errors. Verify no occurrences of 'owner' or 'membershipData' remain in SettingsPage.tsx.</verify>
  <done>SettingsPage uses useUserRole + isAdminOrAbove for team management visibility, and ROLE_DISPLAY_NAMES for role badge display. No hardcoded role strings.</done>
</task>

<task type="auto">
  <name>Task 2: Update AddUserModal role type and PowerSync sync rules</name>
  <files>src/components/AddUserModal.tsx, docs/powersync-sync-rules.yaml</files>
  <action>
**AddUserModal.tsx updates:**

1. Change the local `Role` type from `'member' | 'admin'` to `'meter_checker' | 'admin'`.

2. Update the default role state: `useState<Role>('member')` -> `useState<Role>('meter_checker')`.

3. Update the role toggle buttons:
   - The "Member" button: change `onClick={() => handleRoleChange('member')}` to `onClick={() => handleRoleChange('meter_checker')}`
   - Change the condition `role === 'member'` to `role === 'meter_checker'` for active state styling
   - Change the button label from "Member" to "Meter Checker"

4. Update the role description text:
   - Change `role === 'admin'` ternary text: keep admin description as-is
   - Change the else case (meter_checker) description from "Members can view and record meter readings" to "Meter checkers can view wells and record readings"

5. Update the handleClose reset: `setRole('member')` -> `setRole('meter_checker')`.

Note: Do NOT import from permissions.ts here -- this component's local Role type is deliberately limited to invitable roles only (admin, meter_checker). The database CHECK constraint on farm_invites enforces this same set.

**PowerSync sync rules YAML updates (docs/powersync-sync-rules.yaml):**

1. `farm_invites_owner` bucket:
   - Change parameter query `AND role = 'owner'` to `AND role = 'grower'`
   - Update comment: "for Growers" instead of "for Owners"
   - Update the note about invite visibility

2. Add a NEW `farm_invites_super_admin` bucket (copy of farm_invites_owner but with `role = 'super_admin'`):
   ```yaml
   farm_invites_super_admin:
     parameters: |
       SELECT farm_id FROM farm_members
       WHERE user_id = request.user_id()
       AND role = 'super_admin'
     data:
       - SELECT code AS id, farm_id, created_by, role, invited_phone, invited_name, expires_at, max_uses, uses_count, created_at FROM farm_invites WHERE farm_id = bucket.farm_id
   ```

3. Rename `farm_invites_owner` to `farm_invites_grower` (update the bucket name).

4. Update the `farm_invites_admin` bucket comment to reflect new terminology.

5. Update the Implementation Notes at the bottom to reflect the new 3-bucket invite pattern (super_admin, grower, admin).
  </action>
  <verify>
1. Run `npx tsc -b --noEmit` -- no type errors
2. Verify no occurrences of `'member'` remain in AddUserModal.tsx (should only have `'meter_checker'` and `'admin'`)
3. Verify no occurrences of `'owner'` remain in powersync-sync-rules.yaml (should have `'grower'` and `'super_admin'`)
  </verify>
  <done>AddUserModal uses meter_checker/admin roles. Sync rules documentation updated with grower, super_admin, and admin buckets for farm_invites. No old role names in active code.</done>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes with no errors
2. SettingsPage.tsx imports from permissions.ts and useUserRole -- no hardcoded role strings
3. AddUserModal.tsx uses 'meter_checker' and 'admin' -- no 'member' references
4. powersync-sync-rules.yaml uses 'grower' and 'super_admin' -- no 'owner' references
5. Role badge in SettingsPage shows human-readable names (Grower, Admin, etc.) not raw strings
</verification>

<success_criteria>
- All client-side role references updated to new role names
- SettingsPage uses permission module functions instead of inline role checks
- AddUserModal role options match the database constraint (admin, meter_checker)
- PowerSync sync rules documentation ready for dashboard copy-paste
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-role-foundation/03-03-SUMMARY.md`
</output>
